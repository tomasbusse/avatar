{"id":"beethoven-4bd","title":"Clerk Authentication Enhancement - OAuth, Webhooks \u0026 Email Verification","description":"## Summary\n\nEnhance the existing Clerk authentication integration with Google OAuth, improved webhook handling, email verification, and proper user state management. This builds on the working foundation (middleware, providers, basic auth pages, webhooks) to add production-ready features.\n\n## Current State (Already Working)\n\n- Clerk middleware protecting routes\n- ClerkProvider + ConvexProvider integration\n- Basic SignIn/SignUp pages at /sign-in, /sign-up\n- Webhook handler for user.created, user.updated, user.deleted\n- User sync with Convex via webhooks\n- Onboarding flow\n\n## Enhancement Components\n\n### 1. Clerk Dashboard Configuration\n- [ ] Enable email/password authentication with verification required\n- [ ] Configure password requirements (8+ chars, uppercase, number, special char)\n- [ ] Enable Google OAuth provider\n- [ ] Add session.created webhook event\n- [ ] Configure redirect URLs for production\n\n### 2. Google OAuth Setup\n- [ ] Create OAuth credentials in Google Cloud Console\n- [ ] Configure Client ID and Secret in Clerk Dashboard\n- [ ] Enable profile data sync (name, profile image)\n- [ ] Test OAuth flow end-to-end\n\n### 3. Enhanced Webhook Handling\nLocation: /Users/tomas/apps/beethoven/convex/http.ts\n\nUpdates needed:\n- [ ] Extract and store Google OAuth profile data (avatar URL, display name)\n- [ ] Add session.created event handler for login tracking\n- [ ] Update lastLoginAt timestamp on login\n- [ ] Increment loginCount on each session.created\n- [ ] Assign default role (student) with status \"pending\" on user.created\n- [ ] Handle account linking events\n\n### 4. Sign-Up/Sign-In Flow Enhancement\nLocation: /Users/tomas/apps/beethoven/app/(auth)/\n\n- [ ] Update afterSignUpUrl to redirect to /onboarding\n- [ ] Add custom Clerk appearance matching Beethoven brand colors\n- [ ] Ensure email verification completes before granting access\n- [ ] Add loading states during OAuth redirects\n\n### 5. Middleware Enhancement\nLocation: /Users/tomas/apps/beethoven/middleware.ts\n\n- [ ] Redirect to /onboarding if user exists but status === \"pending\"\n- [ ] Create ensureUser mutation to handle race conditions between Clerk auth and Convex webhook\n- [ ] Add retry logic for webhook timing issues\n\n### 6. Account Linking\n- [ ] Configure Clerk to allow linking Google to existing email account\n- [ ] Add UserProfile component to settings page for account management\n- [ ] Handle linked account data merging\n\n### 7. Password Reset Flow\n- [ ] Configure forgot password in Clerk Dashboard\n- [ ] Customize password reset email template with Beethoven branding\n- [ ] Set up redirect URL after reset\n\n### 8. Role Assignment Integration\n- [ ] New users receive \"student\" role by default\n- [ ] User status set to \"pending\" until onboarding complete\n- [ ] After onboarding, status changes to \"active\"\n- [ ] Integrate with RBAC system (beethoven-d20) when available\n\n## Technical Implementation Notes\n\n### Webhook Event Handling Structure\n```typescript\n// session.created handler\ncase \"session.created\":\n  const session = evt.data;\n  await ctx.runMutation(internal.users.trackLogin, {\n    clerkId: session.user_id,\n    loginAt: new Date().toISOString(),\n  });\n  break;\n```\n\n### Middleware Enhancement Pattern\n```typescript\n// Check user status from Convex\nconst user = await getConvexUser(userId);\nif (user?.status === \"pending\" \u0026\u0026 !pathname.startsWith(\"/onboarding\")) {\n  return NextResponse.redirect(new URL(\"/onboarding\", req.url));\n}\n```\n\n### Custom Appearance Example\n```typescript\n// app/(auth)/sign-in/[[...sign-in]]/page.tsx\n\u003cSignIn \n  appearance={{\n    elements: {\n      card: \"bg-white shadow-xl\",\n      headerTitle: \"text-gray-900\",\n      headerSubtitle: \"text-gray-600\",\n      socialButtonsBlockButton: \"border border-gray-200 hover:bg-gray-50\",\n      formButtonPrimary: \"bg-blue-600 hover:bg-blue-700\",\n    }\n  }}\n/\u003e\n```\n\n## Acceptance Criteria\n\n- [ ] Users can sign up with email/password (verification required)\n- [ ] Users can sign up/sign in with Google OAuth\n- [ ] Google profile data (name, avatar) synced to Convex\n- [ ] Login events tracked with lastLoginAt and loginCount\n- [ ] New users have role \"student\" and status \"pending\"\n- [ ] Users redirected to /onboarding if status is \"pending\"\n- [ ] Password reset flow works with branded emails\n- [ ] Account linking works (Google to email)\n- [ ] No race conditions between Clerk and Convex\n\n## Dependencies\n\n- Blocks: beethoven-d20 (RBAC Implementation) - provides role infrastructure\n- Related: User Management SPEC at /Users/tomas/apps/beethoven/specs/user-management/SPEC.md\n\n## Related Files\n\n- /Users/tomas/apps/beethoven/middleware.ts\n- /Users/tomas/apps/beethoven/convex/http.ts\n- /Users/tomas/apps/beethoven/convex/users.ts\n- /Users/tomas/apps/beethoven/app/(auth)/sign-in/[[...sign-in]]/page.tsx\n- /Users/tomas/apps/beethoven/app/(auth)/sign-up/[[...sign-up]]/page.tsx\n- /Users/tomas/apps/beethoven/app/(dashboard)/onboarding/page.tsx\n\n## Out of Scope\n\n- SSO/SAML (Enterprise feature, separate issue)\n- Multi-factor authentication (future enhancement)\n- Magic link authentication\n- Phone number authentication","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-04T18:31:50.742401+01:00","created_by":"tomas","updated_at":"2026-01-04T18:31:50.742401+01:00","labels":["area:auth","area:core","beta-blocker","provider:clerk","type:enhancement"]}
{"id":"beethoven-6pp","title":"Feature: Cambridge English Entry Test Creator with AI","description":"## Summary\n\nCreate an AI-powered Cambridge English placement test system that establishes student English proficiency levels according to CEFR standards (A1-C2). The system uses OpenRouter for LLM access, Cartesia for audio generation, and can be delivered via Beyond Presence avatar for an immersive test experience.\n\n## Problem Statement\n\nCurrently, there is no standardized way to assess incoming students' English proficiency levels. Teachers and admins need a reliable, automated way to:\n- Place new students at the appropriate learning level\n- Generate customized tests for companies or individuals\n- Provide detailed skill breakdowns for personalized learning paths\n- Deliver engaging, avatar-led assessments for a more natural experience\n\n## Feature Components\n\n### 1. Test Generation with AI\n- **OpenRouter Integration**: Access multiple LLMs via OpenRouter API\n- **Model Selector**: Dropdown with full OpenRouter LLM list\n- **Default Model**: Claude Opus 4.5 (claude-opus-4-5-20250101)\n- **Custom Prompt Box**: Detailed instructions for test generation\n- **Personalization**: Generate tests tailored to specific companies or individual students\n\n### 2. Cambridge English Levels (CEFR)\n- A1 (Beginner)\n- A2 (Elementary)\n- B1 (Intermediate)\n- B2 (Upper-Intermediate)\n- C1 (Advanced)\n- C2 (Proficiency)\n\n### 3. Question Types\n- **Reading Comprehension**: Passages with multiple choice questions\n- **Grammar**: Fill-in-the-blank, error correction, sentence transformation\n- **Vocabulary**: Word matching, synonyms/antonyms, context usage\n- **Listening/Audio**: Audio questions using Cartesia TTS\n- **Writing**: Short essay prompts, email writing\n- **Speaking Prompts**: Topics for verbal assessment (avatar sessions)\n\n### 4. Audio Integration (Cartesia)\n- Generate audio for listening comprehension questions\n- Text-to-speech for instructions and passages\n- Multiple accents/voices available\n\n### 5. Test Customization Options\n- Company-specific tests (business English, industry vocabulary)\n- Individual student focus areas\n- Adjustable difficulty and question count\n- Time limits per section\n\n### 6. Evaluation \u0026 Scoring\n- Automatic scoring for objective questions (MCQ, fill-in-blank)\n- AI-assisted evaluation for written responses\n- CEFR level recommendation based on overall scores\n- Detailed breakdown by skill area\n- Confidence scores and improvement areas\n\n### 7. Admin Interface\n- LLM model selector (OpenRouter list)\n- Detailed prompt input box\n- Question type toggles\n- Company/student selector\n- Preview and edit generated tests\n- Save test templates\n\n### 8. Student Test-Taking Interface\n- Clean, distraction-free test environment\n- Progress indicator\n- Timer (optional)\n- Audio playback controls\n- Submit and review functionality\n\n---\n\n## NEW: Avatar-Driven Test Experience\n\n### 9. Avatar Test Mode\n- Test can be delivered via avatar (Beyond Presence integration)\n- **Three delivery modes**:\n  - **Web-only**: No avatar, self-paced with audio playback\n  - **Audio avatar**: Static image + Cartesia voice, real-time\n  - **Video avatar**: Full animated Beyond Presence avatar, real-time\n- Avatar presents slides with questions\n- Avatar speaks questions aloud using Cartesia TTS\n- Student responds verbally (speaking questions) or via UI (MCQ)\n- Mode selection available when starting test or via admin configuration\n\n### 10. Avatar Question Flow\n- Avatar displays slide containing question/content\n- Avatar reads the question or listening passage aloud\n- Student provides answer:\n  - Verbal response for speaking sections\n  - Click/tap for multiple choice questions\n  - Type for written responses\n- Avatar acknowledges response and transitions to next question\n- Answers automatically scored and tracked in real-time\n- Natural pauses between questions for processing\n\n### 11. Slide-Based Test Structure\n- Each question/section rendered as a slide\n- Slides contain:\n  - Question text\n  - Images (if applicable)\n  - Audio content (pre-generated or live TTS)\n  - Answer options (MCQ) or input fields\n- Avatar presents slides in sequence via existing slide sync system\n- Progress indicator shows current question and section\n- Navigation controls (next, previous where allowed)\n\n### 12. Avatar Feedback (Optional, Configurable)\n- At end of test, avatar provides personalized verbal feedback\n- Reviews performance by skill area (reading, grammar, listening, etc.)\n- Encourages student based on results with natural language\n- Suggests next steps and recommended CEFR level\n- Can be enabled/disabled per test via admin settings\n- Feedback script generated by LLM based on actual performance\n\n### 13. Test Delivery Configuration\n- **Per-test settings**:\n  - Delivery mode (web-only, audio avatar, video avatar)\n  - Avatar selection (which avatar delivers the test)\n  - Voice selection (Cartesia voice ID)\n  - Feedback enabled (yes/no)\n  - Feedback detail level (brief, detailed)\n- **Admin defaults**: Set default delivery mode for all tests\n- **Student override**: Allow students to choose delivery mode (if permitted)\n\n### 14. Integration with Existing Systems\n- **LiveKit/Beyond Presence**: Use existing avatar infrastructure from lessons\n- **Slide Rendering**: Use existing HTML slide renderer components\n- **Session Storage**: Store test sessions like lesson sessions in Convex\n- **Link to beethoven-kon**: Feed test results into student evaluation system\n- **Avatar Configuration**: Reuse avatar configs (voice, personality) from avatars table\n\n---\n\n## Technical Requirements\n\n### APIs\n- OpenRouter API for LLM access (multi-model)\n- Cartesia API for audio generation\n- Beyond Presence API for video avatar (existing integration)\n- LiveKit for real-time avatar communication\n\n### Database (Convex)\n- New tables: tests, testQuestions, testResults, testTemplates\n- Extended: testSessions (like lesson sessions)\n- Relations to students, companies, and avatars\n- Real-time progress tracking\n\n### Frontend Components (New)\n- Admin: Test creation/management pages in /admin/tests\n- Admin: Avatar test configuration panel\n- Student: Test-taking interface at /test/[testId]\n- Student: Avatar test room (extends lesson room pattern)\n\n### Frontend Components (Reused)\n- SlideViewer/HTMLSlideRenderer for question display\n- LessonRoom/TeachingRoom patterns for avatar interaction\n- Progress indicators from existing lesson UI\n\n### Python Agent Extensions\n- Test delivery mode for avatar agent\n- Question presentation flow\n- Response capture and scoring integration\n- Feedback generation and delivery\n\n---\n\n## Acceptance Criteria\n\n### Core Test System\n- [ ] Admin can select LLM model from OpenRouter list\n- [ ] Admin can write custom prompts for test generation\n- [ ] System generates valid CEFR-aligned questions\n- [ ] All 6 question types are supported\n- [ ] Cartesia generates audio for listening sections\n- [ ] Tests can be customized per company or student\n- [ ] Automatic scoring works for objective questions\n- [ ] AI evaluates written responses with feedback\n- [ ] Student receives CEFR level recommendation\n- [ ] Test results stored in Convex with detailed breakdown\n- [ ] Admin can save and reuse test templates\n\n### Avatar-Driven Experience\n- [ ] Test can be taken in web-only mode (no avatar)\n- [ ] Test can be taken with audio avatar (static image + voice)\n- [ ] Test can be taken with video avatar (Beyond Presence)\n- [ ] Avatar correctly presents each question via slides\n- [ ] Avatar speaks questions using Cartesia TTS\n- [ ] Student verbal responses are captured (speaking tests)\n- [ ] Student UI responses are captured (MCQ, written)\n- [ ] Progress tracked in real-time during avatar session\n- [ ] Avatar feedback is generated and delivered at end (when enabled)\n- [ ] Test sessions are stored like lesson sessions\n- [ ] Admin can configure delivery mode per test\n- [ ] Results integrate with beethoven-kon evaluation system\n\n---\n\n## Out of Scope (for initial implementation)\n- Adaptive testing (adjusting difficulty in real-time)\n- Video-based questions requiring video analysis\n- Proctoring/cheating detection\n- Integration with external certification bodies\n- Multi-avatar tests (single avatar per test session)","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-04T18:15:02.862461+01:00","created_by":"tomas","updated_at":"2026-01-04T18:27:25.996589+01:00","labels":["area:admin","area:ai","area:avatar","area:testing","cefr","integration:beethoven-kon","provider:beyond-presence","provider:cartesia","provider:livekit","provider:openrouter","scope:assessment","type:feature"]}
{"id":"beethoven-78q","title":"Feature: Audio-Only Lesson Mode - Add option to run lessons with audio only (no avatar video)","description":"## Summary\n\nAdd an explicit 'audioOnly' mode for lessons that uses TTS audio with a static avatar image instead of rendering the Beyond Presence video avatar. This mode can be selected when creating lessons to:\n- Save on Beyond Presence API costs\n- Work when avatar video quota is exceeded\n- Provide a lighter-weight lesson experience\n\n## Background\n\nThe Python agent already has audio-only fallback code (lines 1284-1447 in apps/agent/main.py) that activates when Beyond Presence fails (quota exceeded, auth error, rate limited, etc.). This feature request is to make audio-only mode an intentional, configurable option rather than just a fallback.\n\n## Implementation Tasks\n\n### 1. Schema Updates (convex/schema.ts)\n- Add `audioOnly: v.optional(v.boolean())` to `structuredLessons` table\n- Add `audioOnly: v.optional(v.boolean())` to `sessions` table\n\n### 2. Session Creation Updates (convex/sessions.ts)\n- Modify `createFromStructuredLesson` to pass through `audioOnly` flag to session\n- Ensure `createSession` accepts optional `audioOnly` parameter\n\n### 3. Admin UI Updates (app/(dashboard)/admin/lessons/page.tsx or related)\n- Add toggle/checkbox for \"Audio Only Mode\" when creating a structured lesson\n- Include tooltip explaining: \"Uses TTS audio with static avatar image instead of video avatar. Saves API costs.\"\n\n### 4. Frontend Lesson Room Updates\n- Modify lesson room component to check session.audioOnly flag\n- When audioOnly=true:\n  - Display static avatar image (from avatar.appearance.avatarImage) instead of video track\n  - Hide/disable avatar video track subscription\n  - TTS audio still plays normally\n- Reference existing components:\n  - components/lesson/lesson-room.tsx\n  - components/lesson/teaching-room.tsx\n\n### 5. Python Agent Updates (apps/agent/main.py)\n- Read `audioOnly` flag from session data (fetched via Convex client)\n- When audioOnly=true:\n  - Skip Beyond Presence avatar initialization entirely (don't even attempt)\n  - Set `audio_only_mode = True` at the start\n  - Use existing audio-only code path\n- This avoids wasting API calls and reduces startup latency\n\n## Acceptance Criteria\n\n- [ ] Admin can toggle \"Audio Only\" when creating a structured lesson\n- [ ] When audioOnly lesson is started, frontend shows static avatar image\n- [ ] TTS audio plays normally in audioOnly mode\n- [ ] Python agent skips avatar video initialization for audioOnly sessions\n- [ ] Existing fallback behavior still works when avatar fails unexpectedly\n- [ ] No regression to normal avatar video lessons\n\n## Technical Notes\n\n- Avatar static images are stored in `avatar.appearance.avatarImage` field\n- The existing `audio_only_mode` variable in main.py should be set based on session config\n- Session data is already fetched via ConvexClient in the agent\n- Consider adding visual indicator in lesson UI showing \"Audio Only Mode\" to student\n\n## Related Files\n\n- `/Users/tomas/apps/beethoven/convex/schema.ts` - Database schema\n- `/Users/tomas/apps/beethoven/convex/sessions.ts` - Session mutations/queries\n- `/Users/tomas/apps/beethoven/apps/agent/main.py` - Python agent (lines 1284-1447 for existing fallback)\n- `/Users/tomas/apps/beethoven/components/lesson/lesson-room.tsx` - Frontend lesson UI\n- `/Users/tomas/apps/beethoven/components/lesson/teaching-room.tsx` - Teaching room component\n\n## Out of Scope\n\n- Automatic switching between video and audio-only based on quota\n- Per-session toggle (only per-lesson configuration for now)\n- Audio-only for quick practice or free conversation (only structured lessons)","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-04T17:43:48.668012+01:00","created_by":"tomas","updated_at":"2026-01-04T17:43:48.668012+01:00","labels":["area:agent","area:frontend","area:lessons","cost-saving","type:enhancement"]}
{"id":"beethoven-bp5","title":"Feature: Avatar Session Memory - Remember Previous Conversations","description":"## Summary\n\nEnable avatars to remember previous conversations with students, providing personalized and continuous learning experiences across sessions.\n\n## Current State (Infrastructure Ready)\n\nThe database infrastructure exists but is **unused by the agent**:\n- `memories` table in Convex (facts, topics, importance, confidence)\n- `userMemorySync` table (Zep sync, cached facts, profile summary)\n- `errorPatterns` table (student mistakes tracking)\n- Memory CRUD functions in convex/memories.ts\n- Zep configured (but only used for RAG, not memory)\n\n## Critical Gaps (Not Implemented)\n\n1. **No Memory Retrieval at Session Start** - Agent doesn't fetch student memories\n2. **No Memory Storage After Sessions** - Transcripts saved but not processed\n3. **No Fact Extraction** - Conversations not mined for facts\n4. **No Memory in System Prompt** - Avatar has no context from prior sessions\n5. **Zep Memory Unused** - Only document RAG, not user memory features\n\n## Implementation Phases\n\n### Phase 1: Memory Retrieval (Core)\n- Add memory query methods to ConvexClient\n- Fetch student memories/profile in agent entrypoint\n- Inject memory context into system prompt\n- Fill opening greeting variables ({previousLesson})\n\n### Phase 2: Memory Storage (Persistence)\n- Session summary generation at session end\n- Fact extraction from transcripts (LLM-powered)\n- Error pattern recording during sessions\n- Store session summaries as memories\n\n### Phase 3: Zep Integration (Enhancement)\n- Use Zep's user memory API\n- Sync facts to both Zep and Convex\n- Semantic memory search\n\n### Phase 4: Natural Integration (Advanced)\n- Detect memory triggers mid-conversation\n- \"Remember when we discussed X?\"\n- Proactive memory use\n\n## Key Files\n\n- `apps/agent/main.py` - Fetch memories, inject into prompt\n- `apps/agent/src/utils/convex_client.py` - Add memory queries\n- `convex/memories.ts` - Add agent queries\n- New: `apps/agent/src/memory/` - Summarizer, extractor\n\n## Acceptance Criteria\n\n- [ ] Avatar has context from previous sessions at session start\n- [ ] System prompt includes student history summary\n- [ ] Opening greetings reference previous topics\n- [ ] Facts extracted and stored after sessions\n- [ ] Error patterns tracked for teaching focus\n- [ ] Avatar can say \"Last time we discussed X\" naturally\n- [ ] Memory is per-student, persists across days/weeks\n\n## Technical Notes\n\n- Memory retrieval must not add latency to session start (async/parallel fetch)\n- Fact extraction should be background process post-session\n- Consider memory importance scoring for prompt space management\n- Zep integration provides semantic search but Convex is source of truth","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-04T18:42:19.585767+01:00","created_by":"tomas","updated_at":"2026-01-04T18:42:19.585767+01:00","labels":["area:agent","area:convex","type:personalization"]}
{"id":"beethoven-cfh","title":"Test Agent Memory Systems (Knowledge Base + Zep Student Memory)","description":"Test and verify that both memory systems in the Beethoven agent are working correctly:\n\n## Knowledge Base (RAG)\n- Test that the agent can retrieve relevant information from uploaded knowledge bases\n- Verify lesson content, vocabulary lists, grammar explanations are accessible\n- Test retrieval accuracy and relevance\n\n## Zep Memory (Student Memory)\n- Test that student conversation history is being stored\n- Verify the agent remembers previous interactions with specific students\n- Test personalization based on student history (struggles, preferences, progress)\n- Check that memory persists across sessions\n\n## Testing Approach\n- Run test conversations with the agent\n- Query Zep Cloud to verify memory storage\n- Test RAG retrieval from knowledge bases in Convex\n- Check the agent logs for memory/RAG usage\n- Document any issues found\n\n## Relevant Code\n- apps/agent/main.py (RAG retriever initialization, Zep setup)\n- apps/agent/src/utils/ (convex_client.py for knowledge base access)\n- convex/knowledgeBases.ts (knowledge base management)\n\n## Acceptance Criteria\n- [ ] Knowledge base retrieval returns relevant lesson content\n- [ ] Zep stores conversation history correctly\n- [ ] Agent demonstrates recall of previous student interactions\n- [ ] Memory persists across multiple sessions\n- [ ] All issues documented with reproduction steps","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-04T17:48:03.79613+01:00","created_by":"tomas","updated_at":"2026-01-04T17:48:03.79613+01:00","labels":["area:agent","scope:memory","type:testing"]}
{"id":"beethoven-d20","title":"Role-Based Access Control (RBAC) Implementation","description":"## Summary\n\nImplement a comprehensive Role-Based Access Control (RBAC) system for the Beethoven platform as specified in /Users/tomas/apps/beethoven/specs/user-management/SPEC.md (Version 2.0.0).\n\n## Problem Statement\n\nThe current platform has basic admin/student/moderator/guest roles in the users table, but lacks:\n- Granular permission system for fine-grained access control\n- Company-scoped roles for B2B multi-tenant support\n- Custom role creation for enterprise customers\n- Group-level authorization (e.g., Group Lead role)\n- Role inheritance hierarchy\n- Scoped permissions (global/company/group/self)\n\n## Feature Components\n\n### 1. System Roles (6 roles)\n- **Super Admin**: Platform-wide full access\n- **Company Admin**: Full access within company scope\n- **Teacher / Content Creator**: Content management within company\n- **Group Lead**: Manage specific groups, view group progress\n- **Student**: Access enrolled content, track own progress\n- **Guest**: Limited trial access\n\n### 2. Permission System (40+ permissions)\nCategories:\n- User Management (view_all, view_company, create, edit, delete, assign_roles, impersonate)\n- Company Management (create, view_all, view_own, edit, delete, manage_subscription, create_custom_roles)\n- Group Management (create, view_all, view_own, edit, delete, add_members, remove_members)\n- Content Management (courses.*, lessons.*)\n- Enrollment \u0026 Assignment (assign_group, assign_individual, self_enroll, view_all, view_group)\n- Analytics \u0026 Reporting (view_platform, view_company, view_group, view_own, reports.export)\n- Avatar \u0026 Session (view, create, edit, assign, sessions.*)\n\n### 3. Database Schema\nNew tables required:\n- `roles`: System and custom role definitions\n- `userRoleAssignments`: User-role mappings with scope\n- `permissions`: Reference table for permission definitions\n\nUpdates to existing tables:\n- `companies`: Add rbacSettings field\n- `groups`: Add leadUserIds field\n- `courses`: Add companyId for company-scoping\n\n### 4. Authorization Infrastructure\n- `requirePermission()` helper for Convex functions\n- `resolvePermissions()` with inheritance support\n- `PermissionProvider` React context for UI\n- `ProtectedComponent` for conditional rendering\n- Middleware updates for route protection\n\n### 5. Custom Roles (Professional+ Tiers)\n- Companies on Professional/Enterprise can create custom roles\n- Roles inherit from base roles\n- Permissions limited to company scope\n- Max custom roles based on subscription tier\n\n## Implementation Phases\n\n### Phase 0: RBAC Foundation (Week 1-2)\n- [ ] Create roles table with system roles seeded\n- [ ] Create userRoleAssignments table\n- [ ] Create permissions reference table\n- [ ] Implement requirePermission() authorization helper\n- [ ] Implement resolvePermissions() with inheritance\n- [ ] Create PermissionProvider React context\n- [ ] Update middleware for route protection\n- [ ] Create seed script for default roles/permissions\n\n### Phase 1: Integration (Week 3-4)\n- [ ] Add RBAC checks to all existing Convex mutations\n- [ ] Implement role-based navigation visibility\n- [ ] Create role management admin pages\n- [ ] Add user role assignment UI\n\n### Phase 6: Custom Roles (Week 13-14)\n- [ ] Custom role creation UI (Professional+ tiers)\n- [ ] Custom role assignment\n- [ ] Role management admin page\n\n## Technical Reference\n\nFull specification: /Users/tomas/apps/beethoven/specs/user-management/SPEC.md\n\nKey sections:\n- Section 3: Role-Based Access Control (RBAC)\n- Section 3.9: Permission Matrix\n- Section 8: Convex Schema Additions\n- Section 12.1: RBAC Mutations\n- Appendix A: Default System Roles Definition\n\n## Acceptance Criteria\n\n- [ ] All 6 system roles defined and seeded in database\n- [ ] 40+ permissions defined across 8 categories\n- [ ] Permission scopes working (global/company/group/self/created)\n- [ ] Role inheritance correctly resolving permissions\n- [ ] requirePermission() helper used in all Convex mutations\n- [ ] UI components respect permissions via PermissionProvider\n- [ ] Admin routes protected by middleware\n- [ ] Role assignment UI functional for admins\n- [ ] Custom roles creatable by Company Admins (if tier allows)\n- [ ] All RBAC actions logged to auditLog table\n- [ ] No unauthorized access possible through any endpoint\n\n## Dependencies\n\n- Depends on: Companies and Groups table implementation (from user management spec)\n- Related to: beethoven-eji (Admin Dashboard Cleanup)\n\n## Related Files\n\n- /Users/tomas/apps/beethoven/specs/user-management/SPEC.md\n- /Users/tomas/apps/beethoven/convex/schema.ts\n- /Users/tomas/apps/beethoven/convex/users.ts (to be created/updated)\n- /Users/tomas/apps/beethoven/middleware.ts\n- /Users/tomas/apps/beethoven/components/providers/ (PermissionProvider)\n\n## Out of Scope\n\n- SSO/SAML integration (handled by Clerk)\n- Fine-grained row-level security\n- Time-based access windows\n- Delegation/proxy access","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-04T18:25:35.106356+01:00","created_by":"tomas","updated_at":"2026-01-04T18:26:10.110976+01:00","labels":["area:auth","area:core","beta-blocker","scope:rbac","type:feature"],"dependencies":[{"issue_id":"beethoven-d20","depends_on_id":"beethoven-4bd","type":"blocks","created_at":"2026-01-04T18:31:57.123895+01:00","created_by":"tomas"}]}
{"id":"beethoven-eji","title":"Admin Dashboard Cleanup \u0026 Beta Release Preparation","description":"Prepare the Beethoven platform for beta release by cleaning up the admin dashboard and ensuring all core functionality works end-to-end.\n\n## Context\n- Current admin pages at app/(dashboard)/admin/ include: avatars, knowledge, lessons, games, tools\n- Design should remain consistent - this is polish, not redesign\n- Goal is a clean, functional admin experience for beta users\n- This task BLOCKS beta release\n\n## Acceptance Criteria\n\n### 1. Cleanup Redundant Pages\n- [ ] Audit all pages in app/(dashboard)/ and document unused/redundant pages\n- [ ] Remove duplicate or obsolete components\n- [ ] Clean up any test/placeholder pages\n- [ ] Consolidate similar functionality where appropriate\n\n### 2. Admin Dashboard Polish\n- [ ] Keep existing design language (no redesign)\n- [ ] Ensure consistent styling across all admin pages\n- [ ] Fix any broken links or navigation issues\n- [ ] Ensure all admin features are functional and accessible\n- [ ] Remove any debug/development UI elements\n\n### 3. Beta Release Readiness\n- [ ] Verify Lesson creation flow works end-to-end\n- [ ] Verify Avatar configuration flow works end-to-end\n- [ ] Verify Knowledge base management flow works end-to-end\n- [ ] Verify Session management flow works end-to-end\n- [ ] Remove any placeholder/mock data displays\n- [ ] Add appropriate loading states where missing\n- [ ] Add error handling where missing\n- [ ] Ensure mobile responsiveness where needed\n- [ ] Clean up console errors and warnings\n\n### 4. Code Quality\n- [ ] Remove unused imports and dead code\n- [ ] Fix TypeScript types (eliminate unnecessary 'any' types)\n- [ ] Clean up commented-out code\n- [ ] Ensure consistent naming conventions\n\n## Technical Notes\n\n### Files to Audit\n- app/(dashboard)/admin/page.tsx - Main admin page\n- app/(dashboard)/admin/avatars/page.tsx - Avatar management\n- app/(dashboard)/admin/knowledge/page.tsx - Knowledge base management\n- app/(dashboard)/admin/lessons/page.tsx - Lesson management\n- app/(dashboard)/admin/games/ - Games (new, may need review)\n- app/(dashboard)/admin/tools/ - Tools (new, may need review)\n- app/(dashboard)/admin/layout.tsx - Admin layout\n\n### Core Flows to Test\n1. **Lesson Creation**: Create lesson -\u003e Add slides -\u003e Configure settings -\u003e Save\n2. **Avatar Configuration**: Create avatar -\u003e Set voice/LLM config -\u003e Test\n3. **Knowledge Base**: Upload documents -\u003e Process -\u003e Associate with lessons\n4. **Session Management**: View sessions -\u003e Monitor status -\u003e Review transcripts\n\n### Scope Boundaries\n- NOT a redesign - keep existing visual style\n- Focus on functionality and cleanup, not new features\n- Mobile optimization is nice-to-have, not required for all views\n- Admin is internal tool, so performance optimization is secondary\n\n## Related Files (from git status)\nSeveral admin-related files show modifications:\n- app/(dashboard)/admin/avatars/page.tsx\n- app/(dashboard)/admin/knowledge/page.tsx\n- app/(dashboard)/admin/layout.tsx\n- app/(dashboard)/admin/lessons/page.tsx\n- app/(dashboard)/admin/page.tsx\n- New: app/(dashboard)/admin/games/\n- New: app/(dashboard)/admin/tools/","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-04T18:09:13.585837+01:00","created_by":"tomas","updated_at":"2026-01-04T18:09:13.585837+01:00","labels":["area:admin","area:frontend","beta-blocker","type:cleanup"]}
{"id":"beethoven-kon","title":"Student Evaluation \u0026 Progress Tracking System","description":"## Summary\n\nCreate a comprehensive and solid logic for evaluating students throughout their learning journey. This is a core platform feature that enables personalized learning paths and measurable progress tracking.\n\n## Problem Statement\n\nThe platform currently lacks a unified evaluation system. While individual components exist (vocabularyProgress, exerciseProgress, session metrics), there is no:\n- Unified proficiency assessment (CEFR A1-C2)\n- Skill-specific progress tracking across multiple dimensions\n- Trend analysis over time\n- AI-powered evaluation of speaking/writing\n- Personalized recommendations based on performance\n\n## Existing Code Audit\n\n**What already exists:**\n- `convex/vocabularyProgress.ts` - SM-2 spaced repetition for vocabulary\n- `convex/exerciseProgress.ts` - Exercise attempt tracking with scores\n- `convex/sessions.ts` - Session metrics (wordsSpoken, newVocabulary, errorsCorreected, germanSupportUsed)\n- `convex/schema.ts`:\n  - `progress` table (skillType, level, experiencePoints)\n  - `studentVocabulary` table (mastery tracking)\n  - `errorPatterns` table (mistake tracking)\n  - `memories` table (student fact extraction)\n  - `userMemorySync` table (Zep integration with profileSummary including strongAreas, weakAreas)\n- `students` table has: currentLevel, assessmentCompleted flag, totalLessonsCompleted, totalMinutesPracticed\n\n**What's missing:**\n- Composite scoring algorithms\n- CEFR level calculation logic\n- Skill radar breakdown (Reading, Writing, Listening, Speaking, Grammar, Vocabulary)\n- Progress trend analysis\n- AI-evaluated speaking/writing\n- Student dashboard visualization components\n- Entry test integration (links to beethoven-6pp)\n- Periodic progress assessments\n- Achievement/milestone system\n\n## Feature Components\n\n### 1. Evaluation Metrics\n- **Overall proficiency level**: CEFR A1-C2 (calculated from skill breakdown)\n- **Skill breakdown**: Reading, Writing, Listening, Speaking, Grammar, Vocabulary\n- **Progress over time**: Trend analysis with daily/weekly/monthly views\n- **Session-by-session performance**: Per-session scores and comparisons\n- **Strengths/weaknesses identification**: AI-powered analysis\n\n### 2. Data Points to Track\n- Lesson completion rates and quality\n- Quiz/test scores (from entry test - beethoven-6pp)\n- Response accuracy during avatar sessions\n- Speaking fluency metrics:\n  - Hesitation frequency\n  - Self-corrections\n  - Response latency\n  - German support usage ratio\n- Vocabulary retention (already in SM-2 system)\n- Time spent on tasks\n- Error patterns and common mistakes (already tracked)\n\n### 3. Evaluation Methods\n- **Entry test (placement)**: Links to beethoven-6pp Cambridge English Test Creator\n- **Ongoing formative assessment**: Real-time during avatar lessons\n- **Periodic progress tests**: Scheduled assessments (weekly/monthly)\n- **AI-evaluated speaking/writing**: Using LLM for qualitative feedback\n- **Self-assessment options**: Student confidence ratings\n\n### 4. Scoring \u0026 Weighting Logic\n- Define scoring algorithms for each skill area\n- Weight different assessment types appropriately:\n  - Entry test: 30%\n  - Ongoing performance: 50%\n  - Periodic tests: 20%\n- Normalize scores across different test types\n- Calculate composite scores mapping to CEFR levels\n\n### 5. Progress Visualization (Frontend)\n- Student dashboard with progress charts\n- Skill radar/spider charts (6 skills)\n- Progress timeline with milestones\n- Comparison to learning goals\n- Achievement badges/milestones system\n\n### 6. Feedback \u0026 Recommendations\n- AI-generated feedback on performance\n- Personalized learning recommendations\n- Suggested focus areas based on weak points\n- Recommended lessons/exercises from library\n\n### 7. Integration Points\n- Avatar session transcripts analysis (already captured)\n- Lesson completion data from Convex (sessions table)\n- Test results storage and retrieval\n- Zep memory for long-term tracking (userMemorySync)\n- Error patterns aggregation\n\n## Technical Implementation\n\n### Database Changes (Convex)\n```\n// New tables needed:\nstudentEvaluation - Composite scores and CEFR levels\nskillScores - Per-skill tracking over time\nassessmentResults - Entry test and periodic test results\nachievements - Unlocked milestones\nlearningRecommendations - AI-generated suggestions\n```\n\n### New Convex Functions\n- `evaluation/calculateCefrLevel` - Compute CEFR from skill scores\n- `evaluation/updateSkillScores` - Update individual skills after sessions\n- `evaluation/generateRecommendations` - AI recommendations\n- `evaluation/getProgressTrend` - Time-series progress data\n- `evaluation/recordAssessment` - Store test results\n\n### Frontend Components\n- `components/progress/SkillRadarChart.tsx`\n- `components/progress/ProgressTimeline.tsx`\n- `components/progress/AchievementBadges.tsx`\n- `app/(dashboard)/progress/page.tsx` - Enhanced progress dashboard\n\n## Acceptance Criteria\n\n- [ ] CEFR level calculation works based on composite skill scores\n- [ ] All 6 skills (R/W/L/S/G/V) tracked independently\n- [ ] Session performance updates skill scores automatically\n- [ ] Progress trends visible over time (week/month/all-time)\n- [ ] AI generates actionable feedback after sessions\n- [ ] Entry test results (from beethoven-6pp) integrated into evaluation\n- [ ] Student dashboard shows skill radar chart\n- [ ] Achievement/milestone system with unlockable badges\n- [ ] Personalized lesson recommendations based on weak areas\n- [ ] Error patterns inform vocabulary/grammar focus suggestions\n\n## Dependencies\n\n- **beethoven-6pp** (Feature: Cambridge English Entry Test Creator) - Required for entry placement test\n- Zep memory system for long-term student profiling\n- Avatar session transcript storage (already implemented)\n\n## Out of Scope (Phase 1)\n\n- Predictive analytics for learning outcomes\n- Comparative benchmarking against other students\n- External certification integration\n- Parent/teacher reporting dashboards","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-04T18:18:57.286639+01:00","created_by":"tomas","updated_at":"2026-01-04T18:18:57.286639+01:00","labels":["area:core","area:evaluation","cefr","scope:assessment","type:feature"],"dependencies":[{"issue_id":"beethoven-kon","depends_on_id":"beethoven-6pp","type":"related","created_at":"2026-01-04T18:19:03.737945+01:00","created_by":"tomas"}]}
{"id":"beethoven-rb0","title":"Email Integration with Resend","description":"Set up email functionality for the Beethoven platform using Resend as the email provider.\n\n## Configuration\n- Email provider: Resend (https://resend.com/docs)\n- Sender email: james@simmonds.online\n- API key location: api-registry.json (add to RESEND_API_KEY env var)\n\n## Email Use Cases\n- Welcome emails for new users\n- Lesson assignment notifications\n- Course enrollment confirmations\n- Session reminders (scheduled lessons)\n- Progress reports/summaries\n- Password reset (if not handled by Clerk)\n- Shareable game/lesson link emails\n\n## Implementation Tasks\n\n### 1. Setup \u0026 Configuration\n- [ ] Install Resend SDK (`npm install resend`)\n- [ ] Add RESEND_API_KEY to environment variables\n- [ ] Create email utility/service in `lib/email.ts`\n\n### 2. API Routes\n- [ ] Create API route: `app/api/email/send/route.ts`\n- [ ] Add request validation and error handling\n- [ ] Implement rate limiting (optional)\n\n### 3. Email Templates (React Email or HTML)\n- [ ] Welcome email (new user registration)\n- [ ] Lesson assigned notification\n- [ ] Course enrollment confirmation\n- [ ] Session reminder (scheduled lesson)\n- [ ] Shareable link email (games/lessons)\n- [ ] Progress report summary\n\n### 4. Integration Points\n- [ ] Convex actions for triggering emails on events\n- [ ] Hook into Clerk webhooks for welcome emails\n- [ ] Connect to lesson/session creation flows\n- [ ] Admin UI for manual email sending (optional)\n\n## Technical Notes\n- Consider using React Email for type-safe, component-based templates\n- Resend supports React components directly for email rendering\n- Test emails in development with Resend's test mode\n- Add email sending to session reminders cron job (if exists)\n\n## Acceptance Criteria\n- [ ] Emails send successfully from james@simmonds.online\n- [ ] All core templates render correctly\n- [ ] Email sending is triggered on appropriate platform events\n- [ ] Error handling prevents silent failures\n- [ ] Email logs available for debugging","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-04T18:10:41.983221+01:00","created_by":"tomas","updated_at":"2026-01-04T18:10:41.983221+01:00","labels":["area:api","area:backend","provider:resend","type:integration"]}
{"id":"beethoven-xcs","title":"Shareable Game Links for Client Sessions","description":"## Summary\n\nAdd the ability to generate unique shareable links for games so teachers can invite students/clients to play games together in real-time. This enables collaborative/multiplayer gameplay between teacher and student over the web.\n\n## Background\n\nThe Beethoven platform already has a robust game system (components/games/) with multiple game types:\n- SentenceBuilder, FillInBlank, WordOrdering, MatchingPairs\n- WordScramble, MultipleChoice, Flashcards, Hangman, Crossword\n\nGames are stored in the `wordGames` table with individual play sessions tracked in `gameSessions`. However, the current implementation only supports single-player mode. This feature extends the system to support real-time multiplayer sessions via shareable links.\n\n## Requirements\n\n### 1. Unique Token Generation\n- Generate cryptographically secure tokens for game sessions\n- Tokens should be URL-safe and reasonably short (e.g., 12-16 chars)\n- Tokens must be indexed in database for fast lookup\n\n### 2. Shareable URL Structure\n- Create routes like `/games/play/[token]` for public game access\n- URLs should work without authentication for invited clients\n- Consider optional password protection for additional security\n\n### 3. Real-time Multiplayer State\n- Extend `gameSessions` table with multiplayer fields:\n  - `shareToken`: unique token for the link\n  - `hostUserId`: teacher/creator ID\n  - `participants`: array of connected participants\n  - `isMultiplayer`: boolean flag\n  - `sharedState`: synchronized game state object\n- Use Convex subscriptions for real-time state sync\n\n### 4. Game State Synchronization\n- Sync current question/card/item index across participants\n- Sync answers and progress\n- Handle turn-based vs concurrent gameplay modes\n- Implement conflict resolution for simultaneous actions\n\n### 5. UI for Link Generation\n- Add \"Share Game\" button in admin/games interface\n- Copy-to-clipboard functionality for the shareable URL\n- Show QR code option for easy mobile joining\n- Display list of active shared sessions\n\n### 6. Join Flow for Clients\n- Landing page at `/games/play/[token]`\n- Prompt for name/nickname if not authenticated\n- Display game waiting room until host starts\n- Show participant list in real-time\n\n## Technical Approach\n\n### Database Changes (convex/schema.ts)\n- Add `shareToken` field to `gameSessions` with unique index\n- Add `multiplayerSessions` table or extend `gameSessions` with:\n  - `hostUserId`, `participants`, `gameSettings`\n  - `status`: \"waiting\", \"active\", \"completed\"\n\n### New Convex Functions (convex/wordGames.ts)\n- `createShareableSession`: Generate token, create session\n- `joinSharedSession`: Add participant to session\n- `getSessionByToken`: Lookup by share token\n- `updateSharedGameState`: Sync state across participants\n- `leaveSession`, `endSharedSession`\n\n### Frontend Routes\n- `app/(public)/games/play/[token]/page.tsx` - Public join page\n- `app/(dashboard)/admin/games/[gameId]/share/page.tsx` - Share management\n\n### Components\n- `ShareGameDialog` - Modal with link generation UI\n- `GameWaitingRoom` - Pre-game lobby\n- `MultiplayerGameWrapper` - Real-time sync wrapper\n\n## Acceptance Criteria\n\n- [ ] Teacher can click \"Share\" on any published game\n- [ ] Unique shareable URL is generated and copyable\n- [ ] Client can open link and join without creating account\n- [ ] Teacher sees client join in real-time (participant list)\n- [ ] Game state syncs in real-time between all participants\n- [ ] Game works across all supported game types\n- [ ] Host can end/close the shared session\n- [ ] Tokens expire or can be manually revoked\n- [ ] Session state persists if client briefly disconnects\n- [ ] Works on mobile browsers\n\n## Out of Scope (for initial version)\n\n- Voice/video chat integration (use LiveKit separately)\n- Score leaderboards between multiple students\n- Game tournaments/competitions\n- Replay/recording functionality\n- Anonymous/guest host creation\n\n## Related Files\n\n- `/Users/tomas/apps/beethoven/convex/wordGames.ts` - Game queries/mutations\n- `/Users/tomas/apps/beethoven/convex/schema.ts` - Database schema (lines 1127-1300)\n- `/Users/tomas/apps/beethoven/components/games/` - All game components\n- `/Users/tomas/apps/beethoven/app/(dashboard)/admin/games/` - Admin game pages\n\n## Estimated Effort\n\nMedium complexity - 2-3 days\n- Schema changes: 2-3 hours\n- Convex functions: 4-6 hours\n- Frontend routes/components: 8-12 hours\n- Testing multiplayer sync: 4-6 hours","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-04T17:47:03.769565+01:00","created_by":"tomas","updated_at":"2026-01-04T17:47:03.769565+01:00","labels":["area:convex","area:frontend","area:games","multiplayer","type:feature"]}
