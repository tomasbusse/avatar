# PDF Editor Feature Specification

> Generated by @deep-requirements-orchestrator
> Interview rounds: 7
> Date: 2026-01-03
> Platform: Beethoven (Emma AI Platform)

---

## Executive Summary

This specification defines a comprehensive PDF Editor tool for the Beethoven AI language learning platform. The editor enables admins and moderators to create, edit, and distribute interactive PDF worksheets with fill-in-the-blank form fields for student assessment. Key capabilities include importing existing PDFs with OCR text extraction, adding a full suite of assessment field types (text, multiple choice, checkboxes, matching pairs, drag-and-drop), auto-grading with multiple acceptable answers, and real-time collaborative editing.

**Key Decisions:**
- Hybrid workflow: Import existing PDFs with OCR OR create from templates
- Full assessment field suite with print-friendly conversions
- Auto-grading with multiple acceptable answers per field
- Per-PDF CEFR level tagging with pass/fail scoring
- Adobe Acrobat-style panel-based interface
- Real-time collaboration with field-level locking
- Navigation restructure: Games page becomes Tools with sub-routes
- Anonymous aggregation of student responses (no individual tracking)
- PDF.js + server-side hybrid approach for rendering/editing
- A4 European standard paper size

---

## Table of Contents

1. [Problem & Context](#1-problem--context)
2. [Users & Personas](#2-users--personas)
3. [Navigation Restructure](#3-navigation-restructure)
4. [PDF Editor Core Features](#4-pdf-editor-core-features)
5. [Form Field Types](#5-form-field-types)
6. [Auto-Grading System](#6-auto-grading-system)
7. [User Interface Specification](#7-user-interface-specification)
8. [Student Experience](#8-student-experience)
9. [Templates System](#9-templates-system)
10. [Database Schema](#10-database-schema)
11. [API Specification](#11-api-specification)
12. [Technical Architecture](#12-technical-architecture)
13. [Real-time Collaboration](#13-real-time-collaboration)
14. [Security & Access Control](#14-security--access-control)
15. [Error Handling](#15-error-handling)
16. [Implementation Phases](#16-implementation-phases)
17. [Success Metrics](#17-success-metrics)
18. [Decisions Log](#18-decisions-log)
19. [Out of Scope](#19-out-of-scope)
20. [Open Questions](#20-open-questions)

---

## 1. Problem & Context

### 1.1 Problem Statement

The Beethoven platform currently lacks a tool for creating and distributing structured assessment worksheets. Teachers and admins need to:

- Create fill-in-the-blank exercises for evaluating student English proficiency
- Work with existing PDF materials (textbooks, worksheets) and enhance them with interactive fields
- Automatically grade student responses against correct answers
- Assess student CEFR level (A1-C2) based on worksheet performance
- Distribute worksheets both online and as printable documents

### 1.2 Solution Overview

A PDF Editor tool that:
- Allows importing existing PDFs with AI-enhanced OCR text extraction
- Provides a professional editing interface (Adobe Acrobat-style)
- Supports a full suite of assessment field types
- Auto-grades submissions with multiple acceptable answers
- Generates print-friendly versions with appropriate conversions
- Enables real-time collaborative editing
- Integrates into a new "Tools" section alongside existing Games

### 1.3 Business Context

This feature serves two primary use cases:
1. **Client Evaluation**: Assess prospective students' English level during onboarding
2. **Ongoing Assessment**: Provide structured exercises for tracking progress

The feature is available to all subscription tiers with unlimited storage.

---

## 2. Users & Personas

| User Type | Description | Primary Need | Access Level |
|-----------|-------------|--------------|--------------|
| **Admin** | Platform administrator, course designer | Create and manage all PDF worksheets | Full CRUD |
| **Moderator** | Content creator, teacher | Create and edit PDF worksheets | Full CRUD |
| **Student** | German speaker learning English | Complete worksheets, see results | View & Submit |
| **Anonymous User** | Anyone with a share link | Complete worksheets | View & Submit |

### 2.1 User Stories

#### Admin/Moderator Stories

| ID | Story | Priority |
|----|-------|----------|
| US-01 | As an admin, I want to upload an existing PDF so I can add interactive form fields to it | Must Have |
| US-02 | As a moderator, I want to create a new worksheet from a template so I can quickly build assessments | Must Have |
| US-03 | As an admin, I want to add text input fields with multiple correct answers so students have flexibility in responses | Must Have |
| US-04 | As a moderator, I want to add multiple choice questions so I can test vocabulary recognition | Must Have |
| US-05 | As an admin, I want to add matching pair exercises that convert to "draw a line" when printed | Should Have |
| US-06 | As a moderator, I want to preview the worksheet as a student would see it so I can verify the experience | Must Have |
| US-07 | As an admin, I want to collaborate with colleagues in real-time so we can build worksheets together | Should Have |
| US-08 | As a moderator, I want to tag worksheets with CEFR levels so auto-grading suggests appropriate levels | Must Have |
| US-09 | As an admin, I want to generate a shareable link so students can access the worksheet | Must Have |
| US-10 | As a moderator, I want to save a worksheet as a template so I can reuse the structure | Should Have |
| US-11 | As an admin, I want to copy fields between PDFs so I can reuse field configurations | Should Have |
| US-12 | As a moderator, I want to export a print-friendly PDF so students can complete it on paper | Must Have |

#### Student Stories

| ID | Story | Priority |
|----|-------|----------|
| US-20 | As a student, I want to complete a worksheet online so I can get immediate feedback | Must Have |
| US-21 | As a student, I want to download a printable version so I can practice offline | Must Have |
| US-22 | As a student, I want to see my score and CEFR level assessment after submitting | Must Have |
| US-23 | As an anonymous user, I want to access a worksheet via shared link without logging in | Must Have |

---

## 3. Navigation Restructure

### 3.1 URL Architecture Changes

**Current Structure:**
```
/admin/games                    -> Games list
/admin/games/[gameId]/edit      -> Edit game
/admin/games/[gameId]/preview   -> Preview game
```

**New Structure:**
```
/admin/tools                    -> Tools landing (redirect to /admin/tools/games)
/admin/tools/games              -> Games list (moved from /admin/games)
/admin/tools/games/[gameId]/edit
/admin/tools/games/[gameId]/preview
/admin/tools/pdf-editor         -> PDF worksheets list
/admin/tools/pdf-editor/create  -> Create new PDF worksheet
/admin/tools/pdf-editor/[id]/edit    -> Edit PDF worksheet
/admin/tools/pdf-editor/[id]/preview -> Preview as student
```

### 3.2 Redirect Rules

| Old URL | New URL | Redirect Type |
|---------|---------|---------------|
| `/admin/games` | `/admin/tools/games` | 301 Permanent |
| `/admin/games/*` | `/admin/tools/games/*` | 301 Permanent |

### 3.3 Sidebar Navigation

```
Admin
├── Dashboard
├── Tools                        <- NEW (expandable)
│   ├── Games                    <- Moved from top level
│   └── PDF Editor               <- NEW
├── Lessons
├── Avatars
├── Knowledge
├── Students
└── Settings
```

### 3.4 Tools Landing Page

The `/admin/tools` route displays a dashboard with cards for each tool:

```
+------------------------------------------------------------------+
| Tools                                                             |
+------------------------------------------------------------------+
|                                                                   |
|  +---------------------------+  +---------------------------+     |
|  |  [Gamepad Icon]           |  |  [Document Icon]          |     |
|  |  Word Games               |  |  PDF Editor               |     |
|  |                           |  |                           |     |
|  |  Create interactive word  |  |  Create assessment        |     |
|  |  games for lessons        |  |  worksheets with forms    |     |
|  |                           |  |                           |     |
|  |  [45 games] [View ->]     |  |  [12 worksheets] [View ->]|     |
|  +---------------------------+  +---------------------------+     |
|                                                                   |
+------------------------------------------------------------------+
```

---

## 4. PDF Editor Core Features

### 4.1 Document Creation Modes

#### Mode 1: Import Existing PDF
1. User uploads PDF file (max 50MB, max 100 pages)
2. System processes PDF with OCR/text extraction
3. AI (Gemini) cleans up and corrects OCR errors
4. User sees extracted text overlaid on original
5. User can edit extracted text or switch to overlay-only mode
6. User adds form fields relative to text positions

#### Mode 2: Create from Template
1. User selects from 5-10 basic templates
2. Template loads with placeholder content
3. User edits content and adds form fields
4. System generates A4 PDF output

#### Mode 3: Blank Canvas
1. User starts with blank A4 page
2. User adds text, images, and form fields
3. Limited page layout capabilities (not a full DTP system)

### 4.2 PDF Import Processing Pipeline

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Upload     │────>│  Extract    │────>│  AI Clean   │
│  PDF File   │     │  Text (OCR) │     │  (Gemini)   │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Ready for  │<────│  Store      │<────│  Generate   │
│  Editing    │     │  in Convex  │     │  Text Layer │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 4.3 Text Extraction with AI Enhancement

When OCR extracts text, Gemini cleans and corrects:
- Fix common OCR errors (rn -> m, l1 -> li, etc.)
- Restore proper spacing and line breaks
- Identify headers, paragraphs, lists
- Detect language (English/German)
- Flag low-confidence regions for manual review

**Prompt Template:**
```
You are an OCR correction specialist for educational documents.
Clean up this extracted text while preserving the original meaning.

Original OCR text:
{extracted_text}

Rules:
1. Fix character recognition errors (rn->m, 0->O, l->1, etc.)
2. Restore proper paragraph breaks
3. Fix spacing issues
4. Preserve any intentional blanks (___) for fill-in exercises
5. Keep formatting indicators (headers, lists)
6. Flag uncertain corrections with [?]

Return cleaned text only.
```

### 4.4 Multi-Page Handling

- Thumbnail sidebar shows all pages
- Click thumbnail to navigate to page
- Fields are defined per-page with page reference
- Page navigator shows: page number, field count per page
- Can reorder pages (drag thumbnails)
- Can delete pages
- Can add blank pages

### 4.5 Document Properties

| Property | Type | Description |
|----------|------|-------------|
| `title` | string | Worksheet title |
| `description` | string | Optional description |
| `cefrLevel` | enum | A1, A2, B1, B2, C1, C2 |
| `category` | string | Grammar, Vocabulary, Reading, Writing, Mixed |
| `tags` | string[] | Searchable tags |
| `passingScore` | number | Percentage required to "pass" (default: 70%) |
| `timeLimit` | number | Optional time limit in minutes |
| `instructions` | string | Instructions shown to students |

---

## 5. Form Field Types

### 5.1 Field Type Overview

| Field Type | Input Method | Print Conversion | Auto-Gradable |
|------------|--------------|------------------|---------------|
| Text Input | Keyboard entry | Blank line (______) | Yes |
| Multiple Choice | Radio buttons | Circled options (A B C D) | Yes |
| Checkbox | Checkbox click | Empty squares | Yes |
| Matching Pairs | Click to connect | "Draw a line" format | Yes |
| Drag-and-Drop | Drag items to zones | Fill-in numbered blanks | Yes |
| Long Text | Textarea | Lined writing area | No (manual) |

### 5.2 Text Input Field

**Purpose:** Fill-in-the-blank text answers

**Configuration:**
```typescript
interface TextInputField {
  id: string;
  type: "text_input";
  position: {
    page: number;
    x: number;        // Percentage from left
    y: number;        // Percentage from top
    width: number;    // Percentage of page width
  };
  label?: string;     // Optional label shown above field
  placeholder?: string;
  correctAnswers: string[];  // Multiple acceptable answers
  caseSensitive: boolean;    // Default: false
  trimWhitespace: boolean;   // Default: true
  points: number;            // Points for correct answer
}
```

**Example:**
```json
{
  "id": "field-1",
  "type": "text_input",
  "position": { "page": 1, "x": 45, "y": 32, "width": 15 },
  "correctAnswers": ["has been", "have been", "'s been"],
  "caseSensitive": false,
  "points": 1
}
```

**Print Conversion:** Renders as underlined blank space

### 5.3 Multiple Choice Field

**Purpose:** Select one correct answer from options

**Configuration:**
```typescript
interface MultipleChoiceField {
  id: string;
  type: "multiple_choice";
  position: {
    page: number;
    x: number;
    y: number;
    width: number;
    height: number;
  };
  question?: string;          // Optional question text
  options: {
    id: string;
    text: string;
    isCorrect: boolean;
  }[];
  layout: "vertical" | "horizontal" | "grid";
  points: number;
}
```

**Print Conversion:** Options shown as (A) (B) (C) (D) with circles to mark

### 5.4 Checkbox Field

**Purpose:** Select multiple correct answers (select all that apply)

**Configuration:**
```typescript
interface CheckboxField {
  id: string;
  type: "checkbox";
  position: {
    page: number;
    x: number;
    y: number;
    width: number;
    height: number;
  };
  question?: string;
  options: {
    id: string;
    text: string;
    shouldBeChecked: boolean;
  }[];
  layout: "vertical" | "horizontal";
  scoringMode: "all_or_nothing" | "partial";  // Partial gives points per correct selection
  points: number;
}
```

**Print Conversion:** Empty square boxes next to each option

### 5.5 Matching Pairs Field

**Purpose:** Connect items from two columns

**Configuration:**
```typescript
interface MatchingPairsField {
  id: string;
  type: "matching_pairs";
  position: {
    page: number;
    x: number;
    y: number;
    width: number;
    height: number;
  };
  instructions?: string;
  pairs: {
    id: string;
    left: string;       // Left column item
    right: string;      // Right column item (correct match)
  }[];
  shuffleRight: boolean;  // Shuffle right column display order
  pointsPerPair: number;
}
```

**Online Experience:**
- Left column items displayed in order
- Right column items shuffled
- Click left item, then click matching right item
- Lines drawn to show connections
- Can click connection to remove it

**Print Conversion:**
```
Match the words with their definitions. Draw a line to connect.

1. purchase           a) final date or time
2. deadline           b) to buy something
3. negotiate          c) income from business
4. revenue            d) discuss to reach agreement
```

### 5.6 Drag-and-Drop Field

**Purpose:** Place items into correct positions/zones

**Configuration:**
```typescript
interface DragDropField {
  id: string;
  type: "drag_drop";
  position: {
    page: number;
    x: number;
    y: number;
    width: number;
    height: number;
  };
  instructions?: string;
  items: {
    id: string;
    text: string;
    correctZone: string;  // ID of correct drop zone
  }[];
  zones: {
    id: string;
    label: string;
    position: { x: number; y: number; width: number; height: number };
  }[];
  pointsPerCorrect: number;
}
```

**Online Experience:**
- Draggable items shown in a bank
- Drop zones highlighted on PDF
- Drag items to appropriate zones
- Visual feedback on drop

**Print Conversion:**
```
Fill in the blanks with words from the box.

+------------------------------------------+
| purchase | deadline | negotiate | revenue |
+------------------------------------------+

1. We need to __________ a new contract.
2. The project __________ is next Friday.
3. Our annual __________ increased by 15%.
4. I'd like to __________ this laptop.
```

### 5.7 Long Text Field

**Purpose:** Free-form written responses (not auto-graded)

**Configuration:**
```typescript
interface LongTextField {
  id: string;
  type: "long_text";
  position: {
    page: number;
    x: number;
    y: number;
    width: number;
    height: number;
  };
  prompt?: string;
  minLength?: number;
  maxLength?: number;
  lineCount: number;    // Number of lines to show
  points: number;       // Manual grading points
}
```

**Print Conversion:** Horizontal lines for writing

---

## 6. Auto-Grading System

### 6.1 Grading Algorithm

```typescript
interface GradingResult {
  totalPoints: number;
  earnedPoints: number;
  percentage: number;
  passed: boolean;
  cefrAssessment: {
    level: CEFRLevel;
    confidence: "low" | "medium" | "high";
    message: string;
  };
  fieldResults: {
    fieldId: string;
    correct: boolean;
    earnedPoints: number;
    maxPoints: number;
    studentAnswer: any;
    correctAnswers: any;
  }[];
}
```

### 6.2 Answer Matching Rules

**Text Input Matching:**
```typescript
function matchTextAnswer(
  studentAnswer: string,
  correctAnswers: string[],
  options: { caseSensitive: boolean; trimWhitespace: boolean }
): boolean {
  let normalized = studentAnswer;

  if (options.trimWhitespace) {
    normalized = normalized.trim();
  }

  if (!options.caseSensitive) {
    normalized = normalized.toLowerCase();
  }

  return correctAnswers.some(correct => {
    let normalizedCorrect = correct;
    if (options.trimWhitespace) normalizedCorrect = normalizedCorrect.trim();
    if (!options.caseSensitive) normalizedCorrect = normalizedCorrect.toLowerCase();
    return normalized === normalizedCorrect;
  });
}
```

**Multiple Choice Matching:**
- Single correct answer must match selected option

**Checkbox Matching:**
- All-or-nothing: All selections must be exactly correct
- Partial: Points = (correct selections) / (total options) * maxPoints

**Matching Pairs:**
- Points per correctly matched pair

**Drag-and-Drop:**
- Points per item placed in correct zone

### 6.3 CEFR Level Assessment

Each PDF worksheet is tagged with a CEFR level. Assessment is based on pass/fail:

| Score | Assessment |
|-------|------------|
| >= passingScore | "Pass - Ready for [level] content" |
| 50-passingScore | "Developing - Continue practicing [level]" |
| < 50% | "Review needed - Consider [level-1] content" |

**Assessment Message Templates:**
```typescript
const assessmentMessages = {
  pass: {
    A1: "Great job! You demonstrate beginner English proficiency.",
    A2: "Well done! You show elementary English skills.",
    B1: "Excellent! You have intermediate English proficiency.",
    B2: "Impressive! You demonstrate upper-intermediate skills.",
    C1: "Outstanding! You show advanced English proficiency.",
    C2: "Exceptional! You demonstrate near-native proficiency."
  },
  developing: {
    A1: "You're making progress with basic English. Keep practicing!",
    // ... etc
  },
  review: {
    A1: "Let's review some fundamentals before continuing.",
    // ... etc
  }
};
```

### 6.4 Anonymous Aggregation

Student responses are aggregated anonymously:

```typescript
interface WorksheetAnalytics {
  worksheetId: Id<"pdfWorksheets">;
  totalSubmissions: number;
  averageScore: number;
  passRate: number;
  fieldAnalytics: {
    fieldId: string;
    correctRate: number;
    commonWrongAnswers: { answer: string; count: number }[];
  }[];
  updatedAt: number;
}
```

Individual student responses are NOT stored - only aggregate statistics.

---

## 7. User Interface Specification

### 7.1 Editor Layout (Adobe Acrobat Style)

```
+------------------------------------------------------------------------+
| [Logo] PDF Editor                    [Preview] [Export] [Share] [Save] |
+------------------------------------------------------------------------+
|        |                                              |                |
| TOOLS  |              PDF CANVAS                      |  PROPERTIES    |
|        |                                              |                |
| [Txt]  |  +--------------------------------------+    |  Field: text-1 |
| [MC]   |  |                                      |    |  -----------   |
| [CB]   |  |     Worksheet Title                  |    |  Type: Text    |
| [MP]   |  |                                      |    |                |
| [DD]   |  |  1. The cat _[field]_ on the mat.   |    |  Answers:      |
| [LT]   |  |                                      |    |  [sat]      [x]|
|        |  |  2. She _[field]_ there yesterday.  |    |  [was sitting] |
| -----  |  |                                      |    |  [+ Add]       |
| [Sel]  |  |                                      |    |                |
| [Zoom] |  +--------------------------------------+    |  Case: [ ] Yes |
|        |                                              |  Points: [1]   |
| PAGES  |                                              |                |
| +----+ |              [< Page 1 of 3 >]              |  [Delete Field]|
| |  1 | |                                              |                |
| +----+ |                                              |                |
| +----+ |                                              |                |
| |  2 | |                                              |                |
| +----+ |                                              |                |
+--------+----------------------------------------------+----------------+
```

### 7.2 Component Breakdown

#### Left Panel: Tools & Pages

**Tools Section:**
| Icon | Tool | Description |
|------|------|-------------|
| [T] | Text Input | Add fill-in-the-blank field |
| [MC] | Multiple Choice | Add radio button question |
| [CB] | Checkbox | Add multi-select question |
| [MP] | Matching Pairs | Add matching exercise |
| [DD] | Drag & Drop | Add drag-and-drop exercise |
| [LT] | Long Text | Add essay/writing field |
| --- | --- | --- |
| [S] | Select | Select and move fields |
| [+/-] | Zoom | Zoom in/out controls |

**Pages Section:**
- Thumbnail grid of all pages
- Current page highlighted
- Click to navigate
- Drag to reorder
- Right-click menu: Delete, Duplicate, Add Page Before/After

#### Center: PDF Canvas

- PDF rendered at configured zoom level
- Form fields overlaid on PDF
- Click to select field
- Drag to move field
- Resize handles on selected field
- Text-flow aware snapping guides
- Real-time collaboration cursors (see Section 13)

#### Right Panel: Properties

**When no field selected:**
- Document properties (title, level, tags, etc.)
- Passing score setting
- Instructions editor

**When field selected:**
- Field type (read-only)
- Position (x, y, width, height)
- Type-specific settings:
  - Text: answers list, case sensitivity, placeholder
  - Multiple Choice: options editor, correct answer selector
  - Checkbox: options editor, correct selections
  - Matching Pairs: pairs editor
  - Drag & Drop: items and zones editor
  - Long Text: line count, min/max length
- Points value
- Delete field button

### 7.3 Toolbar Actions

| Button | Action | Description |
|--------|--------|-------------|
| Preview | Toggle preview mode | See worksheet as student would |
| Export | Export dialog | Download printable PDF or HTML |
| Share | Share dialog | Generate/copy share link |
| Save | Save changes | Manual save (auto-save also active) |

### 7.4 Context Menus

**Right-click on field:**
- Cut
- Copy
- Duplicate
- Delete
- Bring to Front / Send to Back

**Right-click on canvas:**
- Paste field
- Add Text Input
- Add Multiple Choice
- Add Checkbox
- Add Matching Pairs
- Add Drag & Drop

### 7.5 Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Ctrl/Cmd + S | Save |
| Ctrl/Cmd + Z | Undo |
| Ctrl/Cmd + Y | Redo |
| Ctrl/Cmd + C | Copy field |
| Ctrl/Cmd + V | Paste field |
| Ctrl/Cmd + D | Duplicate field |
| Delete/Backspace | Delete selected field |
| Escape | Deselect / Exit preview |
| 1-6 | Select tool (T, MC, CB, MP, DD, LT) |
| V | Select tool |
| +/- | Zoom in/out |
| Arrow keys | Nudge selected field |

### 7.6 Preview Mode

Toggle to preview mode shows:
- Fields become interactive (can fill out)
- Tools panel hidden
- Properties panel shows "Preview Mode" indicator
- Top bar shows: [Exit Preview] [Submit for Grading] [Reset]
- Simulated grading on submit
- Shows score and CEFR assessment

### 7.7 Responsive Behavior

- **Minimum width:** 1024px
- **Optimal width:** 1440px+
- Below minimum: Show warning banner "PDF Editor works best on larger screens"
- Panels can be collapsed to maximize canvas area
- No tablet/mobile editing support (view-only possible)

---

## 8. Student Experience

### 8.1 Worksheet Access

Students access worksheets via:
1. **Direct link:** `https://app.beethoven.ai/worksheet/[shareToken]`
2. **No authentication required** - public access via link

### 8.2 Student Interface

```
+------------------------------------------------------------------------+
| [Logo] Worksheet: Present Perfect Practice                    [Timer?] |
+------------------------------------------------------------------------+
|                                                                         |
|  +------------------------------------------------------------------+  |
|  |                                                                  |  |
|  |                     PDF WITH INTERACTIVE FIELDS                  |  |
|  |                                                                  |  |
|  |  Instructions: Fill in the blanks with the correct form.        |  |
|  |                                                                  |  |
|  |  1. She [_______________] here for 5 years.                     |  |
|  |                                                                  |  |
|  |  2. They [_______________] the project yet.                     |  |
|  |                                                                  |  |
|  +------------------------------------------------------------------+  |
|                                                                         |
|  [< Previous Page]           Page 1 of 2           [Next Page >]       |
|                                                                         |
|  +------------------------------------------------------------------+  |
|  | Progress: 5 of 12 fields completed                              |  |
|  +------------------------------------------------------------------+  |
|                                                                         |
|  [Download Printable PDF]                              [Submit Answers] |
|                                                                         |
+------------------------------------------------------------------------+
```

### 8.3 Field Interactions

**Text Input:**
- Click to focus
- Type answer
- Tab to next field
- Visual indicator when filled (checkmark or highlight)

**Multiple Choice:**
- Click option to select
- Only one selectable
- Selected option highlighted

**Checkbox:**
- Click to toggle check
- Multiple selectable

**Matching Pairs:**
- Click left item (highlights)
- Click right item to connect
- Line drawn between them
- Click line to remove connection

**Drag & Drop:**
- Items shown in draggable bank
- Drag to drop zones
- Visual feedback on valid drop targets
- Can drag back to bank to remove

### 8.4 Submission Flow

1. Student completes fields
2. Clicks "Submit Answers"
3. Confirmation dialog: "Are you sure? You cannot change answers after submitting."
4. On confirm: Submit to server for grading
5. Display results:

```
+------------------------------------------------------------------------+
| Results: Present Perfect Practice                                       |
+------------------------------------------------------------------------+
|                                                                         |
|  +------------------------------------------------------------------+  |
|  |                                                                  |  |
|  |     Your Score: 85%    (17 / 20 points)                         |  |
|  |                                                                  |  |
|  |     [===================----]                                    |  |
|  |                                                                  |  |
|  |     Status: PASSED                                               |  |
|  |                                                                  |  |
|  |     CEFR Assessment: B1 (Intermediate)                          |  |
|  |     "Excellent! You have intermediate English proficiency."      |  |
|  |                                                                  |  |
|  +------------------------------------------------------------------+  |
|                                                                         |
|  Detailed Results:                                                      |
|  +------------------------------------------------------------------+  |
|  | Q1: "has been working" - CORRECT                            +2  |  |
|  | Q2: "have finished" - INCORRECT (correct: "haven't finished") 0 |  |
|  | Q3: Match deadline-date - CORRECT                           +1  |  |
|  | ...                                                              |  |
|  +------------------------------------------------------------------+  |
|                                                                         |
|  [Try Another Worksheet]                              [Close]          |
|                                                                         |
+------------------------------------------------------------------------+
```

### 8.5 Printable PDF Export

When student downloads printable version:
- Text Input -> Underlined blank lines
- Multiple Choice -> Options with empty circles: (A) (B) (C) (D)
- Checkbox -> Options with empty squares
- Matching Pairs -> Two columns with "Draw a line" instruction
- Drag & Drop -> Word bank + numbered blanks
- Long Text -> Ruled lines

Footer includes:
- Worksheet title
- CEFR level badge
- Page number
- QR code linking to online version

---

## 9. Templates System

### 9.1 Built-in Templates

| Template | Description | Fields Included |
|----------|-------------|-----------------|
| Vocabulary List | Word-definition matching | Matching Pairs (10 items) |
| Grammar Exercise | Fill-in-the-blank sentences | Text Input (10 items) |
| Reading Comprehension | Text with questions | Multiple Choice (5 items) |
| Multiple Choice Quiz | Question bank | Multiple Choice (10 items) |
| Mixed Assessment | Combination of types | Text (5), MC (3), Matching (1) |
| Writing Prompt | Essay question | Long Text (1 item) |
| Cloze Test | Passage with blanks | Text Input (15 items) |
| Vocabulary Sorting | Categorize words | Drag & Drop (12 items) |

### 9.2 Template Structure

```typescript
interface PDFTemplate {
  id: string;
  name: string;
  description: string;
  thumbnail: string;           // Preview image URL
  category: "grammar" | "vocabulary" | "reading" | "writing" | "mixed";
  suggestedLevel: CEFRLevel;
  pages: {
    pageNumber: number;
    backgroundUrl?: string;    // Optional background image
    elements: {
      type: "text" | "image" | "field_placeholder";
      position: { x: number; y: number; width: number; height: number };
      content?: string;        // For text elements
      fieldType?: FormFieldType;  // For field placeholders
    }[];
  }[];
}
```

### 9.3 Save as Template

Users can save their worksheets as personal templates:

1. Click "Save as Template" in menu
2. Enter template name and description
3. Choose whether to include current field answers as defaults
4. Template saved to user's template library

```typescript
interface UserTemplate extends PDFTemplate {
  createdBy: Id<"users">;
  isPersonal: true;
  sourceWorksheetId: Id<"pdfWorksheets">;
  createdAt: number;
}
```

### 9.4 Template Gallery UI

```
+------------------------------------------------------------------------+
| Choose a Template                                          [Search...] |
+------------------------------------------------------------------------+
|                                                                         |
| System Templates                                                        |
| +------------+ +------------+ +------------+ +------------+             |
| | [Preview]  | | [Preview]  | | [Preview]  | | [Preview]  |             |
| | Vocabulary | | Grammar    | | Reading    | | MC Quiz    |             |
| | List       | | Exercise   | | Comprehn.  | |            |             |
| | A1-B1      | | A2-B2      | | B1-C1      | | A1-C2      |             |
| +------------+ +------------+ +------------+ +------------+             |
|                                                                         |
| My Templates                                                            |
| +------------+ +------------+                                           |
| | [Preview]  | | [Preview]  |                                           |
| | Business   | | Tenses     |                                           |
| | Vocab Test | | Review     |                                           |
| +------------+ +------------+                                           |
|                                                                         |
| [Start Blank]                                           [Upload PDF]   |
+------------------------------------------------------------------------+
```

---

## 10. Database Schema

### 10.1 Convex Schema Additions

```typescript
// Add to convex/schema.ts

// PDF Worksheets table
pdfWorksheets: defineTable({
  // Identity
  title: v.string(),
  description: v.optional(v.string()),
  slug: v.string(),                    // URL-friendly identifier

  // Classification
  cefrLevel: v.union(
    v.literal("A1"),
    v.literal("A2"),
    v.literal("B1"),
    v.literal("B2"),
    v.literal("C1"),
    v.literal("C2")
  ),
  category: v.union(
    v.literal("grammar"),
    v.literal("vocabulary"),
    v.literal("reading"),
    v.literal("writing"),
    v.literal("mixed")
  ),
  tags: v.optional(v.array(v.string())),

  // Content
  sourceType: v.union(
    v.literal("upload"),           // Imported PDF
    v.literal("template"),         // Created from template
    v.literal("blank")             // Created from scratch
  ),
  originalPdfStorageId: v.optional(v.id("_storage")),  // Original uploaded PDF
  processedPdfStorageId: v.optional(v.id("_storage")), // With form fields embedded
  printablePdfStorageId: v.optional(v.id("_storage")), // Print-friendly version

  // Pages data
  pageCount: v.number(),
  pages: v.array(v.object({
    pageNumber: v.number(),
    width: v.number(),             // In points (A4 = 595)
    height: v.number(),            // In points (A4 = 842)
    extractedText: v.optional(v.string()),  // OCR extracted text
    textConfidence: v.optional(v.number()), // OCR confidence 0-1
  })),

  // Form fields
  fields: v.array(v.object({
    id: v.string(),
    type: v.union(
      v.literal("text_input"),
      v.literal("multiple_choice"),
      v.literal("checkbox"),
      v.literal("matching_pairs"),
      v.literal("drag_drop"),
      v.literal("long_text")
    ),
    page: v.number(),
    position: v.object({
      x: v.number(),
      y: v.number(),
      width: v.number(),
      height: v.number(),
    }),
    config: v.any(),               // Type-specific configuration
    points: v.number(),
  })),

  // Grading settings
  passingScore: v.number(),        // Percentage (default: 70)
  timeLimit: v.optional(v.number()), // Minutes, optional
  instructions: v.optional(v.string()),

  // Sharing
  shareToken: v.string(),          // Unique token for public URL
  isPublished: v.boolean(),        // Can students access?

  // Processing status
  status: v.union(
    v.literal("processing"),       // OCR/extraction in progress
    v.literal("draft"),            // Editable, not published
    v.literal("published"),        // Live, accessible to students
    v.literal("archived")          // Hidden from listings
  ),
  processingError: v.optional(v.string()),

  // Collaboration
  collaborators: v.optional(v.array(v.object({
    oderId: v.id("users"),
    cursor: v.optional(v.object({
      x: v.number(),
      y: v.number(),
      page: v.number(),
    })),
    selectedFieldId: v.optional(v.string()),
    lastActiveAt: v.number(),
  }))),

  // Metadata
  createdBy: v.id("users"),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_share_token", ["shareToken"])
  .index("by_creator", ["createdBy"])
  .index("by_status", ["status"])
  .index("by_level", ["cefrLevel"])
  .index("by_category", ["category"]),

// PDF Worksheet Analytics (anonymous aggregation)
pdfWorksheetAnalytics: defineTable({
  worksheetId: v.id("pdfWorksheets"),

  // Aggregate metrics
  totalSubmissions: v.number(),
  totalDownloads: v.number(),
  averageScore: v.number(),
  passRate: v.number(),            // Percentage who passed
  averageTimeSeconds: v.optional(v.number()),

  // Per-field analytics
  fieldAnalytics: v.array(v.object({
    fieldId: v.string(),
    correctRate: v.number(),       // Percentage correct
    averagePoints: v.number(),
    commonWrongAnswers: v.array(v.object({
      answer: v.string(),
      count: v.number(),
    })),
  })),

  // Score distribution
  scoreDistribution: v.object({
    range0to20: v.number(),
    range21to40: v.number(),
    range41to60: v.number(),
    range61to80: v.number(),
    range81to100: v.number(),
  }),

  updatedAt: v.number(),
})
  .index("by_worksheet", ["worksheetId"]),

// User Templates (personal saved templates)
pdfUserTemplates: defineTable({
  name: v.string(),
  description: v.optional(v.string()),
  thumbnail: v.optional(v.id("_storage")),

  // Source
  sourceWorksheetId: v.id("pdfWorksheets"),

  // Template content (snapshot of worksheet structure)
  cefrLevel: v.union(
    v.literal("A1"),
    v.literal("A2"),
    v.literal("B1"),
    v.literal("B2"),
    v.literal("C1"),
    v.literal("C2")
  ),
  category: v.string(),
  pageCount: v.number(),
  fieldCount: v.number(),

  // Ownership
  createdBy: v.id("users"),
  createdAt: v.number(),
})
  .index("by_creator", ["createdBy"]),
```

### 10.2 Type Definitions

```typescript
// types/pdf-editor.ts

export type CEFRLevel = "A1" | "A2" | "B1" | "B2" | "C1" | "C2";

export type WorksheetCategory =
  | "grammar"
  | "vocabulary"
  | "reading"
  | "writing"
  | "mixed";

export type FormFieldType =
  | "text_input"
  | "multiple_choice"
  | "checkbox"
  | "matching_pairs"
  | "drag_drop"
  | "long_text";

export type WorksheetStatus =
  | "processing"
  | "draft"
  | "published"
  | "archived";

// Field configurations
export interface TextInputConfig {
  placeholder?: string;
  correctAnswers: string[];
  caseSensitive: boolean;
  trimWhitespace: boolean;
}

export interface MultipleChoiceConfig {
  question?: string;
  options: {
    id: string;
    text: string;
    isCorrect: boolean;
  }[];
  layout: "vertical" | "horizontal" | "grid";
}

export interface CheckboxConfig {
  question?: string;
  options: {
    id: string;
    text: string;
    shouldBeChecked: boolean;
  }[];
  layout: "vertical" | "horizontal";
  scoringMode: "all_or_nothing" | "partial";
}

export interface MatchingPairsConfig {
  instructions?: string;
  pairs: {
    id: string;
    left: string;
    right: string;
  }[];
  shuffleRight: boolean;
}

export interface DragDropConfig {
  instructions?: string;
  items: {
    id: string;
    text: string;
    correctZone: string;
  }[];
  zones: {
    id: string;
    label: string;
    position: { x: number; y: number; width: number; height: number };
  }[];
}

export interface LongTextConfig {
  prompt?: string;
  minLength?: number;
  maxLength?: number;
  lineCount: number;
}

export type FieldConfig =
  | TextInputConfig
  | MultipleChoiceConfig
  | CheckboxConfig
  | MatchingPairsConfig
  | DragDropConfig
  | LongTextConfig;

// Grading types
export interface GradingResult {
  totalPoints: number;
  earnedPoints: number;
  percentage: number;
  passed: boolean;
  cefrAssessment: {
    level: CEFRLevel;
    confidence: "low" | "medium" | "high";
    message: string;
  };
  fieldResults: FieldGradingResult[];
  submittedAt: number;
}

export interface FieldGradingResult {
  fieldId: string;
  fieldType: FormFieldType;
  correct: boolean;
  earnedPoints: number;
  maxPoints: number;
  studentAnswer: any;
  correctAnswers?: any;
  feedback?: string;
}
```

---

## 11. API Specification

### 11.1 Convex Queries

```typescript
// convex/pdfWorksheets.ts

// Get all worksheets (with filters)
export const listWorksheets = query({
  args: {
    status: v.optional(v.string()),
    cefrLevel: v.optional(v.string()),
    category: v.optional(v.string()),
    createdBy: v.optional(v.id("users")),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Get single worksheet by ID
export const getWorksheet = query({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => { /* ... */ }
});

// Get worksheet by share token (public access)
export const getWorksheetByShareToken = query({
  args: { shareToken: v.string() },
  handler: async (ctx, args) => { /* ... */ }
});

// Get worksheet analytics
export const getWorksheetAnalytics = query({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => { /* ... */ }
});

// Get user's templates
export const getUserTemplates = query({
  args: {},
  handler: async (ctx, args) => { /* ... */ }
});

// Get system templates
export const getSystemTemplates = query({
  args: {},
  handler: async (ctx, args) => { /* ... */ }
});
```

### 11.2 Convex Mutations

```typescript
// convex/pdfWorksheets.ts

// Create new worksheet (from upload, template, or blank)
export const createWorksheet = mutation({
  args: {
    title: v.string(),
    sourceType: v.string(),
    templateId: v.optional(v.string()),
    cefrLevel: v.string(),
    category: v.string(),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Update worksheet metadata
export const updateWorksheet = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    updates: v.object({
      title: v.optional(v.string()),
      description: v.optional(v.string()),
      cefrLevel: v.optional(v.string()),
      category: v.optional(v.string()),
      tags: v.optional(v.array(v.string())),
      passingScore: v.optional(v.number()),
      timeLimit: v.optional(v.number()),
      instructions: v.optional(v.string()),
    }),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Add/update form field
export const upsertField = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    field: v.object({
      id: v.string(),
      type: v.string(),
      page: v.number(),
      position: v.object({
        x: v.number(),
        y: v.number(),
        width: v.number(),
        height: v.number(),
      }),
      config: v.any(),
      points: v.number(),
    }),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Delete form field
export const deleteField = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    fieldId: v.string(),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Publish worksheet
export const publishWorksheet = mutation({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => { /* ... */ }
});

// Archive worksheet
export const archiveWorksheet = mutation({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => { /* ... */ }
});

// Delete worksheet
export const deleteWorksheet = mutation({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => { /* ... */ }
});

// Grade submission (anonymous)
export const gradeSubmission = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    answers: v.array(v.object({
      fieldId: v.string(),
      answer: v.any(),
    })),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Save as template
export const saveAsTemplate = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    name: v.string(),
    description: v.optional(v.string()),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Update collaborator presence
export const updatePresence = mutation({
  args: {
    worksheetId: v.id("pdfWorksheets"),
    cursor: v.optional(v.object({
      x: v.number(),
      y: v.number(),
      page: v.number(),
    })),
    selectedFieldId: v.optional(v.string()),
  },
  handler: async (ctx, args) => { /* ... */ }
});

// Generate upload URL for PDF
export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx, args) => { /* ... */ }
});
```

### 11.3 HTTP API Routes

```typescript
// app/api/pdf-editor/upload/route.ts
// POST - Upload PDF for processing
// Returns: { worksheetId, status: "processing" }

// app/api/pdf-editor/process/route.ts
// POST - Process uploaded PDF (OCR, AI cleaning)
// Body: { worksheetId }
// Returns: { status, pages, extractedText }

// app/api/pdf-editor/export/route.ts
// POST - Export worksheet as printable PDF
// Body: { worksheetId, format: "printable" | "fillable" }
// Returns: PDF file download

// app/api/pdf-editor/export-html/route.ts
// POST - Export as standalone HTML (offline)
// Body: { worksheetId }
// Returns: HTML file download
```

### 11.4 Real-time Subscriptions

```typescript
// Convex subscriptions for real-time collaboration

// Subscribe to worksheet changes
export const subscribeToWorksheet = query({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => {
    // Returns full worksheet data
    // Convex automatically pushes updates
  }
});

// Subscribe to collaborator presence
export const subscribeToPresence = query({
  args: { worksheetId: v.id("pdfWorksheets") },
  handler: async (ctx, args) => {
    // Returns collaborators array with cursor positions
  }
});
```

---

## 12. Technical Architecture

### 12.1 PDF Rendering Approach

**Recommendation: PDF.js + Server-side Hybrid**

This approach balances cost, flexibility, and feature richness:

```
┌─────────────────────────────────────────────────────────────────┐
│                        CLIENT (Browser)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │   PDF.js        │    │  React Canvas   │                     │
│  │   (Rendering)   │    │  (Form Fields)  │                     │
│  └────────┬────────┘    └────────┬────────┘                     │
│           │                      │                               │
│           └──────────┬───────────┘                               │
│                      │                                           │
│              ┌───────┴───────┐                                   │
│              │  Overlay      │                                   │
│              │  Manager      │                                   │
│              └───────────────┘                                   │
│                                                                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           │ API Calls
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        SERVER (Next.js)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │  PDF Processing │    │  Puppeteer      │                     │
│  │  (pdf-lib)      │    │  (Export)       │                     │
│  └─────────────────┘    └─────────────────┘                     │
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │  OCR Service    │    │  Gemini AI      │                     │
│  │  (Tesseract)    │    │  (Text Clean)   │                     │
│  └─────────────────┘    └─────────────────┘                     │
│                                                                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           │ Database
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        CONVEX                                    │
├─────────────────────────────────────────────────────────────────┤
│  pdfWorksheets | pdfWorksheetAnalytics | pdfUserTemplates       │
│  _storage (PDF files)                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 12.2 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| PDF Rendering | PDF.js (Mozilla) | Free, battle-tested, React-friendly |
| Form Field Overlay | React + Konva.js | Performant canvas manipulation |
| PDF Manipulation | pdf-lib | Create/modify PDFs server-side |
| OCR | Tesseract.js + Gemini | Tesseract for extraction, Gemini for cleanup |
| Export to PDF | Puppeteer | Consistent, high-quality PDF generation |
| Real-time | Convex subscriptions | Built-in, no additional infrastructure |
| State Management | Zustand + Convex | Local UI state + persisted state |

### 12.3 Component Architecture

```
src/
├── app/
│   └── (dashboard)/
│       └── admin/
│           └── tools/
│               ├── page.tsx              # Tools landing
│               ├── layout.tsx            # Shared tools layout
│               ├── games/                # Existing games (moved)
│               │   └── ...
│               └── pdf-editor/
│                   ├── page.tsx          # Worksheet list
│                   ├── create/
│                   │   └── page.tsx      # Create new
│                   └── [id]/
│                       ├── edit/
│                       │   └── page.tsx  # Editor
│                       └── preview/
│                           └── page.tsx  # Preview mode
├── components/
│   └── pdf-editor/
│       ├── PDFEditor.tsx                 # Main editor component
│       ├── PDFCanvas.tsx                 # PDF rendering + overlay
│       ├── ToolsPanel.tsx                # Left panel
│       ├── PropertiesPanel.tsx           # Right panel
│       ├── PageNavigator.tsx             # Thumbnail sidebar
│       ├── fields/
│       │   ├── TextInputField.tsx
│       │   ├── MultipleChoiceField.tsx
│       │   ├── CheckboxField.tsx
│       │   ├── MatchingPairsField.tsx
│       │   ├── DragDropField.tsx
│       │   └── LongTextField.tsx
│       ├── FieldPropertiesEditor.tsx     # Field config UI
│       ├── CollaboratorCursors.tsx       # Real-time cursors
│       ├── TemplateGallery.tsx           # Template selection
│       └── WorksheetResults.tsx          # Grading display
├── hooks/
│   └── pdf-editor/
│       ├── usePDFEditor.ts               # Main editor state
│       ├── useFieldManagement.ts         # Field CRUD
│       ├── useCollaboration.ts           # Real-time presence
│       └── useGrading.ts                 # Grading logic
├── lib/
│   └── pdf-editor/
│       ├── grading.ts                    # Grading algorithms
│       ├── export.ts                     # PDF export utilities
│       ├── ocr.ts                        # OCR processing
│       └── templates.ts                  # Template definitions
└── types/
    └── pdf-editor.ts                     # TypeScript types
```

### 12.4 State Management

```typescript
// hooks/pdf-editor/usePDFEditor.ts

interface PDFEditorState {
  // Document state
  worksheet: PDFWorksheet | null;
  pages: PDFPage[];
  fields: FormField[];

  // UI state
  currentPage: number;
  selectedFieldId: string | null;
  zoom: number;
  tool: EditorTool;
  isPreviewMode: boolean;

  // Collaboration
  collaborators: Collaborator[];
  myPresence: PresenceData;

  // Undo/redo
  history: HistoryEntry[];
  historyIndex: number;

  // Actions
  selectField: (fieldId: string | null) => void;
  addField: (field: FormField) => void;
  updateField: (fieldId: string, updates: Partial<FormField>) => void;
  deleteField: (fieldId: string) => void;
  setPage: (page: number) => void;
  setZoom: (zoom: number) => void;
  setTool: (tool: EditorTool) => void;
  togglePreview: () => void;
  undo: () => void;
  redo: () => void;
  save: () => Promise<void>;
}
```

### 12.5 PDF Processing Pipeline

```typescript
// lib/pdf-editor/processing.ts

async function processPDF(file: File): Promise<ProcessedPDF> {
  // 1. Upload to Convex storage
  const storageId = await uploadToStorage(file);

  // 2. Extract pages as images (for display)
  const pageImages = await extractPageImages(storageId);

  // 3. Run OCR on each page
  const ocrResults = await Promise.all(
    pageImages.map(page => runOCR(page))
  );

  // 4. Clean up OCR with Gemini
  const cleanedText = await Promise.all(
    ocrResults.map(result => cleanWithGemini(result))
  );

  // 5. Build page structure
  const pages = pageImages.map((image, i) => ({
    pageNumber: i + 1,
    imageUrl: image.url,
    width: image.width,
    height: image.height,
    extractedText: cleanedText[i].text,
    textConfidence: cleanedText[i].confidence,
    textRegions: cleanedText[i].regions,
  }));

  return { storageId, pages };
}
```

---

## 13. Real-time Collaboration

### 13.1 Collaboration Model

**Field-level locking with presence indicators:**

- Each user has a visible cursor on the canvas
- Cursor shows user name/avatar
- Selected field highlighted with user's color
- Field being edited is locked for others
- Changes sync immediately via Convex

### 13.2 Presence Data Structure

```typescript
interface Collaborator {
  userId: Id<"users">;
  userName: string;
  userAvatar?: string;
  color: string;              // Assigned collaborator color
  cursor?: {
    x: number;
    y: number;
    page: number;
  };
  selectedFieldId?: string;
  isEditing: boolean;         // Currently typing/editing
  lastActiveAt: number;
}
```

### 13.3 Conflict Resolution

```typescript
// Field locking logic
function canEditField(fieldId: string, userId: Id<"users">, collaborators: Collaborator[]): boolean {
  const fieldEditor = collaborators.find(
    c => c.selectedFieldId === fieldId && c.isEditing && c.userId !== userId
  );
  return !fieldEditor;  // Can edit if no one else is editing
}

// Optimistic updates with rollback
async function updateFieldWithLock(
  worksheetId: Id<"pdfWorksheets">,
  fieldId: string,
  updates: Partial<FormField>
): Promise<void> {
  // 1. Acquire lock (set isEditing = true)
  await updatePresence({ selectedFieldId: fieldId, isEditing: true });

  try {
    // 2. Apply update
    await updateField(worksheetId, fieldId, updates);
  } finally {
    // 3. Release lock
    await updatePresence({ isEditing: false });
  }
}
```

### 13.4 Visual Indicators

```
+--------------------------------------------------+
|                                                  |
|  Field 1 (being edited by Alice)                 |
|  +--------------------------------------------+  |
|  | [Alice's cursor]  "has been" |             |  |  <- Alice's color border
|  +--------------------------------------------+  |     Locked icon shown
|                                                  |
|  Field 2 (available)                             |
|  +--------------------------------------------+  |
|  | _________________                          |  |  <- Normal border
|  +--------------------------------------------+  |
|                                                  |
|  [Bob's cursor hovering here]                    |  <- Bob's color cursor
|                                                  |
+--------------------------------------------------+

Collaborators: [Alice (editing)] [Bob (viewing)]
```

### 13.5 Inactive User Handling

- Users inactive for 30 seconds: cursor fades to 50% opacity
- Users inactive for 2 minutes: removed from collaborators list
- Heartbeat every 10 seconds to maintain presence
- On disconnect: immediate removal from collaborators

---

## 14. Security & Access Control

### 14.1 Role-Based Access

| Action | Admin | Moderator | Student | Anonymous |
|--------|-------|-----------|---------|-----------|
| View worksheet list | Yes | Yes | No | No |
| Create worksheet | Yes | Yes | No | No |
| Edit worksheet | Yes | Yes | No | No |
| Delete worksheet | Yes | Yes | No | No |
| Publish worksheet | Yes | Yes | No | No |
| Access via share link | Yes | Yes | Yes | Yes |
| Submit answers | Yes | Yes | Yes | Yes |
| View analytics | Yes | Yes | No | No |
| Save as template | Yes | Yes | No | No |

### 14.2 Share Link Security

- Share tokens are 16-character random strings
- Tokens are not sequential or guessable
- Links work without authentication
- No rate limiting on submissions (anonymous aggregation only)
- Share links can be regenerated (invalidates old link)

```typescript
function generateShareToken(): string {
  return crypto.randomBytes(12).toString('base64url');
  // Example: "Xt7Kp2Mn9Qw4Yz3A"
}
```

### 14.3 Content Security

- PDFs stored in Convex file storage (encrypted at rest)
- No sensitive student data stored (anonymous aggregation)
- Uploaded PDFs scanned for malware (basic validation)
- Maximum file size: 50MB
- Maximum pages: 100

### 14.4 Input Validation

```typescript
// Validate worksheet creation
const createWorksheetSchema = z.object({
  title: z.string().min(1).max(200),
  description: z.string().max(1000).optional(),
  cefrLevel: z.enum(["A1", "A2", "B1", "B2", "C1", "C2"]),
  category: z.enum(["grammar", "vocabulary", "reading", "writing", "mixed"]),
  tags: z.array(z.string().max(50)).max(20).optional(),
  passingScore: z.number().min(0).max(100).default(70),
  timeLimit: z.number().min(1).max(180).optional(),
});

// Validate field configuration
const fieldSchema = z.object({
  id: z.string().uuid(),
  type: z.enum(["text_input", "multiple_choice", "checkbox", "matching_pairs", "drag_drop", "long_text"]),
  page: z.number().int().min(1),
  position: z.object({
    x: z.number().min(0).max(100),
    y: z.number().min(0).max(100),
    width: z.number().min(1).max(100),
    height: z.number().min(1).max(100),
  }),
  config: z.any(),  // Type-specific validation
  points: z.number().min(0).max(100),
});
```

---

## 15. Error Handling

### 15.1 Error Scenarios

| Scenario | Detection | User Experience | Technical Response |
|----------|-----------|-----------------|-------------------|
| PDF upload fails | HTTP error | "Upload failed. Please try again." | Retry with exponential backoff |
| OCR processing fails | Processing timeout | "Text extraction failed. Using image-only mode." | Fall back to overlay-only |
| Gemini AI unavailable | API error | Continue with raw OCR text | Log error, use raw text |
| Save conflict | Version mismatch | "Someone else modified this. Refresh to see changes." | Show diff, offer merge |
| Field locked by another user | Lock check | "This field is being edited by [Name]." | Show lock indicator |
| Network disconnect | WebSocket close | "Connection lost. Reconnecting..." | Auto-reconnect, queue changes |
| Large PDF (>50MB) | Size check | "File too large. Maximum size is 50MB." | Reject upload |
| Too many pages (>100) | Page count | "PDF has too many pages. Maximum is 100." | Reject upload |
| Invalid PDF format | Parse error | "This file doesn't appear to be a valid PDF." | Reject upload |
| Share link not found | 404 | "This worksheet is no longer available." | Show error page |

### 15.2 Validation Errors

```typescript
// Field validation errors shown inline
interface FieldValidationError {
  fieldId: string;
  errors: {
    path: string;      // e.g., "config.correctAnswers"
    message: string;   // e.g., "At least one correct answer required"
  }[];
}

// Example validation error display
/*
+------------------------------------------+
| Text Input Field                          |
+------------------------------------------+
| Correct Answers:                          |
| [empty]                          [+ Add]  |
| ! At least one correct answer required    |  <- Error message
+------------------------------------------+
*/
```

### 15.3 Recovery Procedures

**Auto-save with conflict resolution:**
```typescript
async function autoSave(worksheet: PDFWorksheet): Promise<void> {
  try {
    // 1. Get current server version
    const serverVersion = await getWorksheetVersion(worksheet.id);

    // 2. Check for conflicts
    if (serverVersion > worksheet.localVersion) {
      // Conflict detected
      const serverWorksheet = await getWorksheet(worksheet.id);
      const mergedWorksheet = mergeChanges(worksheet, serverWorksheet);

      // Show merge UI if needed
      if (mergedWorksheet.conflicts.length > 0) {
        showConflictResolutionDialog(mergedWorksheet);
        return;
      }

      worksheet = mergedWorksheet.result;
    }

    // 3. Save with optimistic version increment
    await saveWorksheet(worksheet);

  } catch (error) {
    // Queue for retry
    queueFailedSave(worksheet);
    showToast("Changes saved locally. Will sync when connection restored.");
  }
}
```

---

## 16. Implementation Phases

### Phase 1: Foundation (Weeks 1-3)
**Goal:** Core infrastructure and basic editor

**Deliverables:**
- [ ] Navigation restructure (Tools page, routes, redirects)
- [ ] Convex schema additions (pdfWorksheets, analytics, templates)
- [ ] PDF upload and storage
- [ ] Basic PDF rendering with PDF.js
- [ ] Canvas overlay system for field placement
- [ ] Text Input field type (add, position, configure)
- [ ] Basic properties panel
- [ ] Save/load worksheet

**Exit Criteria:**
- Can upload PDF, add text input fields, save, reload
- Games page accessible at new /admin/tools/games route

### Phase 2: Field Types (Weeks 4-5)
**Goal:** Complete field type suite

**Deliverables:**
- [ ] Multiple Choice field
- [ ] Checkbox field
- [ ] Matching Pairs field (with drag-to-connect UI)
- [ ] Drag & Drop field
- [ ] Long Text field
- [ ] Field copy/paste functionality
- [ ] Undo/redo system

**Exit Criteria:**
- All 6 field types functional in editor
- Can copy fields between pages

### Phase 3: OCR & AI (Weeks 6-7)
**Goal:** PDF text extraction and enhancement

**Deliverables:**
- [ ] OCR processing pipeline (Tesseract.js)
- [ ] Gemini AI text cleanup integration
- [ ] Text-flow aware field positioning
- [ ] Text editing mode (edit extracted text)
- [ ] Page management (reorder, delete, add)

**Exit Criteria:**
- Upload PDF with text, edit extracted content
- Fields snap to text positions

### Phase 4: Student Experience (Weeks 8-9)
**Goal:** Student-facing worksheet completion

**Deliverables:**
- [ ] Public worksheet viewer (share link access)
- [ ] Interactive field rendering for students
- [ ] Matching pairs connection UI
- [ ] Drag & drop interaction UI
- [ ] Auto-grading engine
- [ ] Results display with CEFR assessment
- [ ] Print-friendly PDF export

**Exit Criteria:**
- Students can access, complete, and submit worksheets
- Auto-grading works for all field types
- Can download printable version

### Phase 5: Collaboration (Weeks 10-11)
**Goal:** Real-time collaborative editing

**Deliverables:**
- [ ] Presence system (cursor positions)
- [ ] Field-level locking
- [ ] Collaborator indicators
- [ ] Conflict resolution UI
- [ ] Analytics dashboard (anonymous aggregation)

**Exit Criteria:**
- Two users can edit same worksheet simultaneously
- Field locks prevent conflicts
- Analytics show submission statistics

### Phase 6: Templates & Polish (Weeks 12-13)
**Goal:** Templates and production readiness

**Deliverables:**
- [ ] 8 built-in templates
- [ ] Save as template functionality
- [ ] Template gallery UI
- [ ] Keyboard shortcuts
- [ ] Preview mode
- [ ] Performance optimization
- [ ] Error handling refinement
- [ ] Accessibility improvements

**Exit Criteria:**
- Templates available and functional
- Editor feels polished and professional
- All error cases handled gracefully

### MVP Definition

For a quality-first MVP (Phases 1-4, approximately 9 weeks):

**Included:**
- Full navigation restructure
- All 6 field types
- OCR with AI cleanup
- Student worksheet completion
- Auto-grading with CEFR assessment
- Print-friendly export
- Single-user editing

**Deferred to Phase 2:**
- Real-time collaboration
- Templates system
- Analytics dashboard

---

## 17. Success Metrics

### 17.1 Adoption Metrics

| Metric | Target | Measurement Period |
|--------|--------|-------------------|
| Worksheets created | 50+ | First 30 days |
| Active worksheet creators | 10+ admins/moderators | First 30 days |
| Worksheet completions | 500+ | First 30 days |

### 17.2 Quality Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Editor load time | < 3 seconds | P95 latency |
| PDF processing time | < 30 seconds | P95 latency |
| Auto-grade accuracy | > 99% | Correct grading / total |
| Save success rate | > 99.5% | Successful saves / attempts |

### 17.3 Engagement Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Avg. fields per worksheet | 10+ | Mean across worksheets |
| Completion rate | > 70% | Completions / starts |
| Print downloads | 20% of views | Downloads / worksheet views |

### 17.4 Business Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Time to create worksheet | < 15 minutes | Avg. creation time |
| Client evaluation efficiency | 50% faster | vs. manual assessment |

---

## 18. Decisions Log

| # | Decision | Options Considered | Choice | Rationale |
|---|----------|-------------------|--------|-----------|
| 1 | PDF workflow | Upload only vs Template only vs Hybrid | Hybrid | Maximum flexibility for users |
| 2 | Field types | Basic (text only) vs Full suite | Full suite (6 types) | Comprehensive assessment needs |
| 3 | Answer matching | Single answer vs Multiple acceptable | Multiple acceptable | Language learning requires flexibility |
| 4 | Print conversion | Digital-only vs Print-friendly | Print-friendly | Offline use important for classrooms |
| 5 | Storage model | Separated (PDF + overlay) vs Single document | Single document | Simpler mental model for users |
| 6 | Editor layout | Canvas-centric vs Panel-based | Panel-based (Adobe style) | Professional feel, familiar UX |
| 7 | Field placement | Snap-to-grid vs Text-flow aware | Text-flow aware | Better for language worksheets |
| 8 | Student responses | Individual tracking vs Anonymous | Anonymous aggregation | Privacy, simplicity |
| 9 | Collaboration | Single-user vs Real-time | Real-time with field locking | Team workflow support |
| 10 | PDF rendering | Commercial SDK vs PDF.js hybrid | PDF.js + server hybrid | Cost-effective, sufficient features |
| 11 | OCR enhancement | Raw OCR vs AI cleanup | AI cleanup (Gemini) | Higher quality extracted text |
| 12 | Offline support | Full offline vs Export only | Export for offline | Simpler, meets use case |
| 13 | Navigation | Tabs vs Sub-routes | Sub-routes | Better URL structure, bookmarkable |
| 14 | URL migration | Hard change vs Redirect | 301 Redirect | Preserve existing bookmarks |
| 15 | CEFR assessment | Dynamic vs Per-PDF level | Per-PDF level | Simpler, admin-controlled |
| 16 | Access control | Role-based | Admin + Moderator | Existing role system |
| 17 | Share links | Authenticated vs Public | Public (anyone with link) | Easy distribution |
| 18 | Templates | None vs Basic vs Extensive | Basic (5-10 templates) | Good starting point |
| 19 | Subscription limits | Tiered vs Equal access | Equal access (all tiers) | Universal tool benefit |
| 20 | Storage limits | Limited vs Unlimited | Unlimited | Remove friction |

---

## 19. Out of Scope

The following are explicitly **not included** in this specification:

1. **Integration with lessons/avatars** - PDF worksheets are standalone assessment tools
2. **Individual student response tracking** - Only anonymous aggregation stored
3. **Mobile/tablet editor** - Desktop/browser only for editing
4. **Bidirectional game conversion** - PDFs and word games remain separate
5. **AI-generated templates** - Only pre-built and user-saved templates
6. **DRM/watermarking** - No content protection features
7. **Marketplace/template sharing** - Personal templates only
8. **Offline editing** - Online-only editor; export for offline viewing
9. **Voice/audio fields** - No pronunciation or listening exercises in PDFs
10. **Handwriting recognition** - Print worksheets require manual grading
11. **LMS integration** - No SCORM, xAPI, or LTI support
12. **Batch import** - One PDF at a time
13. **Version history** - No previous version restoration
14. **Comments/annotations** - No review workflow

---

## 20. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | Should OCR processing be async with webhooks or synchronous with timeout? | UX | Recommend async with progress indicator |
| 2 | Maximum concurrent collaborators per worksheet? | Performance | Recommend limit of 5 |
| 3 | Should share links have expiration option? | Feature | Recommend optional expiration |
| 4 | How to handle very large PDFs (near 50MB limit)? | Performance | Recommend chunked upload |
| 5 | Should analytics show historical trends or just current aggregates? | Feature | Start with current, add trends later |

---

## Appendix A: System Templates

### A.1 Vocabulary List Template

```yaml
name: "Vocabulary List"
description: "Match words with definitions"
suggestedLevel: A1-B1
pages: 1
defaultFields:
  - type: matching_pairs
    pairs: 10
    layout: two-column
```

### A.2 Grammar Exercise Template

```yaml
name: "Grammar Exercise"
description: "Fill-in-the-blank sentences"
suggestedLevel: A2-B2
pages: 1
defaultFields:
  - type: text_input
    count: 10
    layout: numbered-list
```

### A.3 Reading Comprehension Template

```yaml
name: "Reading Comprehension"
description: "Text passage with questions"
suggestedLevel: B1-C1
pages: 2
defaultFields:
  - page: 1
    type: long_text (passage placeholder)
  - page: 2
    type: multiple_choice
    count: 5
```

### A.4 Multiple Choice Quiz Template

```yaml
name: "Multiple Choice Quiz"
description: "Question bank with options"
suggestedLevel: A1-C2
pages: 2
defaultFields:
  - type: multiple_choice
    count: 10
    optionsPerQuestion: 4
```

---

## Appendix B: Grading Examples

### B.1 Text Input Grading

```typescript
// Student answer: "has been"
// Correct answers: ["has been", "have been", "'s been"]
// Case sensitive: false
// Result: CORRECT (matches first answer)

// Student answer: "Has Been"
// Correct answers: ["has been", "have been", "'s been"]
// Case sensitive: false
// Result: CORRECT (case-insensitive match)

// Student answer: "was been"
// Correct answers: ["has been", "have been", "'s been"]
// Result: INCORRECT
```

### B.2 Checkbox Grading (Partial Scoring)

```typescript
// Options: [A, B, C, D]
// Correct: [A, C]
// Student selected: [A, B, C]
// Scoring mode: partial
// Max points: 4

// Calculation:
// A: correct (+1)
// B: incorrect (-0, no negative)
// C: correct (+1)
// D: correct (not selected, +1)
// Score: 3/4 = 75% = 3 points
```

### B.3 Matching Pairs Grading

```typescript
// Pairs:
// 1-A (purchase - to buy)
// 2-B (deadline - final date)
// 3-C (negotiate - discuss)

// Student matches:
// 1-A (correct)
// 2-C (incorrect)
// 3-B (incorrect)

// Points per pair: 2
// Score: 1 * 2 = 2 points (out of 6)
```

---

*End of Specification*

*Document Version: 1.0*
*Last Updated: 2026-01-03*
*Author: Deep Requirements Orchestrator*
*Interview Rounds: 7*
