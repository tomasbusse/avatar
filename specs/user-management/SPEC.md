# User Management System Specification

> Generated by Spec Agent
> Date: 2026-01-04
> Platform: Beethoven (Emma AI Platform)
> Version: 2.0.0

---

## Executive Summary

This specification defines a comprehensive user management system for the Beethoven AI language learning platform. The system introduces organizational hierarchy (Companies and Groups), **Role-Based Access Control (RBAC)** with granular permissions, course management, and enrollment systems to support B2B deployments while maintaining the existing B2C student experience.

**Key Features:**
- Companies (organizations) with Groups (classes/teams)
- **Comprehensive RBAC with 6 system roles and custom company roles**
- **Granular permission system with scoped access control**
- Course hierarchy with optional Modules and Learning Paths
- Role-based dashboards (Admin vs Student)
- Group-based course assignments
- Student-Avatar assignment relationships
- Progress tracking at individual and group levels

---

## Table of Contents

1. [Problem & Context](#1-problem--context)
2. [Users & Roles](#2-users--roles)
3. [Role-Based Access Control (RBAC)](#3-role-based-access-control-rbac)
4. [Organizational Structure](#4-organizational-structure)
5. [Course Hierarchy](#5-course-hierarchy)
6. [Enrollment & Assignment System](#6-enrollment--assignment-system)
7. [Data Models](#7-data-models)
8. [Convex Schema Additions](#8-convex-schema-additions)
9. [User Flows](#9-user-flows)
10. [Admin Dashboard](#10-admin-dashboard)
11. [Student Dashboard](#11-student-dashboard)
12. [API & Mutation Requirements](#12-api--mutation-requirements)
13. [Edge Cases & Error Handling](#13-edge-cases--error-handling)
14. [Security & Authorization](#14-security--authorization)
15. [Implementation Phases](#15-implementation-phases)
16. [Decisions Log](#16-decisions-log)
17. [Out of Scope](#17-out-of-scope)
18. [Open Questions](#18-open-questions)

---

## 1. Problem & Context

### 1.1 Problem Statement

The Beethoven platform currently supports individual students with direct relationships to avatars and lessons. However, to support B2B use cases (language schools, corporate training, educational institutions), the platform needs:

- Organizational hierarchy to manage multiple students
- **Role-based access control (RBAC) with granular permissions**
- Group-based content assignment (assign a course to "Marketing Team" or "Beginner Class")
- Admin capabilities to create and manage content, users, and assignments
- Clear separation between admin (content creation) and student (learning) experiences
- Progress tracking at both individual and group levels
- **Multi-level authorization (platform-level, company-level, group-level)**

### 1.2 Solution Overview

A user management system that introduces:
- **Companies**: Top-level organizational containers (schools, businesses)
- **Groups**: Sub-containers within companies (classes, teams, departments)
- **System Roles**: Platform-wide roles (Super Admin, Student, Guest)
- **Company Roles**: Organization-specific roles (Company Admin, Teacher, Group Lead)
- **Granular Permissions**: Fine-grained access control for all resources
- **Courses**: Collections of lessons with optional module structure
- **Learning Paths**: Sequences of courses for long-term progression
- **Enrollments**: Relationships connecting students to courses/groups
- **Role-based Dashboards**: Distinct experiences based on permissions

### 1.3 Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Admin content creation time | < 10 min per course | Average time to create course with 5 lessons |
| Student course discovery | < 3 clicks | Clicks from dashboard to starting a lesson |
| Group assignment efficiency | < 2 min per group | Time to assign course to group |
| Student onboarding completion | > 90% | Students who complete first lesson after signup |
| Permission check latency | < 10ms | Average time to verify user permissions |
| Role assignment accuracy | 100% | No unauthorized access incidents |

---

## 2. Users & Roles

### 2.1 System Role Definitions

The platform implements a hierarchical role system with both **system-level** and **company-level** roles.

#### 2.1.1 System Roles (Platform-Wide)

| Role | Description | Scope |
|------|-------------|-------|
| **Super Admin** | Platform administrator with full access to all resources | Global - all companies, all features |
| **Student** | Learner enrolled in courses | Personal - own progress, assigned content |
| **Guest** | Limited access user, typically trial users | Restricted - limited feature access |

#### 2.1.2 Company Roles (Organization-Scoped)

| Role | Description | Scope |
|------|-------------|-------|
| **Company Admin** | Organization administrator | Company - all groups, users, content within company |
| **Teacher / Content Creator** | Creates and manages learning content | Company - content creation, course management |
| **Group Lead** | Manages specific group(s) | Group(s) - assigned groups, view group progress |

### 2.2 Role Hierarchy Diagram

```
                    Super Admin
                         |
         +---------------+---------------+
         |                               |
    Company Admin                   [Direct Platform Access]
         |
    +----+----+
    |         |
 Teacher   Group Lead
    |         |
    +---------+
         |
      Student
         |
       Guest
```

### 2.3 Role Inheritance Matrix

Roles inherit permissions from lower-level roles in the hierarchy:

| Role | Inherits From |
|------|---------------|
| Super Admin | Company Admin, Teacher, Group Lead, Student |
| Company Admin | Teacher, Group Lead |
| Teacher | Student (for content preview) |
| Group Lead | Student (for group members) |
| Student | Guest |
| Guest | None |

### 2.4 Role Assignment Rules

1. **Super Admin**: Assigned manually by existing Super Admin only
2. **Company Admin**:
   - First user creating a company becomes Company Admin
   - Existing Company Admins can assign new Company Admins
   - Super Admin can assign/revoke
3. **Teacher**: Assigned by Company Admin or Super Admin
4. **Group Lead**: Assigned by Company Admin, Teacher, or Super Admin
5. **Student**:
   - Default role for new users
   - Auto-created when user completes onboarding
6. **Guest**:
   - Assigned to trial users
   - Limited time-bound access

---

## 3. Role-Based Access Control (RBAC)

### 3.1 Permission System Overview

The RBAC system consists of three core concepts:

1. **Permissions**: Granular access rights (e.g., `create_course`, `edit_lesson`)
2. **Roles**: Collections of permissions (e.g., Teacher = create_course + edit_lesson + ...)
3. **Role Assignments**: Linking users to roles (potentially scoped to companies/groups)

### 3.2 Permission Categories

#### 3.2.1 User Management Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `users.view_all` | View all platform users | Super Admin |
| `users.view_company` | View users in own company | Company Admin |
| `users.create` | Create new users | Super Admin, Company Admin |
| `users.edit` | Edit user profiles | Super Admin, Company Admin |
| `users.delete` | Delete/deactivate users | Super Admin, Company Admin |
| `users.assign_roles` | Assign roles to users | Super Admin, Company Admin |
| `users.impersonate` | Login as another user | Super Admin |

#### 3.2.2 Company Management Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `companies.create` | Create new companies | Super Admin |
| `companies.view_all` | View all companies | Super Admin |
| `companies.view_own` | View own company | Company Admin, Teacher, Group Lead |
| `companies.edit` | Edit company settings | Super Admin, Company Admin |
| `companies.delete` | Delete company | Super Admin |
| `companies.manage_subscription` | Manage billing/subscription | Super Admin, Company Admin |
| `companies.create_custom_roles` | Create custom roles for company | Company Admin (if tier allows) |

#### 3.2.3 Group Management Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `groups.create` | Create new groups | Company Admin, Teacher |
| `groups.view_all` | View all groups in company | Company Admin, Teacher |
| `groups.view_own` | View assigned groups | Group Lead |
| `groups.edit` | Edit group settings | Company Admin, Teacher, Group Lead (own) |
| `groups.delete` | Delete/archive groups | Company Admin |
| `groups.add_members` | Add students to groups | Company Admin, Teacher, Group Lead (own) |
| `groups.remove_members` | Remove students from groups | Company Admin, Teacher, Group Lead (own) |

#### 3.2.4 Content Management Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `courses.create` | Create new courses | Super Admin, Company Admin, Teacher |
| `courses.view_all` | View all courses | Super Admin |
| `courses.view_company` | View company courses | Company Admin, Teacher |
| `courses.view_enrolled` | View enrolled courses | Student |
| `courses.edit_own` | Edit own courses | Teacher (creator) |
| `courses.edit_all` | Edit any course | Super Admin, Company Admin |
| `courses.delete` | Delete courses | Super Admin, Company Admin |
| `courses.publish` | Publish courses | Super Admin, Company Admin, Teacher |
| `lessons.create` | Create new lessons | Super Admin, Company Admin, Teacher |
| `lessons.edit_own` | Edit own lessons | Teacher (creator) |
| `lessons.edit_all` | Edit any lesson | Super Admin, Company Admin |
| `lessons.delete` | Delete lessons | Super Admin, Company Admin |

#### 3.2.5 Enrollment & Assignment Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `enrollments.assign_group` | Assign content to groups | Company Admin, Teacher |
| `enrollments.assign_individual` | Assign content to individuals | Company Admin, Teacher |
| `enrollments.self_enroll` | Self-enroll in courses | Student (if company allows) |
| `enrollments.view_all` | View all enrollments | Super Admin, Company Admin |
| `enrollments.view_group` | View group enrollments | Teacher, Group Lead (own groups) |

#### 3.2.6 Analytics & Reporting Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `analytics.view_platform` | View platform-wide analytics | Super Admin |
| `analytics.view_company` | View company analytics | Company Admin |
| `analytics.view_group` | View group progress | Teacher, Group Lead (own groups) |
| `analytics.view_own` | View personal progress | Student |
| `reports.export` | Export analytics reports | Super Admin, Company Admin |

#### 3.2.7 Avatar & Session Permissions

| Permission | Description | Default Roles |
|------------|-------------|---------------|
| `avatars.view` | View available avatars | All authenticated |
| `avatars.create` | Create new avatars | Super Admin |
| `avatars.edit` | Edit avatar configurations | Super Admin |
| `avatars.assign` | Assign avatars to students | Company Admin, Teacher |
| `sessions.create` | Start learning sessions | Student (enrolled) |
| `sessions.view_own` | View own session history | Student |
| `sessions.view_all` | View all session data | Super Admin, Company Admin |

### 3.3 Permission Scopes

Permissions can be scoped to limit their application:

| Scope | Description | Example |
|-------|-------------|---------|
| **Global** | Applies platform-wide | Super Admin's `users.view_all` |
| **Company** | Applies within a company | Company Admin's `users.view_company` |
| **Group** | Applies within specific group(s) | Group Lead's `groups.view_own` |
| **Self** | Applies to own resources only | Student's `analytics.view_own` |
| **Created** | Applies to self-created resources | Teacher's `lessons.edit_own` |

### 3.4 Company Subscription Tiers

Companies can have different capabilities based on subscription:

| Tier | Max Users | Max Groups | Custom Roles | SSO | API Access |
|------|-----------|------------|--------------|-----|------------|
| Free | 5 | 1 | No | No | No |
| Starter | 50 | 5 | No | No | No |
| Professional | 500 | 50 | Yes (up to 5) | Yes | Read-only |
| Enterprise | Unlimited | Unlimited | Unlimited | Yes | Full |

### 3.5 Custom Company Roles

Companies on Professional or Enterprise tiers can create custom roles:

```typescript
interface CustomRole {
  id: string;
  companyId: Id<"companies">;
  name: string;
  description: string;
  permissions: string[]; // Selected from available permissions
  inheritsFrom?: string; // Base role to inherit from
  isActive: boolean;
  createdBy: Id<"users">;
  createdAt: number;
  updatedAt: number;
}
```

**Constraints:**
- Custom roles can only include permissions available to Company Admin
- Cannot grant permissions beyond company scope
- Cannot create roles that exceed Super Admin capabilities

### 3.6 Role Assignment Data Model

```typescript
interface UserRoleAssignment {
  userId: Id<"users">;
  roleId: string; // System role or custom role ID
  scope: "global" | "company" | "group";
  scopeId?: Id<"companies"> | Id<"groups">; // Required for company/group scope
  assignedBy: Id<"users">;
  assignedAt: number;
  expiresAt?: number; // For temporary role assignments
  isActive: boolean;
}
```

### 3.7 Authorization Flow

```
User Request
     |
     v
+--------------------+
| 1. Authenticate    |  (Clerk JWT verification)
+--------------------+
     |
     v
+--------------------+
| 2. Get User Roles  |  (Query user's active role assignments)
+--------------------+
     |
     v
+--------------------+
| 3. Resolve         |  (Expand inherited permissions)
|    Permissions     |
+--------------------+
     |
     v
+--------------------+
| 4. Check Scope     |  (Verify scope matches resource)
+--------------------+
     |
     v
+--------------------+
| 5. Grant/Deny      |  (Return authorization decision)
+--------------------+
```

### 3.8 Permission Check Implementation

#### 3.8.1 Middleware Authorization (Next.js)

```typescript
// middleware.ts
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

const publicRoutes = createRouteMatcher(["/", "/sign-in(.*)", "/sign-up(.*)"]);

const adminRoutes = createRouteMatcher(["/admin(.*)"]);
const teacherRoutes = createRouteMatcher(["/content(.*)", "/courses/edit(.*)"]);

export default clerkMiddleware(async (auth, req) => {
  if (publicRoutes(req)) return;

  const { userId, sessionClaims } = await auth();
  if (!userId) return auth.redirectToSignIn();

  const userRole = sessionClaims?.metadata?.role;

  if (adminRoutes(req) && !["super_admin", "company_admin"].includes(userRole)) {
    return new Response("Unauthorized", { status: 403 });
  }

  if (teacherRoutes(req) && !["super_admin", "company_admin", "teacher"].includes(userRole)) {
    return new Response("Unauthorized", { status: 403 });
  }
});
```

#### 3.8.2 Convex Function Authorization

```typescript
// convex/lib/auth.ts
import { ConvexError } from "convex/values";

type Permission = string;

interface AuthContext {
  userId: Id<"users">;
  permissions: Permission[];
  companyId?: Id<"companies">;
  groupIds?: Id<"groups">[];
}

export async function requirePermission(
  ctx: QueryCtx | MutationCtx,
  permission: Permission,
  resourceScope?: {
    type: "company" | "group" | "user";
    id: string;
  }
): Promise<AuthContext> {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) {
    throw new ConvexError({ code: "NOT_AUTHENTICATED", message: "Authentication required" });
  }

  const user = await ctx.db
    .query("users")
    .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
    .unique();

  if (!user) {
    throw new ConvexError({ code: "NOT_FOUND", message: "User not found" });
  }

  // Get all role assignments for user
  const roleAssignments = await ctx.db
    .query("userRoleAssignments")
    .withIndex("by_user", (q) => q.eq("userId", user._id))
    .filter((q) => q.eq(q.field("isActive"), true))
    .collect();

  // Resolve permissions from roles
  const permissions = await resolvePermissions(ctx, roleAssignments);

  // Check if user has required permission
  const hasPermission = permissions.includes(permission) ||
                        permissions.includes("*"); // Super admin wildcard

  if (!hasPermission) {
    throw new ConvexError({
      code: "NOT_AUTHORIZED",
      message: `Missing permission: ${permission}`
    });
  }

  // Check scope if resource-specific
  if (resourceScope) {
    const scopeValid = await validateScope(ctx, user._id, roleAssignments, resourceScope);
    if (!scopeValid) {
      throw new ConvexError({
        code: "NOT_AUTHORIZED",
        message: "Resource outside authorized scope"
      });
    }
  }

  return {
    userId: user._id,
    permissions,
    companyId: await getUserCompanyId(ctx, user._id),
    groupIds: await getUserGroupIds(ctx, user._id),
  };
}

// Helper to check permissions without throwing
export async function hasPermission(
  ctx: QueryCtx,
  userId: Id<"users">,
  permission: Permission
): Promise<boolean> {
  try {
    await requirePermission(ctx, permission);
    return true;
  } catch {
    return false;
  }
}
```

#### 3.8.3 UI Component Visibility

```typescript
// components/providers/PermissionProvider.tsx
"use client";

import { createContext, useContext, ReactNode } from "react";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

interface PermissionContextType {
  permissions: string[];
  hasPermission: (permission: string) => boolean;
  hasAnyPermission: (permissions: string[]) => boolean;
  hasAllPermissions: (permissions: string[]) => boolean;
  isLoading: boolean;
}

const PermissionContext = createContext<PermissionContextType | null>(null);

export function PermissionProvider({ children }: { children: ReactNode }) {
  const result = useQuery(api.auth.getMyPermissions);

  const permissions = result?.permissions ?? [];
  const isLoading = result === undefined;

  const hasPermission = (permission: string) =>
    permissions.includes(permission) || permissions.includes("*");

  const hasAnyPermission = (perms: string[]) =>
    perms.some((p) => hasPermission(p));

  const hasAllPermissions = (perms: string[]) =>
    perms.every((p) => hasPermission(p));

  return (
    <PermissionContext.Provider value={{
      permissions,
      hasPermission,
      hasAnyPermission,
      hasAllPermissions,
      isLoading,
    }}>
      {children}
    </PermissionContext.Provider>
  );
}

export const usePermissions = () => {
  const context = useContext(PermissionContext);
  if (!context) {
    throw new Error("usePermissions must be used within PermissionProvider");
  }
  return context;
};

// Usage in components
export function ProtectedComponent({
  permission,
  children,
  fallback = null
}: {
  permission: string;
  children: ReactNode;
  fallback?: ReactNode;
}) {
  const { hasPermission, isLoading } = usePermissions();

  if (isLoading) return null;
  if (!hasPermission(permission)) return fallback;

  return <>{children}</>;
}
```

### 3.9 Permission Matrix

Comprehensive matrix showing which roles have which permissions:

| Permission | Super Admin | Company Admin | Teacher | Group Lead | Student | Guest |
|------------|:-----------:|:-------------:|:-------:|:----------:|:-------:|:-----:|
| **User Management** |
| users.view_all | X | | | | | |
| users.view_company | X | X | | | | |
| users.create | X | X | | | | |
| users.edit | X | X | | | | |
| users.delete | X | X | | | | |
| users.assign_roles | X | X | | | | |
| users.impersonate | X | | | | | |
| **Company Management** |
| companies.create | X | | | | | |
| companies.view_all | X | | | | | |
| companies.view_own | X | X | X | X | | |
| companies.edit | X | X | | | | |
| companies.delete | X | | | | | |
| companies.manage_subscription | X | X | | | | |
| companies.create_custom_roles | X | X* | | | | |
| **Group Management** |
| groups.create | X | X | X | | | |
| groups.view_all | X | X | X | | | |
| groups.view_own | X | X | X | X | | |
| groups.edit | X | X | X | X* | | |
| groups.delete | X | X | | | | |
| groups.add_members | X | X | X | X* | | |
| groups.remove_members | X | X | X | X* | | |
| **Content Management** |
| courses.create | X | X | X | | | |
| courses.view_all | X | | | | | |
| courses.view_company | X | X | X | | | |
| courses.view_enrolled | X | X | X | X | X | |
| courses.edit_own | X | X | X | | | |
| courses.edit_all | X | X | | | | |
| courses.delete | X | X | | | | |
| courses.publish | X | X | X | | | |
| lessons.create | X | X | X | | | |
| lessons.edit_own | X | X | X | | | |
| lessons.edit_all | X | X | | | | |
| lessons.delete | X | X | | | | |
| **Enrollment & Assignment** |
| enrollments.assign_group | X | X | X | | | |
| enrollments.assign_individual | X | X | X | | | |
| enrollments.self_enroll | X | X | X | X | X* | |
| enrollments.view_all | X | X | | | | |
| enrollments.view_group | X | X | X | X | | |
| **Analytics & Reporting** |
| analytics.view_platform | X | | | | | |
| analytics.view_company | X | X | | | | |
| analytics.view_group | X | X | X | X | | |
| analytics.view_own | X | X | X | X | X | X |
| reports.export | X | X | | | | |
| **Avatar & Session** |
| avatars.view | X | X | X | X | X | X |
| avatars.create | X | | | | | |
| avatars.edit | X | | | | | |
| avatars.assign | X | X | X | | | |
| sessions.create | X | X | X | X | X | |
| sessions.view_own | X | X | X | X | X | |
| sessions.view_all | X | X | | | | |

*Notes:*
- `*` indicates scope restrictions (e.g., Group Lead can only edit own groups)
- `X*` for self_enroll requires company setting to allow self-enrollment

---

## 4. Organizational Structure

### 4.1 Company Entity

Companies represent top-level organizations such as:
- Language schools
- Corporate training departments
- Educational institutions
- Independent tutoring businesses

**Key Attributes:**
- Name, slug (URL-friendly identifier)
- Logo, primary color (branding)
- Subscription tier (for billing and feature access)
- Status (active, suspended, trial)
- Settings (default language, timezone)
- **RBAC settings (custom roles enabled, max custom roles)**

### 4.2 Group Entity

Groups are subdivisions within a company:
- Classes (e.g., "Beginner English A1", "Advanced Business English")
- Teams (e.g., "Marketing Team", "Engineering Department")
- Cohorts (e.g., "January 2026 Cohort")

**Key Attributes:**
- Name, description
- Company reference
- Default avatar (optional, inheritable)
- CEFR level target (optional)
- Capacity limit (optional)
- Status (active, archived)
- **Group leads (users with Group Lead role for this group)**

### 4.3 Hierarchy Diagram

```
Platform (Beethoven)
  |
  +-- Super Admins (full platform access)
  |
  +-- Company: "Berlin Language School"
  |     |
  |     +-- Company Admin: Hans (full company access)
  |     |
  |     +-- Teachers: Anna, Klaus (content creation)
  |     |
  |     +-- Group: "Beginner English - Morning"
  |     |     +-- Group Lead: Maria
  |     |     +-- Student: Thomas
  |     |     +-- Student: Lisa
  |     |     +-- Assigned Course: "English Foundations A1"
  |     |
  |     +-- Group: "Business English - Corporate"
  |           +-- Group Lead: Peter
  |           +-- Student: Anna (student role, different from teacher Anna)
  |           +-- Assigned Course: "Business English B1"
  |
  +-- Company: "Munich Corporate Training"
        |
        +-- Company Admin: Michael
        +-- ...
```

### 4.4 Membership Rules

1. A student can belong to multiple groups within the same company
2. A student can belong to groups in different companies (for freelancers/consultants)
3. A group can have unlimited students (unless capacity is set)
4. Groups can be archived but not deleted (preserves history)
5. When a company is suspended, all its groups become read-only
6. **A user can have different roles in different companies**
7. **Group Leads are scoped to specific groups, not company-wide**

---

## 5. Course Hierarchy

### 5.1 Flexible Structure

The course system supports both simple and complex organizational needs:

```
Option A: Flat Structure (Simple)
--------------------------------
Course
  +-- Lesson 1
  +-- Lesson 2
  +-- Lesson 3
  +-- Lesson 4
  +-- Lesson 5

Option B: Modular Structure (Complex)
-------------------------------------
Course
  +-- Module 1: "Basics"
  |     +-- Lesson 1.1
  |     +-- Lesson 1.2
  |
  +-- Module 2: "Intermediate"
  |     +-- Lesson 2.1
  |     +-- Lesson 2.2
  |     +-- Lesson 2.3
  |
  +-- Module 3: "Advanced"
        +-- Lesson 3.1
        +-- Lesson 3.2

Option C: Learning Path (Progression)
-------------------------------------
Learning Path: "Beginner to Intermediate Journey"
  +-- Course 1: "English Foundations A1"
  +-- Course 2: "Everyday Conversations A2"
  +-- Course 3: "Grammar Essentials B1"
  +-- Course 4: "Business Basics B1"
```

### 5.2 Course Entity

**Key Attributes:**
- Title (en/de), description, slug
- Cover image, accent color
- CEFR level range (e.g., A1-A2)
- Estimated duration (total hours)
- Category, tags
- Status (draft, published, archived)
- Prerequisites (other courses)
- Default avatar for course
- **Created by (user reference for edit_own permission)**
- **Company scope (null = platform-wide, id = company-specific)**

### 5.3 Module Entity (Optional)

**Key Attributes:**
- Title, description
- Course reference
- Order within course
- Unlock condition (sequential vs. unlocked)

### 5.4 Learning Path Entity

**Key Attributes:**
- Title, description, slug
- Cover image
- Target audience description
- Estimated total duration
- Ordered list of courses
- Prerequisites (other paths or courses)
- Completion certificate (future)

### 5.5 Content Ownership

| Entity | Owned By | Can Be Assigned To |
|--------|----------|-------------------|
| Lesson | System (Admin-created) | Course, Module |
| Course | System (Admin-created) | Group, Student, Learning Path |
| Learning Path | System (Admin-created) | Group, Student |

---

## 6. Enrollment & Assignment System

### 6.1 Assignment Types

| Type | Description | Example |
|------|-------------|---------|
| Group-Course | Assign a course to an entire group | "Marketing Team" gets "Business English B1" |
| Group-Path | Assign a learning path to a group | "New Hires" get "Onboarding Path" |
| Student-Course | Assign a course to individual student | Maria gets extra "Grammar Intensive" |
| Student-Avatar | Assign a specific avatar to a student | Thomas prefers "Dr. Schmidt" avatar |

### 6.2 Enrollment Resolution

When a student belongs to multiple groups with overlapping course assignments:
1. Student sees unified view of all assigned courses (deduplicated)
2. Progress is tracked once per course (not per enrollment source)
3. Analytics can be filtered by group for reporting

### 6.3 Enrollment States

```
PENDING     --> Student invited but not yet started
ACTIVE      --> Student actively enrolled, can access content
COMPLETED   --> Student finished all lessons in course
PAUSED      --> Temporarily suspended (e.g., on leave)
WITHDRAWN   --> Removed from course (preserves history)
EXPIRED     --> Time-limited enrollment ended
```

### 6.4 Progress Inheritance

```
Learning Path Progress
  |
  +-- Course 1 Progress (Completed 100%)
  |     +-- Lesson 1.1 (Completed)
  |     +-- Lesson 1.2 (Completed)
  |
  +-- Course 2 Progress (In Progress 50%)
  |     +-- Lesson 2.1 (Completed)
  |     +-- Lesson 2.2 (Not Started)
  |
  +-- Course 3 Progress (Locked - Prerequisite not met)
```

---

## 7. Data Models

### 7.1 Entity Relationship Diagram

```
                    +-------------+
                    |   Company   |
                    +------+------+
                           |
            +--------------+---------------+
            |              |               |
            v              v               v
     +------+------+ +-----+-----+  +------+------+
     |    Role     | |   Group   |  |   Course    |
     +------+------+ +-----+-----+  +------+------+
            |              |               |
            v              | N:M           | 1:N
     +------+-------+      v               v
     |  UserRole    | +----+----+    +-----+-----+
     |  Assignment  | | Member  |    |  Module   |
     +------+-------+ +----+----+    +-----+-----+
            |              |               |
            |              | N:1           | 1:N
            v              v               v
     +------+------+ +-----+-----+   +-----+-----+
     |    User     | |  Student  |   |  Lesson   |
     +------+------+ +-----+-----+   +-----------+
            |              |
            | 1:1          | N:M
            v              v
     +------+------+ +-----+-------+
     | Permission  | | Enrollment  |
     +-------------+ +-------------+
```

### 7.2 Roles Table

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | string | Yes | Unique role identifier |
| name | string | Yes | Role display name |
| description | string | No | Role description |
| type | enum | Yes | system, company_custom |
| companyId | Id<companies> | No | Company (for custom roles) |
| permissions | array<string> | Yes | List of permission keys |
| inheritsFrom | string | No | Parent role ID to inherit from |
| isActive | boolean | Yes | Whether role is active |
| createdBy | Id<users> | No | Creator (for custom roles) |
| createdAt | number | Yes | Creation timestamp |
| updatedAt | number | Yes | Last update timestamp |

### 7.3 User Role Assignments Table

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| userId | Id<users> | Yes | User reference |
| roleId | string | Yes | Role reference |
| scope | enum | Yes | global, company, group |
| scopeId | string | No | Company or Group ID for scoped roles |
| assignedBy | Id<users> | Yes | Who assigned the role |
| assignedAt | number | Yes | Assignment timestamp |
| expiresAt | number | No | Expiration timestamp (for temp roles) |
| isActive | boolean | Yes | Whether assignment is active |
| notes | string | No | Notes about assignment |

### 7.4 Permissions Table (Reference)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| key | string | Yes | Unique permission key (e.g., "courses.create") |
| name | string | Yes | Human-readable name |
| description | string | Yes | Permission description |
| category | string | Yes | Permission category |
| defaultRoles | array<string> | Yes | Roles that have this permission by default |

### 7.5 Companies (Updated)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | string | Yes | Company display name |
| slug | string | Yes | URL-friendly identifier (unique) |
| description | string | No | Company description |
| logoUrl | string | No | Company logo URL |
| primaryColor | string | No | Brand color (hex) |
| website | string | No | Company website URL |
| billingEmail | string | No | Billing contact email |
| subscriptionTier | enum | Yes | free, starter, professional, enterprise |
| subscriptionStatus | enum | Yes | active, trial, suspended, cancelled |
| trialEndsAt | number | No | Trial expiration timestamp |
| settings | object | No | Company-wide settings |
| **rbacSettings** | object | No | **RBAC configuration** |
| maxStudents | number | No | Student limit (null = unlimited) |
| maxGroups | number | No | Group limit (null = unlimited) |
| createdBy | Id<users> | Yes | Admin who created |
| createdAt | number | Yes | Creation timestamp |
| updatedAt | number | Yes | Last update timestamp |

**rbacSettings structure:**
```typescript
{
  customRolesEnabled: boolean; // Based on subscription tier
  maxCustomRoles: number; // Based on subscription tier
  allowSelfEnrollment: boolean;
  requireApprovalForNewUsers: boolean;
  defaultNewUserRole: string; // Role ID for new users
}
```

### 7.6 Groups (Updated)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| companyId | Id<companies> | Yes | Parent company |
| name | string | Yes | Group display name |
| slug | string | Yes | URL-friendly identifier (unique within company) |
| description | string | No | Group description |
| defaultAvatarId | Id<avatars> | No | Default avatar for group members |
| targetLevel | enum | No | CEFR level target (A1-C2) |
| capacity | number | No | Max members (null = unlimited) |
| status | enum | Yes | active, archived |
| **leadUserIds** | array<Id<users>> | No | **Users with Group Lead role for this group** |
| settings | object | No | Group-specific settings |
| createdBy | Id<users> | Yes | Admin who created |
| createdAt | number | Yes | Creation timestamp |
| updatedAt | number | Yes | Last update timestamp |

### 7.7 GroupMembers

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| groupId | Id<groups> | Yes | Group reference |
| studentId | Id<students> | Yes | Student reference |
| role | enum | Yes | member, lead (for peer mentoring) |
| joinedAt | number | Yes | When student joined group |
| status | enum | Yes | active, paused, removed |
| removedAt | number | No | When removed (if applicable) |
| removedReason | string | No | Reason for removal |

### 7.8 Courses (Updated)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title_en | string | Yes | English title |
| title_de | string | Yes | German title |
| slug | string | Yes | URL-friendly identifier (unique) |
| description_en | string | No | English description |
| description_de | string | No | German description |
| coverImageUrl | string | No | Course cover image |
| accentColor | string | No | Course theme color |
| levelMin | enum | Yes | Minimum CEFR level (A1-C2) |
| levelMax | enum | Yes | Maximum CEFR level (A1-C2) |
| estimatedHours | number | No | Total estimated duration |
| category | string | Yes | Primary category |
| tags | array<string> | No | Searchable tags |
| defaultAvatarId | Id<avatars> | No | Default avatar for this course |
| hasModules | boolean | Yes | Whether course uses module structure |
| prerequisiteCourseIds | array<Id<courses>> | No | Required courses before starting |
| **companyId** | Id<companies> | No | **Company scope (null = platform-wide)** |
| status | enum | Yes | draft, published, archived |
| publishedAt | number | No | When published |
| createdBy | Id<users> | Yes | Admin who created |
| createdAt | number | Yes | Creation timestamp |
| updatedAt | number | Yes | Last update timestamp |

### 7.9-7.14 (Remaining tables same as before)

*See original specification for Modules, CourseLessons, LearningPaths, GroupCourseAssignments, StudentEnrollments, StudentAvatarAssignments, and LessonProgress tables.*

---

## 8. Convex Schema Additions

```typescript
// Add to convex/schema.ts

// ============================================
// RBAC - ROLES
// ============================================

roles: defineTable({
  // Identity
  id: v.string(), // Unique identifier (e.g., "super_admin", "company_admin", "custom_role_123")
  name: v.string(),
  description: v.optional(v.string()),

  // Classification
  type: v.union(v.literal("system"), v.literal("company_custom")),
  companyId: v.optional(v.id("companies")), // For custom roles

  // Permissions
  permissions: v.array(v.string()),
  inheritsFrom: v.optional(v.string()), // Role ID to inherit from

  // Status
  isActive: v.boolean(),
  isDefault: v.optional(v.boolean()), // Default role for new users in company

  // Metadata
  createdBy: v.optional(v.id("users")),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_id", ["id"])
  .index("by_type", ["type"])
  .index("by_company", ["companyId"])
  .index("by_active", ["isActive"]),

// ============================================
// RBAC - USER ROLE ASSIGNMENTS
// ============================================

userRoleAssignments: defineTable({
  userId: v.id("users"),
  roleId: v.string(), // References roles.id

  // Scope
  scope: v.union(
    v.literal("global"),
    v.literal("company"),
    v.literal("group")
  ),
  scopeId: v.optional(v.string()), // Company or Group ID

  // Assignment metadata
  assignedBy: v.id("users"),
  assignedAt: v.number(),
  expiresAt: v.optional(v.number()),
  isActive: v.boolean(),
  notes: v.optional(v.string()),
})
  .index("by_user", ["userId"])
  .index("by_user_active", ["userId", "isActive"])
  .index("by_role", ["roleId"])
  .index("by_scope", ["scope", "scopeId"])
  .index("by_expiring", ["expiresAt"]),

// ============================================
// RBAC - PERMISSION DEFINITIONS (Reference Table)
// ============================================

permissions: defineTable({
  key: v.string(), // e.g., "courses.create"
  name: v.string(), // Human-readable name
  description: v.string(),
  category: v.union(
    v.literal("users"),
    v.literal("companies"),
    v.literal("groups"),
    v.literal("content"),
    v.literal("enrollments"),
    v.literal("analytics"),
    v.literal("avatars"),
    v.literal("sessions")
  ),
  defaultRoles: v.array(v.string()), // Role IDs that have this by default
  isActive: v.boolean(),
})
  .index("by_key", ["key"])
  .index("by_category", ["category"]),

// ============================================
// COMPANIES (Updated with RBAC settings)
// ============================================

companies: defineTable({
  name: v.string(),
  slug: v.string(),
  description: v.optional(v.string()),
  logoUrl: v.optional(v.string()),
  primaryColor: v.optional(v.string()),
  website: v.optional(v.string()),
  billingEmail: v.optional(v.string()),
  subscriptionTier: v.union(
    v.literal("free"),
    v.literal("starter"),
    v.literal("professional"),
    v.literal("enterprise")
  ),
  subscriptionStatus: v.union(
    v.literal("active"),
    v.literal("trial"),
    v.literal("suspended"),
    v.literal("cancelled")
  ),
  trialEndsAt: v.optional(v.number()),
  settings: v.optional(
    v.object({
      defaultLanguage: v.optional(v.string()),
      timezone: v.optional(v.string()),
      allowSelfEnrollment: v.optional(v.boolean()),
      requireApproval: v.optional(v.boolean()),
    })
  ),
  // RBAC Settings
  rbacSettings: v.optional(
    v.object({
      customRolesEnabled: v.boolean(),
      maxCustomRoles: v.number(),
      allowSelfEnrollment: v.boolean(),
      requireApprovalForNewUsers: v.boolean(),
      defaultNewUserRole: v.optional(v.string()),
    })
  ),
  maxStudents: v.optional(v.number()),
  maxGroups: v.optional(v.number()),
  createdBy: v.id("users"),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_status", ["subscriptionStatus"])
  .index("by_created", ["createdAt"]),

// ============================================
// GROUPS (Updated with lead users)
// ============================================

groups: defineTable({
  companyId: v.id("companies"),
  name: v.string(),
  slug: v.string(),
  description: v.optional(v.string()),
  defaultAvatarId: v.optional(v.id("avatars")),
  targetLevel: v.optional(
    v.union(
      v.literal("A1"),
      v.literal("A2"),
      v.literal("B1"),
      v.literal("B2"),
      v.literal("C1"),
      v.literal("C2")
    )
  ),
  capacity: v.optional(v.number()),
  status: v.union(v.literal("active"), v.literal("archived")),
  // Group leads (users with Group Lead role for this group)
  leadUserIds: v.optional(v.array(v.id("users"))),
  settings: v.optional(
    v.object({
      allowPeerInteraction: v.optional(v.boolean()),
      showLeaderboard: v.optional(v.boolean()),
      notifyOnProgress: v.optional(v.boolean()),
    })
  ),
  createdBy: v.id("users"),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_company", ["companyId"])
  .index("by_company_slug", ["companyId", "slug"])
  .index("by_status", ["status"])
  .index("by_created", ["createdAt"]),

// ============================================
// GROUP MEMBERS
// ============================================

groupMembers: defineTable({
  groupId: v.id("groups"),
  studentId: v.id("students"),
  role: v.union(v.literal("member"), v.literal("lead")),
  joinedAt: v.number(),
  status: v.union(
    v.literal("active"),
    v.literal("paused"),
    v.literal("removed")
  ),
  removedAt: v.optional(v.number()),
  removedReason: v.optional(v.string()),
})
  .index("by_group", ["groupId"])
  .index("by_student", ["studentId"])
  .index("by_group_student", ["groupId", "studentId"])
  .index("by_status", ["status"]),

// ============================================
// COURSES (Updated with company scope)
// ============================================

courses: defineTable({
  title_en: v.string(),
  title_de: v.string(),
  slug: v.string(),
  description_en: v.optional(v.string()),
  description_de: v.optional(v.string()),
  coverImageUrl: v.optional(v.string()),
  accentColor: v.optional(v.string()),
  levelMin: v.union(
    v.literal("A1"),
    v.literal("A2"),
    v.literal("B1"),
    v.literal("B2"),
    v.literal("C1"),
    v.literal("C2")
  ),
  levelMax: v.union(
    v.literal("A1"),
    v.literal("A2"),
    v.literal("B1"),
    v.literal("B2"),
    v.literal("C1"),
    v.literal("C2")
  ),
  estimatedHours: v.optional(v.number()),
  category: v.string(),
  tags: v.optional(v.array(v.string())),
  defaultAvatarId: v.optional(v.id("avatars")),
  hasModules: v.boolean(),
  prerequisiteCourseIds: v.optional(v.array(v.id("courses"))),
  // Company scope (null = platform-wide)
  companyId: v.optional(v.id("companies")),
  status: v.union(
    v.literal("draft"),
    v.literal("published"),
    v.literal("archived")
  ),
  publishedAt: v.optional(v.number()),
  createdBy: v.id("users"),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_status", ["status"])
  .index("by_category", ["category"])
  .index("by_level", ["levelMin"])
  .index("by_company", ["companyId"])
  .index("by_created", ["createdAt"]),

// Remaining tables (modules, courseLessons, learningPaths, etc.)
// remain the same as in original specification
// ...
```

---

## 9. User Flows

### 9.1 Role Assignment Flow (Company Admin)

```
1. Company Admin logs in
   |
   v
2. Navigate to /admin/users
   |
   v
3. Select user to manage
   |
   v
4. Click "Manage Roles"
   |
   v
5. View current roles:
   +------------------------------------------+
   | User: Maria Schmidt                       |
   | Email: maria@company.com                  |
   |                                           |
   | Current Roles:                            |
   | [x] Student (company scope)               |
   | [ ] Teacher                               |
   | [ ] Group Lead                            |
   |                                           |
   | Group Lead Assignments:                   |
   | [ ] Beginner English - Morning            |
   | [x] Business English - Corporate          |
   |                                           |
   | [Save Changes]                            |
   +------------------------------------------+
   |
   v
6. Select roles and groups
   |
   v
7. Save changes
   |
   v
8. User role assignments updated
   |
   v
9. User receives notification of role change
```

### 9.2 Custom Role Creation Flow (Company Admin)

```
1. Navigate to /admin/settings/roles
   |
   v
2. Click "Create Custom Role"
   |
   v
3. Role creation form:
   +------------------------------------------+
   | Create Custom Role                        |
   |                                           |
   | Name: [Content Reviewer              ]    |
   | Description: [Reviews and approves... ]   |
   |                                           |
   | Base Role: [Teacher v]                    |
   |                                           |
   | Permissions:                              |
   | Content Management                        |
   | [x] courses.view_company                  |
   | [ ] courses.create                        |
   | [ ] courses.edit_own                      |
   | [x] courses.publish (inherited)           |
   | [ ] lessons.create                        |
   |                                           |
   | [Create Role]                             |
   +------------------------------------------+
   |
   v
4. Validate permissions (cannot exceed Company Admin)
   |
   v
5. Save custom role
   |
   v
6. Role available for assignment
```

### 9.3 - 9.5 (Original User Flows)

*See original specification for Admin Company Setup Flow, Admin Course Creation Flow, Admin Course Assignment Flow, Student Dashboard Flow, and Student Onboarding Flow.*

---

## 10. Admin Dashboard

### 10.1 Navigation Structure (Updated with RBAC)

```
/admin
  |
  +-- /admin/dashboard         # Overview with key metrics
  +-- /admin/companies         # Company management (Super Admin only)
  |     +-- /admin/companies/new
  |     +-- /admin/companies/[id]
  |
  +-- /admin/users             # User management
  |     +-- /admin/users/[id]
  |     +-- /admin/users/[id]/roles  # Role management
  |
  +-- /admin/roles             # Role management (Company Admin+)
  |     +-- /admin/roles/new   # Create custom role
  |     +-- /admin/roles/[id]  # Edit role
  |
  +-- /admin/groups            # Group management
  |     +-- /admin/groups/new
  |     +-- /admin/groups/[id]
  |     +-- /admin/groups/[id]/members
  |     +-- /admin/groups/[id]/assignments
  |
  +-- /admin/courses           # Course management
  |     +-- /admin/courses/new
  |     +-- /admin/courses/[id]
  |     +-- /admin/courses/[id]/lessons
  |     +-- /admin/courses/[id]/modules
  |
  +-- /admin/lessons           # Lesson management (existing)
  +-- /admin/learning-paths    # Learning path management
  +-- /admin/avatars           # Avatar management (Super Admin only)
  +-- /admin/analytics         # Analytics dashboard
  +-- /admin/settings          # Company/platform settings
        +-- /admin/settings/roles  # RBAC settings
```

### 10.2 Role-Based Navigation Visibility

| Route | Super Admin | Company Admin | Teacher | Group Lead |
|-------|:-----------:|:-------------:|:-------:|:----------:|
| /admin/dashboard | X | X | X | X |
| /admin/companies | X | | | |
| /admin/users | X | X | | |
| /admin/roles | X | X | | |
| /admin/groups | X | X | X | X* |
| /admin/courses | X | X | X | |
| /admin/lessons | X | X | X | |
| /admin/learning-paths | X | X | X | |
| /admin/avatars | X | | | |
| /admin/analytics | X | X | X* | X* |
| /admin/settings | X | X | | |

*Notes: `*` indicates limited access (own groups/data only)

---

## 11. Student Dashboard

*See original specification for Student Dashboard details.*

---

## 12. API & Mutation Requirements

### 12.1 RBAC Mutations

```typescript
// convex/rbac.ts

// Get current user's permissions
export const getMyPermissions = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return { permissions: [], roles: [] };

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) return { permissions: [], roles: [] };

    const roleAssignments = await ctx.db
      .query("userRoleAssignments")
      .withIndex("by_user_active", (q) =>
        q.eq("userId", user._id).eq("isActive", true)
      )
      .collect();

    const permissions = await resolvePermissions(ctx, roleAssignments);
    const roleNames = await getRoleNames(ctx, roleAssignments);

    return { permissions, roles: roleNames };
  },
});

// Assign role to user
export const assignRole = mutation({
  args: {
    userId: v.id("users"),
    roleId: v.string(),
    scope: v.union(
      v.literal("global"),
      v.literal("company"),
      v.literal("group")
    ),
    scopeId: v.optional(v.string()),
    expiresAt: v.optional(v.number()),
    notes: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Verify caller has users.assign_roles permission
    const auth = await requirePermission(ctx, "users.assign_roles");

    // Validate scope
    if (args.scope === "company" && !args.scopeId) {
      throw new ConvexError({ code: "VALIDATION_ERROR", message: "Company ID required for company scope" });
    }
    if (args.scope === "group" && !args.scopeId) {
      throw new ConvexError({ code: "VALIDATION_ERROR", message: "Group ID required for group scope" });
    }

    // Verify target user exists
    const targetUser = await ctx.db.get(args.userId);
    if (!targetUser) {
      throw new ConvexError({ code: "NOT_FOUND", message: "User not found" });
    }

    // Verify role exists and is assignable
    const role = await ctx.db
      .query("roles")
      .withIndex("by_id", (q) => q.eq("id", args.roleId))
      .unique();

    if (!role || !role.isActive) {
      throw new ConvexError({ code: "NOT_FOUND", message: "Role not found or inactive" });
    }

    // Company Admin cannot assign Super Admin role
    if (role.id === "super_admin" && !auth.permissions.includes("*")) {
      throw new ConvexError({ code: "NOT_AUTHORIZED", message: "Cannot assign Super Admin role" });
    }

    // Check for existing assignment
    const existing = await ctx.db
      .query("userRoleAssignments")
      .withIndex("by_user", (q) => q.eq("userId", args.userId))
      .filter((q) =>
        q.and(
          q.eq(q.field("roleId"), args.roleId),
          q.eq(q.field("scope"), args.scope),
          q.eq(q.field("isActive"), true)
        )
      )
      .first();

    if (existing) {
      throw new ConvexError({ code: "DUPLICATE_ENTRY", message: "Role already assigned" });
    }

    // Create assignment
    return await ctx.db.insert("userRoleAssignments", {
      userId: args.userId,
      roleId: args.roleId,
      scope: args.scope,
      scopeId: args.scopeId,
      assignedBy: auth.userId,
      assignedAt: Date.now(),
      expiresAt: args.expiresAt,
      isActive: true,
      notes: args.notes,
    });
  },
});

// Revoke role from user
export const revokeRole = mutation({
  args: {
    assignmentId: v.id("userRoleAssignments"),
    reason: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    await requirePermission(ctx, "users.assign_roles");

    const assignment = await ctx.db.get(args.assignmentId);
    if (!assignment) {
      throw new ConvexError({ code: "NOT_FOUND", message: "Assignment not found" });
    }

    // Cannot revoke own Super Admin role
    const auth = await ctx.auth.getUserIdentity();
    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", auth!.subject))
      .unique();

    if (assignment.userId === user?._id && assignment.roleId === "super_admin") {
      throw new ConvexError({ code: "NOT_AUTHORIZED", message: "Cannot revoke own Super Admin role" });
    }

    await ctx.db.patch(args.assignmentId, {
      isActive: false,
      notes: args.reason ? `${assignment.notes || ""}\nRevoked: ${args.reason}` : assignment.notes,
    });
  },
});

// Create custom role (Company Admin on Professional+ tier)
export const createCustomRole = mutation({
  args: {
    companyId: v.id("companies"),
    name: v.string(),
    description: v.optional(v.string()),
    permissions: v.array(v.string()),
    inheritsFrom: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const auth = await requirePermission(ctx, "companies.create_custom_roles", {
      type: "company",
      id: args.companyId,
    });

    // Verify company allows custom roles
    const company = await ctx.db.get(args.companyId);
    if (!company?.rbacSettings?.customRolesEnabled) {
      throw new ConvexError({
        code: "NOT_AUTHORIZED",
        message: "Custom roles not enabled for this company"
      });
    }

    // Check custom role limit
    const existingCustomRoles = await ctx.db
      .query("roles")
      .withIndex("by_company", (q) => q.eq("companyId", args.companyId))
      .collect();

    if (existingCustomRoles.length >= (company.rbacSettings.maxCustomRoles || 0)) {
      throw new ConvexError({
        code: "CAPACITY_EXCEEDED",
        message: "Maximum custom roles reached"
      });
    }

    // Validate permissions (cannot include Super Admin-only permissions)
    const superAdminOnlyPermissions = ["users.impersonate", "companies.create", "companies.delete", "avatars.create", "avatars.edit"];
    const invalidPermissions = args.permissions.filter(p => superAdminOnlyPermissions.includes(p));
    if (invalidPermissions.length > 0) {
      throw new ConvexError({
        code: "VALIDATION_ERROR",
        message: `Cannot include permissions: ${invalidPermissions.join(", ")}`
      });
    }

    const roleId = `custom_${args.companyId}_${Date.now()}`;

    return await ctx.db.insert("roles", {
      id: roleId,
      name: args.name,
      description: args.description,
      type: "company_custom",
      companyId: args.companyId,
      permissions: args.permissions,
      inheritsFrom: args.inheritsFrom,
      isActive: true,
      createdBy: auth.userId,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    });
  },
});

// Check if user has specific permission
export const checkPermission = query({
  args: {
    permission: v.string(),
    resourceType: v.optional(v.string()),
    resourceId: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    try {
      await requirePermission(
        ctx,
        args.permission,
        args.resourceType && args.resourceId ? {
          type: args.resourceType as "company" | "group" | "user",
          id: args.resourceId,
        } : undefined
      );
      return { hasPermission: true };
    } catch {
      return { hasPermission: false };
    }
  },
});
```

### 12.2-12.5 (Original API Mutations)

*See original specification for Company Mutations, Group Mutations, Course Mutations, Enrollment Mutations, and Progress Mutations - updated to include permission checks using `requirePermission()`.*

---

## 13. Edge Cases & Error Handling

### 13.1 RBAC Edge Cases

| Scenario | Handling |
|----------|----------|
| User has multiple roles with conflicting permissions | Union of all permissions (most permissive wins) |
| Role expires mid-session | Permission checks on next API call, not real-time |
| Custom role deleted with active assignments | Deactivate assignments, notify users |
| Company downgraded from Professional (custom roles) | Preserve custom roles but prevent new ones |
| User removed from company with company-scoped roles | Deactivate all company-scoped role assignments |
| Circular role inheritance | Detect during role creation, reject with error |
| Permission check on non-existent resource | Return NOT_FOUND before NOT_AUTHORIZED |

### 13.2-13.6 (Original Edge Cases)

*See original specification for Company, Group, Course, Enrollment, and Progress edge cases.*

---

## 14. Security & Authorization

### 14.1 Authorization Rules (Updated)

| Resource | Action | Super Admin | Company Admin | Teacher | Group Lead | Student |
|----------|--------|:-----------:|:-------------:|:-------:|:----------:|:-------:|
| Company | Create | X | | | | |
| Company | Read | X (all) | X (own) | X (own) | X (own) | |
| Company | Update | X | X (own) | | | |
| Company | Delete | X | | | | |
| Group | Create | X | X | X | | |
| Group | Read | X (all) | X (company) | X (company) | X (own) | |
| Group | Update | X | X | X | X (own) | |
| Group | Add Member | X | X | X | X (own) | |
| Course | Create | X | X | X | | |
| Course | Read | X (all) | X (company+public) | X (company+public) | X (enrolled) | X (enrolled) |
| Course | Update | X | X (company) | X (own) | | |
| Enrollment | Create | X | X | X | | X (self, if allowed) |
| Enrollment | Read | X (all) | X (company) | X (groups) | X (own groups) | X (own) |
| Progress | Read | X (all) | X (company) | X (groups) | X (own groups) | X (own) |
| Progress | Update | System | System | System | System | System |
| Role | Create Custom | X | X (if tier allows) | | | |
| Role | Assign | X | X (company scope) | | | |

### 14.2 Authentication Flow

```
1. User authenticates via Clerk
   |
   v
2. Clerk webhook creates/updates user record in Convex
   |
   v
3. User gets default role assignments (Student)
   |
   v
4. On each request:
   a. Clerk JWT verified
   b. User roles queried from Convex
   c. Permissions resolved (including inheritance)
   d. Resource-specific scope checked
   e. Access granted or denied
```

### 14.3 Data Isolation

- Companies cannot see each other's data
- Groups within a company can share content
- Student progress is private unless admin/teacher viewing
- Avatars are shared across all companies (system resource)
- **Custom roles are company-scoped and isolated**
- **Role assignments include scope validation**

### 14.4 Sensitive Data Handling

| Data | Sensitivity | Protection |
|------|-------------|------------|
| User email | Medium | Only shown to admin, student sees own |
| Progress data | Low | Private to student and authorized roles |
| Company billing | High | Admin only, encrypted at rest |
| Avatar configurations | Low | System-wide, read-only for students |
| **Role assignments** | Medium | **Admin only, audit logged** |
| **Custom role definitions** | Medium | **Company Admin only** |

### 14.5 Audit Logging

All RBAC-related actions are logged to `auditLog` table:
- Role assignments/revocations
- Custom role creation/modification
- Permission check failures
- Admin actions on user accounts

---

## 15. Implementation Phases

### Phase 0: RBAC Foundation (Week 1-2) - NEW

**Goal:** Implement core RBAC infrastructure

- [ ] Create `roles` table with system roles seeded
- [ ] Create `userRoleAssignments` table
- [ ] Create `permissions` reference table
- [ ] Implement `requirePermission()` authorization helper
- [ ] Implement `resolvePermissions()` with inheritance
- [ ] Create PermissionProvider React context
- [ ] Update middleware for route protection
- [ ] Create seed script for default roles/permissions

**Deliverables:**
- RBAC schema deployed
- System roles seeded (super_admin, company_admin, teacher, group_lead, student, guest)
- All permissions defined
- Authorization helper working

### Phase 1: Core Schema & Admin Foundation (Week 3-4)

**Goal:** Database schema and basic admin CRUD operations (with RBAC)

- [ ] Add new tables to Convex schema (companies, groups, etc.)
- [ ] **Integrate RBAC checks into all mutations**
- [ ] Create Company CRUD mutations/queries
- [ ] Create Group CRUD mutations/queries
- [ ] Create Course CRUD mutations/queries (without modules)
- [ ] Create basic admin navigation structure
- [ ] **Implement role-based navigation visibility**
- [ ] Create admin company list/detail pages
- [ ] Create admin group list/detail pages

**Deliverables:**
- Schema deployed with all new tables
- Admins can create companies and groups (with proper authorization)
- Basic admin UI navigation working (role-aware)

### Phase 2: Course Management & Structure (Week 5-6)

*Same as original Phase 2, with RBAC checks integrated*

### Phase 3: Enrollment System (Week 7-8)

*Same as original Phase 3, with RBAC checks integrated*

### Phase 4: Student Dashboard (Week 9-10)

*Same as original Phase 4, with role-based content visibility*

### Phase 5: Learning Paths & Advanced Features (Week 11-12)

*Same as original Phase 5*

### Phase 6: Custom Roles & Analytics (Week 13-14) - UPDATED

**Goal:** Custom role management and admin analytics

- [ ] Implement custom role creation UI
- [ ] Implement custom role assignment
- [ ] Create role management admin page
- [ ] Create group progress analytics
- [ ] Create student progress analytics
- [ ] Add admin dashboard overview
- [ ] Implement notifications (optional)
- [ ] Performance optimization
- [ ] Bug fixes and edge case handling

**Deliverables:**
- Company Admins can create custom roles (if tier allows)
- Role assignment UI working
- Admins can view group/student progress
- Dashboard overview with key metrics
- System ready for production use

---

## 16. Decisions Log

| # | Decision | Options Considered | Choice | Rationale |
|---|----------|-------------------|--------|-----------|
| 1 | Organizational hierarchy | Flat users vs Companies/Groups | Companies + Groups | Supports B2B with flexible class/team organization |
| 2 | **Role system** | Simple roles vs Full RBAC | **Full RBAC with permissions** | **Granular control for enterprise customers** |
| 3 | **Permission scoping** | Global only vs Scoped | **Scoped (global/company/group)** | **Multi-tenant isolation** |
| 4 | **Custom roles** | All tiers vs Premium only | **Professional+ tiers** | **Value differentiation for paid plans** |
| 5 | **Role inheritance** | No inheritance vs Hierarchical | **Hierarchical inheritance** | **Reduces permission duplication** |
| 6 | Course structure | Fixed vs Flexible | Flexible (flat or modular) | Different courses need different complexity |
| 7 | Learning paths | Separate entity vs Course metadata | Separate entity | Cleaner data model, easier to manage |
| 8 | Enrollment source tracking | Single source vs Multiple | Multiple sources | Student can be in same course via multiple groups |
| 9 | Progress deduplication | Per-enrollment vs Per-student-course | Per-student-course | Single progress record regardless of enrollment path |
| 10 | Avatar assignment | Required vs Optional | Optional with fallback | Flexibility while ensuring avatar is always available |
| 11 | Group capacity | Hard limit vs Soft limit | Hard limit | Clear expectations, prevents overloading |
| 12 | Self-enrollment | Always vs Never vs Configurable | Configurable per company | Different business needs |
| 13 | Student dashboard focus | Content-first vs Progress-first | Progress-first | Encourages completion and engagement |
| 14 | Module unlock | All sequential vs Configurable | Configurable per module | Different pedagogical approaches |
| 15 | **Permission check timing** | Real-time vs On-request | **On-request** | **Performance over real-time revocation** |

---

## 17. Out of Scope

The following are explicitly **not included** in this specification:

1. ~~**Multi-tenant admin roles**~~ - *Now included in RBAC*
2. **Real-time collaboration** - Students seeing each other's progress live
3. **Peer-to-peer features** - Student chat, forums, group projects
4. **Advanced billing** - Per-seat pricing, usage-based billing
5. **White-labeling** - Custom domain, fully branded experience
6. **API for external integrations** - REST/GraphQL for third-party access
7. **Mobile app** - Native iOS/Android applications
8. **Offline support** - Downloadable lessons for offline access
9. **Certificate generation** - Completion certificates (future phase)
10. **Advanced analytics** - ML-based insights, predictive analytics
11. **Gamification** - Leaderboards, badges, points (beyond streaks)
12. **Calendar integration** - Google Calendar, Outlook sync
13. **Bulk import/export** - CSV import of students, courses
14. **SCORM/xAPI** - LMS interoperability standards
15. **Custom lesson builder** - Admin creating lessons from scratch (use existing)
16. **SSO/SAML** - Enterprise single sign-on (handled by Clerk separately)

---

## 18. Open Questions

| # | Question | Impact | Proposed Resolution |
|---|----------|--------|---------------------|
| 1 | ~~Should companies have their own admin users or just platform admins?~~ | ~~Multi-tenancy~~ | *Resolved: Company Admin role added* |
| 2 | How to handle student leaving a company entirely? | Data retention | Keep student record, remove group memberships, deactivate company-scoped roles |
| 3 | Should courses have version history? | Content management | Not initially, add if needed |
| 4 | How to handle time zone differences in due dates? | Scheduling | Store as UTC, display in user's timezone |
| 5 | Should students be able to browse all courses or only assigned? | Discovery | Initially only assigned, add catalog feature later |
| 6 | What happens to progress if a lesson is edited? | Content updates | Progress preserved, student sees updated content |
| 7 | Should there be a limit on groups per student? | Data model | No limit initially, monitor for abuse |
| 8 | How to handle concurrent lesson access? | Concurrency | Allow, track separate progress, merge on completion |
| 9 | **Should role changes take effect immediately or on next login?** | Security vs UX | **Next API call (cached permissions cleared)** |
| 10 | **How to handle role assignment conflicts?** | Permission resolution | **Union of permissions (most permissive)** |
| 11 | **Should expired role assignments be auto-cleaned?** | Data hygiene | **Yes, via scheduled Convex function** |

---

## Appendix A: Default System Roles Definition

```typescript
// Seed data for system roles

const systemRoles = [
  {
    id: "super_admin",
    name: "Super Admin",
    description: "Platform administrator with full access to all resources",
    type: "system",
    permissions: ["*"], // Wildcard for all permissions
    isActive: true,
  },
  {
    id: "company_admin",
    name: "Company Admin",
    description: "Organization administrator with full company access",
    type: "system",
    permissions: [
      "users.view_company", "users.create", "users.edit", "users.delete", "users.assign_roles",
      "companies.view_own", "companies.edit", "companies.manage_subscription", "companies.create_custom_roles",
      "groups.create", "groups.view_all", "groups.edit", "groups.delete", "groups.add_members", "groups.remove_members",
      "courses.create", "courses.view_company", "courses.edit_own", "courses.edit_all", "courses.delete", "courses.publish",
      "lessons.create", "lessons.edit_own", "lessons.edit_all", "lessons.delete",
      "enrollments.assign_group", "enrollments.assign_individual", "enrollments.view_all",
      "analytics.view_company", "analytics.view_group", "analytics.view_own", "reports.export",
      "avatars.view", "avatars.assign", "sessions.create", "sessions.view_own", "sessions.view_all",
    ],
    inheritsFrom: "teacher",
    isActive: true,
  },
  {
    id: "teacher",
    name: "Teacher / Content Creator",
    description: "Creates and manages learning content",
    type: "system",
    permissions: [
      "companies.view_own",
      "groups.create", "groups.view_all", "groups.edit", "groups.add_members", "groups.remove_members",
      "courses.create", "courses.view_company", "courses.edit_own", "courses.publish",
      "lessons.create", "lessons.edit_own",
      "enrollments.assign_group", "enrollments.assign_individual", "enrollments.view_group",
      "analytics.view_group", "analytics.view_own",
      "avatars.view", "avatars.assign", "sessions.create", "sessions.view_own",
    ],
    inheritsFrom: "student",
    isActive: true,
  },
  {
    id: "group_lead",
    name: "Group Lead",
    description: "Manages specific group(s) and views group progress",
    type: "system",
    permissions: [
      "companies.view_own",
      "groups.view_own", "groups.edit", "groups.add_members", "groups.remove_members",
      "courses.view_enrolled",
      "enrollments.view_group",
      "analytics.view_group", "analytics.view_own",
      "avatars.view", "sessions.create", "sessions.view_own",
    ],
    inheritsFrom: "student",
    isActive: true,
  },
  {
    id: "student",
    name: "Student",
    description: "Learner enrolled in courses",
    type: "system",
    permissions: [
      "courses.view_enrolled",
      "enrollments.self_enroll",
      "analytics.view_own",
      "avatars.view", "sessions.create", "sessions.view_own",
    ],
    inheritsFrom: "guest",
    isActive: true,
  },
  {
    id: "guest",
    name: "Guest",
    description: "Limited access user, typically trial users",
    type: "system",
    permissions: [
      "analytics.view_own",
      "avatars.view",
    ],
    isActive: true,
  },
];
```

---

## Appendix B: URL Structure

### B.1 Admin Routes

| Route | Purpose | Required Permission |
|-------|---------|---------------------|
| `/admin` | Admin dashboard overview | Any admin role |
| `/admin/companies` | Company list | companies.view_all |
| `/admin/companies/new` | Create company | companies.create |
| `/admin/companies/[id]` | Company details | companies.view_own/all |
| `/admin/companies/[id]/edit` | Edit company | companies.edit |
| `/admin/users` | User management | users.view_company/all |
| `/admin/users/[id]` | User details | users.view_company/all |
| `/admin/users/[id]/roles` | Manage user roles | users.assign_roles |
| `/admin/roles` | Role management | companies.view_own |
| `/admin/roles/new` | Create custom role | companies.create_custom_roles |
| `/admin/roles/[id]` | Edit role | companies.edit |
| `/admin/groups` | All groups list | groups.view_all/own |
| `/admin/groups/new?companyId=xxx` | Create group | groups.create |
| `/admin/groups/[id]` | Group details | groups.view_all/own |
| `/admin/groups/[id]/members` | Manage members | groups.add_members |
| `/admin/groups/[id]/assignments` | Manage course assignments | enrollments.assign_group |
| `/admin/courses` | Course list | courses.view_company/all |
| `/admin/courses/new` | Create course | courses.create |
| `/admin/courses/[id]` | Course details/editor | courses.view_company/all |
| `/admin/learning-paths` | Learning path list | courses.view_company/all |
| `/admin/learning-paths/new` | Create path | courses.create |
| `/admin/learning-paths/[id]` | Path details/editor | courses.view_company/all |
| `/admin/avatars` | Avatar management | avatars.edit |
| `/admin/analytics` | Analytics dashboard | analytics.view_company/platform |
| `/admin/settings` | Platform/company settings | companies.edit |
| `/admin/settings/roles` | RBAC settings | companies.create_custom_roles |

### B.2 Student Routes

| Route | Purpose | Required Permission |
|-------|---------|---------------------|
| `/dashboard` | Student dashboard | sessions.create |
| `/courses` | All enrolled courses | courses.view_enrolled |
| `/courses/[id]` | Course detail with lessons | courses.view_enrolled |
| `/courses/[id]/lessons/[lessonId]` | Lesson view (redirects to session) | sessions.create |
| `/paths` | All enrolled learning paths | courses.view_enrolled |
| `/paths/[id]` | Learning path detail | courses.view_enrolled |
| `/progress` | Progress overview | analytics.view_own |
| `/settings` | Student settings | (authenticated) |
| `/settings/avatar` | Avatar selection | avatars.view |

---

*End of Specification*

*Document Version: 2.0.0*
*Last Updated: 2026-01-04*
*Author: Spec Agent*

## Changelog

### Version 2.0.0 (2026-01-04)
- Added comprehensive Role-Based Access Control (RBAC) system
- Defined 6 system roles: Super Admin, Company Admin, Teacher, Group Lead, Student, Guest
- Created granular permission system with 40+ permissions across 8 categories
- Added permission scoping (global, company, group, self, created)
- Added custom role support for Professional+ tier companies
- Added role inheritance hierarchy
- Added authorization flow documentation
- Added middleware and Convex function authorization patterns
- Added UI component visibility patterns with PermissionProvider
- Added complete permission matrix
- Updated data models with RBAC tables (roles, userRoleAssignments, permissions)
- Updated implementation phases to include RBAC foundation
- Updated security section with RBAC considerations
- Added audit logging requirements for RBAC actions

### Version 1.0.0 (2026-01-04)
- Initial specification
- Companies and Groups organizational structure
- Course hierarchy with Modules and Learning Paths
- Enrollment and Assignment system
- Admin and Student dashboards
