# Word Games Feature Specification

> Generated by @deep-requirements-orchestrator
> Interview rounds: 7
> Date: 2026-01-02
> Platform: Beethoven (Emma AI Platform)

---

## Executive Summary

This specification defines a comprehensive word game system for the Beethoven AI language learning platform. The system provides 8 interactive game types that integrate with AI avatar teachers to deliver engaging, scaffolded learning experiences for German speakers learning English.

**Key Decisions:**
- 8 game types covering vocabulary, grammar, and sentence construction
- Single-player with AI avatar providing guided scaffolding
- CEFR-aligned difficulty (A1-C2) with adaptive progression
- Admin-created content with template, JSON, and AI-assisted builders
- Games linked to lessons but can exist standalone
- Hybrid state sync: Convex for persistence, LiveKit for real-time events
- Star rating scoring (1-3 stars) with comprehensive analytics
- Desktop-first, split-screen UI with avatar video

---

## Table of Contents

1. [Problem & Context](#1-problem--context)
2. [Users & Personas](#2-users--personas)
3. [Game Types Specification](#3-game-types-specification)
4. [Difficulty & Progression System](#4-difficulty--progression-system)
5. [Avatar Scaffolding System](#5-avatar-scaffolding-system)
6. [Admin Interface](#6-admin-interface)
7. [Student Interface](#7-student-interface)
8. [Lesson Integration](#8-lesson-integration)
9. [Database Schema](#9-database-schema)
10. [API & Event Contracts](#10-api--event-contracts)
11. [State Machines](#11-state-machines)
12. [Analytics Specification](#12-analytics-specification)
13. [Error Handling](#13-error-handling)
14. [Technical Constraints](#14-technical-constraints)
15. [Implementation Phases](#15-implementation-phases)
16. [Decisions Log](#16-decisions-log)
17. [Out of Scope](#17-out-of-scope)
18. [Open Questions](#18-open-questions)

---

## 1. Problem & Context

### 1.1 Problem Statement

The Beethoven platform currently supports structured lessons with slides and free conversation, but lacks interactive practice activities that reinforce vocabulary and grammar learning. Students need hands-on exercises that:

- Provide immediate feedback on their understanding
- Allow the AI avatar to guide them through difficulties
- Track progress and identify areas needing improvement
- Make learning engaging through gamification

### 1.2 Solution Overview

A word game system that:
- Offers 8 distinct game types covering different learning modalities
- Integrates seamlessly with AI avatar teachers for real-time scaffolding
- Can be embedded in lessons or played standalone
- Provides comprehensive analytics for students and teachers

### 1.3 Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Game completion rate | > 80% | Games started vs completed |
| Average star rating | > 2.0 stars | Mean score across all games |
| Student engagement | > 3 games/week | Active students playing games |
| Avatar scaffolding effectiveness | < 3 hints to completion | Average hints per game |

---

## 2. Users & Personas

| User Type | Description | Primary Need |
|-----------|-------------|--------------|
| **Student** | German speaker learning English (A1-C2) | Practice vocabulary/grammar with AI guidance |
| **Admin/Teacher** | Content creator, course designer | Create and manage word game content |
| **AI Avatar** | Emma or other teaching avatars | Provide scaffolding, feedback, encouragement |
| **Platform Admin** | System administrator | Monitor analytics, manage game library |

---

## 3. Game Types Specification

### 3.1 Overview

| # | Game Type | Category | Core Mechanic | Typical Duration |
|---|-----------|----------|---------------|------------------|
| 1 | Sentence Builder | Grammar | Drag-and-drop block ordering | 2-5 min |
| 2 | Fill in the Blank | Grammar/Vocab | Selection from options | 1-3 min |
| 3 | Word Ordering | Grammar | Drag-and-drop sequencing | 1-3 min |
| 4 | Matching Pairs | Vocabulary | Click-to-match connections | 2-4 min |
| 5 | Word Scramble | Vocabulary | Letter tile arrangement | 1-2 min |
| 6 | Multiple Choice | Grammar/Vocab | Single/multiple selection | 1-2 min |
| 7 | Flashcards | Vocabulary | Card flip with self-assessment | 2-5 min |
| 8 | Hangman | Vocabulary | Letter guessing | 1-3 min |

---

### 3.2 Game Type: Sentence Builder

**Purpose:** Practice English sentence structure, verb chains, modals, and grammar patterns.

**Mechanics:**
- Student drags word/phrase blocks from a palette into a workspace
- Blocks are color-coded by grammatical category (subject, verb, object, etc.)
- Only one valid sentence order is accepted (strict matching)
- Blocks can be reordered by dragging within workspace
- Double-click or drag-out to remove a block

**Block Categories:**
```
| Category   | Color    | Examples                          |
|------------|----------|-----------------------------------|
| subject    | #e0f2ff  | I, you, we, they, my team         |
| aux        | #e0f7ec  | do, does, did, am, is, are, have  |
| modal      | #fff3d9  | can, could, may, might, will      |
| main       | #ffe8e0  | deliver, work, have to, going to  |
| negation   | #ffd6de  | not, never                        |
| object     | #e9e0ff  | it, the report, our target        |
| time       | #e5f2e0  | today, this week, already         |
| connector  | #f0f0f0  | but, because, so                  |
```

**Configuration Schema:**
```typescript
interface SentenceBuilderConfig {
  type: "sentence_builder";
  instructions: string;           // Displayed to student
  targetSentence: string;         // Correct answer as string
  availableBlocks: {
    id: string;
    text: string;
    category: BlockCategory;
  }[];
  distractorBlocks?: {            // Extra blocks not in answer
    id: string;
    text: string;
    category: BlockCategory;
  }[];
  hints: string[];                // Progressive hint texts
}
```

**Scoring:**
- 3 stars: Correct on first attempt, no hints
- 2 stars: Correct with 1-2 hints OR 1-2 incorrect attempts
- 1 star: Correct with 3+ hints OR 3+ incorrect attempts

**Avatar Scaffolding Actions:**
- Highlight a block that should be used next
- Show the first block placement
- Verbally hint about grammar rule ("Think about subject-verb order...")
- Eliminate an incorrect distractor block
- Demonstrate full solution, then reset

---

### 3.3 Game Type: Fill in the Blank

**Purpose:** Test vocabulary recall and grammar usage in context.

**Mechanics:**
- Student sees a sentence with one or more blanks (marked with `___`)
- For each blank, student selects from multiple choice options
- Options appear as clickable buttons below the sentence
- Immediate feedback on selection (correct/incorrect)

**Configuration Schema:**
```typescript
interface FillInBlankConfig {
  type: "fill_in_blank";
  instructions: string;
  items: {
    id: string;
    sentence: string;             // "The cat ___ on the mat."
    blankIndex: number;           // Position of blank (word index)
    correctAnswer: string;        // "sat"
    options: string[];            // ["sat", "sit", "sitting", "sets"]
    explanation?: string;         // Shown after answering
  }[];
  hints: string[];
}
```

**Scoring:**
- Per-item scoring, aggregated to overall percentage
- 3 stars: >= 90% correct
- 2 stars: >= 70% correct
- 1 star: >= 50% correct
- 0 stars: < 50% correct (recorded as incomplete)

**Avatar Scaffolding Actions:**
- Highlight the grammatical context around the blank
- Eliminate one wrong option
- Provide verbal hint about tense/form needed
- Read the sentence aloud with emphasis on context

---

### 3.4 Game Type: Word Ordering

**Purpose:** Practice sentence construction and word order rules.

**Mechanics:**
- Student sees scrambled words that form a sentence
- Drag words into correct order in a target area
- Words snap into position slots
- Submit button to check answer

**Configuration Schema:**
```typescript
interface WordOrderingConfig {
  type: "word_ordering";
  instructions: string;
  items: {
    id: string;
    correctSentence: string;      // "She has been working here."
    scrambledWords: string[];     // ["working", "She", "here", "has", "been"]
    punctuation?: string;         // "." added automatically
  }[];
  hints: string[];
}
```

**Scoring:**
- Same as Fill in the Blank (percentage-based)

**Avatar Scaffolding Actions:**
- Reveal the first word position
- Highlight a word that comes next
- Verbal hint about sentence structure
- Show word groupings (e.g., "has been" go together)

---

### 3.5 Game Type: Matching Pairs

**Purpose:** Build vocabulary through association (word-definition, word-translation, word-image).

**Mechanics:**
- Two columns of items displayed
- Student clicks item in left column, then matching item in right column
- Matched pairs are highlighted and removed/grayed out
- Continue until all pairs matched

**Match Types:**
- Word to Definition
- Word to Translation (future: when bilingual enabled)
- Word to Image
- Word to Synonym/Antonym

**Configuration Schema:**
```typescript
interface MatchingPairsConfig {
  type: "matching_pairs";
  instructions: string;
  matchType: "definition" | "translation" | "image" | "synonym" | "antonym";
  pairs: {
    id: string;
    left: {
      text: string;
      imageUrl?: string;
    };
    right: {
      text: string;
      imageUrl?: string;
    };
  }[];
  timeLimit?: number;             // Optional, in seconds
  hints: string[];
}
```

**Scoring:**
- 3 stars: All matched with 0-1 wrong attempts
- 2 stars: All matched with 2-3 wrong attempts
- 1 star: All matched with 4+ wrong attempts

**Avatar Scaffolding Actions:**
- Highlight one correct pair
- Eliminate an incorrect option from consideration
- Provide definition/context for a difficult word
- Group related items verbally

---

### 3.6 Game Type: Word Scramble

**Purpose:** Reinforce spelling and word recognition.

**Mechanics:**
- Scrambled letters displayed as draggable tiles
- Student arranges tiles to spell the correct word
- Optional hint: definition or image of the target word
- Submit to check answer

**Configuration Schema:**
```typescript
interface WordScrambleConfig {
  type: "word_scramble";
  instructions: string;
  items: {
    id: string;
    correctWord: string;          // "beautiful"
    scrambledLetters: string[];   // ["u","b","t","i","e","a","l","f","u"]
    hint: string;                 // Definition or context
    imageUrl?: string;            // Optional image hint
  }[];
  hints: string[];
}
```

**Scoring:**
- Per-word scoring based on attempts
- 3 stars: >= 90% first-attempt correct
- 2 stars: >= 70% correct
- 1 star: >= 50% correct

**Avatar Scaffolding Actions:**
- Reveal the first letter
- Reveal the last letter
- Provide pronunciation
- Give a sentence using the word

---

### 3.7 Game Type: Multiple Choice

**Purpose:** Quick assessment of vocabulary and grammar knowledge.

**Mechanics:**
- Question displayed with 3-5 answer options
- Student clicks to select answer
- Immediate feedback with explanation
- Progress through multiple questions

**Question Types:**
- Vocabulary definition
- Grammar rule application
- Sentence completion
- Error identification

**Configuration Schema:**
```typescript
interface MultipleChoiceConfig {
  type: "multiple_choice";
  instructions: string;
  items: {
    id: string;
    question: string;
    questionType: "definition" | "grammar" | "completion" | "error";
    options: {
      id: string;
      text: string;
      isCorrect: boolean;
    }[];
    explanation: string;          // Shown after answering
    imageUrl?: string;            // Optional image with question
  }[];
  allowMultipleSelect?: boolean;  // For "select all that apply"
  hints: string[];
}
```

**Scoring:**
- Percentage-based on correct answers
- Standard 3/2/1 star thresholds (90/70/50)

**Avatar Scaffolding Actions:**
- Eliminate one wrong answer
- Rephrase the question
- Provide context or example
- Hint at the grammar rule being tested

---

### 3.8 Game Type: Flashcards

**Purpose:** Spaced repetition vocabulary review.

**Mechanics:**
- Card displayed with front content (word or definition)
- Student mentally recalls the answer
- Click/tap to flip and see back of card
- Student self-assesses: "Got it" / "Almost" / "Missed it"
- Cards marked "Missed it" repeat later in deck

**Configuration Schema:**
```typescript
interface FlashcardsConfig {
  type: "flashcards";
  instructions: string;
  cards: {
    id: string;
    front: {
      text: string;
      imageUrl?: string;
      audioUrl?: string;          // Pronunciation
    };
    back: {
      text: string;
      example?: string;           // Example sentence
      imageUrl?: string;
    };
  }[];
  shuffleCards: boolean;
  repeatMissed: boolean;          // Re-show missed cards
  hints: string[];
}
```

**Scoring:**
- Based on self-assessment distribution
- 3 stars: >= 80% "Got it"
- 2 stars: >= 60% "Got it"
- 1 star: >= 40% "Got it"

**Avatar Scaffolding Actions:**
- Pronounce the word
- Use the word in a sentence
- Provide etymology or memory trick
- Encourage on difficult cards

---

### 3.9 Game Type: Hangman

**Purpose:** Engaging vocabulary practice through word guessing.

**Mechanics:**
- Hidden word displayed as blank spaces
- Student selects letters from alphabet
- Correct letters revealed in position
- Incorrect letters shown as "used" with mistake counter
- Limited attempts (typically 6-8 mistakes allowed)

**Configuration Schema:**
```typescript
interface HangmanConfig {
  type: "hangman";
  instructions: string;
  items: {
    id: string;
    word: string;                 // "VOCABULARY"
    hint: string;                 // Category or definition hint
    maxMistakes: number;          // Default: 6
  }[];
  showCategoryHint: boolean;      // Show hint before guessing
  hints: string[];
}
```

**Scoring:**
- Per-word based on mistakes made
- 3 stars: 0-2 mistakes
- 2 stars: 3-4 mistakes
- 1 star: 5+ mistakes (but completed)
- 0 stars: Failed to guess word

**Avatar Scaffolding Actions:**
- Reveal a vowel
- Reveal a consonant
- Provide category hint
- Give first letter
- Use word in sentence (without saying the word)

---

## 4. Difficulty & Progression System

### 4.1 CEFR Level Alignment

Games are tagged with CEFR levels (A1, A2, B1, B2, C1, C2) that affect:

| Factor | Lower Levels (A1-A2) | Higher Levels (B1-C2) |
|--------|---------------------|----------------------|
| Hints available | 5 hints | 2-3 hints |
| Distractor quality | Obviously wrong | Subtly wrong |
| Vocabulary | Common words | Advanced/idiomatic |
| Sentences | Simple structure | Complex/compound |

### 4.2 Difficulty Configuration

```typescript
interface DifficultyConfig {
  level: "A1" | "A2" | "B1" | "B2" | "C1" | "C2";
  hintsAvailable: number;         // Max hints for this level
  distractorDifficulty: "easy" | "medium" | "hard";
  timeMultiplier?: number;        // For soft time tracking comparison
}
```

### 4.3 Adaptive Progression

**Initial Level Selection:**
- Student's CEFR level from profile used as starting point
- Can be overridden per game by admin

**In-Session Adaptation:**
```
IF student scores 3 stars on 3 consecutive games at level N:
  THEN suggest level N+1 content

IF student scores 1 star or less on 2 consecutive games:
  THEN avatar offers more scaffolding OR suggests easier game

IF student uses all hints and still fails:
  THEN avatar demonstrates solution, does not penalize
```

**Cross-Session Progression:**
- Track performance per game type per level
- Unlock "mastered" badge when 5+ games completed with 2+ stars average
- Recommend review games for skills with declining scores

---

## 5. Avatar Scaffolding System

### 5.1 Scaffolding Actions Catalog

| Action ID | Action Name | Visual Effect | Avatar Speech |
|-----------|-------------|---------------|---------------|
| `hint_highlight` | Highlight Hint | Pulse/glow on target element | "Look at this one..." |
| `hint_partial` | Show Partial | Reveal first element in answer | "Let me help you start..." |
| `hint_eliminate` | Eliminate Wrong | Fade/strikethrough wrong option | "This one isn't right..." |
| `hint_verbal` | Verbal Hint | None | Custom hint text |
| `hint_demonstrate` | Demonstrate | Show full solution animated | "Watch how it's done..." |
| `hint_reset` | Reset After Demo | Clear to starting state | "Now you try!" |
| `feedback_correct` | Correct Feedback | Green highlight + checkmark | "That's right!" / "Excellent!" |
| `feedback_incorrect` | Incorrect Feedback | Red highlight + shake | "Not quite..." / "Try again" |
| `feedback_progress` | Progress Update | Update progress indicator | "2 of 5 done!" |
| `feedback_complete` | Completion | Confetti + star display | "Wonderful work!" |

### 5.2 Scaffolding Event Schema

```typescript
interface ScaffoldingEvent {
  type: "scaffolding_action";
  action: ScaffoldingActionId;
  gameId: string;
  sessionId: string;
  targetElementId?: string;       // For visual actions
  message?: string;               // For verbal hints
  timestamp: number;
}
```

### 5.3 Avatar Decision Logic

The Python agent decides when to scaffold based on:

```python
class ScaffoldingDecider:
    def should_scaffold(self, game_state: GameState) -> Optional[ScaffoldingAction]:
        # Time-based triggers
        if game_state.time_since_last_action > 15:  # 15 seconds idle
            return self.get_encouraging_hint(game_state)

        # Mistake-based triggers
        if game_state.consecutive_mistakes >= 2:
            return self.get_corrective_hint(game_state)

        # Progress-based triggers
        if game_state.progress_percent > 75 and not game_state.recent_mistakes:
            return self.get_praise(game_state)

        # Student request triggers
        if game_state.hint_requested:
            return self.get_next_hint(game_state)

        return None
```

### 5.4 Continuous Commentary System

Avatar provides running commentary during gameplay:

| Trigger | Example Utterances |
|---------|-------------------|
| Game start | "Let's practice some vocabulary!", "This looks fun!" |
| Correct answer | "That's right!", "Excellent!", "You've got it!" |
| Incorrect answer | "Hmm, not quite.", "Close! Try again.", "Think about it..." |
| Using hint | "Here's a little help.", "Let me give you a clue." |
| Idle (10s) | "Take your time.", "You can do this!" |
| Idle (20s) | "Would you like a hint?", "Shall I help?" |
| Progress milestone | "Halfway there!", "Just two more to go!" |
| Completion | "Wonderful! You got [X] stars!", "Great practice!" |

---

## 6. Admin Interface

### 6.1 Game Management Page

**Location:** `/admin/games`

**Features:**
- List all games with filters (type, level, status, linked lesson)
- Create new game button
- Edit/duplicate/delete actions per game
- Bulk operations (publish, archive, assign to lesson)
- Search by title, tags, content

**Game List Card:**
```
+--------------------------------------------------+
| [Icon] Sentence Builder: Present Perfect         |
| Level: B1 | Type: Grammar | Status: Published    |
| Linked: Lesson "Business English 101"            |
| Stats: 45 plays | Avg: 2.3 stars | 78% completion|
| [Edit] [Duplicate] [Preview] [Delete]            |
+--------------------------------------------------+
```

### 6.2 Game Editor Interface

**Mode Toggle:** Template | JSON | AI-Assisted

#### Template Mode (Default)

```
+----------------------------------------------------------+
| Create New Game                               [Save Draft]|
+----------------------------------------------------------+
| Game Type: [Dropdown: Select type...]                     |
|                                                           |
| Basic Info                                                |
| +---------------------------------------------------------+
| | Title: [________________________]                       |
| | Instructions: [_______________________________________] |
| | Level: [A1 v] | Tags: [vocabulary, verbs, ...]         |
| +---------------------------------------------------------+
|                                                           |
| Content (varies by game type)                             |
| +---------------------------------------------------------+
| | [Game-specific content editor - see below]              |
| +---------------------------------------------------------+
|                                                           |
| Hints                                                     |
| +---------------------------------------------------------+
| | Hint 1: [Think about the subject first...]              |
| | Hint 2: [The verb comes after...]                       |
| | [+ Add Hint]                                            |
| +---------------------------------------------------------+
|                                                           |
| Lesson Link (Optional)                                    |
| +---------------------------------------------------------+
| | Link to Lesson: [Dropdown: None / Select lesson...]     |
| | Trigger: [v] Slide-triggered  Slide #: [3]             |
| |          [ ] Avatar-initiated                           |
| |          [ ] Student-requested                          |
| +---------------------------------------------------------+
|                                                           |
| [Preview] [Save Draft] [Publish]                          |
+----------------------------------------------------------+
```

#### Sentence Builder Content Editor

```
+----------------------------------------------------------+
| Target Sentence                                           |
| [We have been working on this project for three months.] |
|                                                           |
| Available Blocks (auto-generated from sentence)           |
| +--------+ +------+ +------+ +---------+ +----+ +-------+ |
| |   We   | | have | | been | | working | | on | | this  | |
| +--------+ +------+ +------+ +---------+ +----+ +-------+ |
| +----------+ +-----+ +-------+ +--------+                 |
| |  project | | for | | three | | months |                 |
| +----------+ +-----+ +-------+ +--------+                 |
|                                                           |
| Block Categories (click to assign)                        |
| We: [subject v]  have: [aux v]  been: [aux v] ...        |
|                                                           |
| Distractor Blocks (optional wrong answers)                |
| [+ Add Distractor]                                        |
| +------+ +--------+ +------+                              |
| |  is  | | worked | | since|  [x remove]                  |
| +------+ +--------+ +------+                              |
+----------------------------------------------------------+
```

#### JSON Mode

```json
{
  "type": "sentence_builder",
  "title": "Present Perfect Continuous",
  "instructions": "Arrange the blocks to form a correct sentence.",
  "level": "B1",
  "tags": ["grammar", "present-perfect", "continuous"],
  "config": {
    "targetSentence": "We have been working on this project for three months.",
    "availableBlocks": [
      {"id": "b1", "text": "We", "category": "subject"},
      {"id": "b2", "text": "have", "category": "aux"},
      {"id": "b3", "text": "been", "category": "aux"},
      {"id": "b4", "text": "working", "category": "main"},
      {"id": "b5", "text": "on", "category": "connector"},
      {"id": "b6", "text": "this project", "category": "object"},
      {"id": "b7", "text": "for", "category": "connector"},
      {"id": "b8", "text": "three months", "category": "time"}
    ],
    "distractorBlocks": [
      {"id": "d1", "text": "is", "category": "aux"},
      {"id": "d2", "text": "worked", "category": "main"},
      {"id": "d3", "text": "since", "category": "connector"}
    ],
    "hints": [
      "Start with the subject.",
      "Present perfect continuous uses 'have been'.",
      "The time expression comes at the end."
    ]
  }
}
```

#### AI-Assisted Mode

```
+----------------------------------------------------------+
| AI Game Generator                                         |
+----------------------------------------------------------+
| What would you like to create?                            |
| +--------------------------------------------------------+
| | Create a sentence builder game about present perfect   |
| | continuous tense for B1 level students. Include        |
| | sentences about work and projects.                     |
| +--------------------------------------------------------+
|                                                           |
| [Generate Game]                                           |
|                                                           |
| Generated Preview:                                        |
| +--------------------------------------------------------+
| | Title: Present Perfect Continuous Practice             |
| | Level: B1                                              |
| | 5 sentences generated                                  |
| |                                                        |
| | 1. "We have been working on this project..."           |
| | 2. "She has been studying English for..."              |
| | ...                                                    |
| +--------------------------------------------------------+
|                                                           |
| [Regenerate] [Edit in Template Mode] [Accept & Save]      |
+----------------------------------------------------------+
```

### 6.3 Game Preview Mode

Admins can preview games before publishing:
- Full game UI rendered
- Scaffolding actions can be manually triggered
- No analytics recorded
- "Exit Preview" button always visible

---

## 7. Student Interface

### 7.1 Game Player Layout (Split Screen)

```
+------------------------------------------------------------------+
|  Lesson: Business English 101              [Pause] [Exit Lesson] |
+------------------------------------------------------------------+
|                              |                                    |
|    +------------------+      |      +------------------------+    |
|    |                  |      |      |                        |    |
|    |   AVATAR VIDEO   |      |      |      GAME AREA         |    |
|    |                  |      |      |                        |    |
|    |    (Emma)        |      |      |   [Game UI renders     |    |
|    |                  |      |      |    here based on       |    |
|    +------------------+      |      |    game type]          |    |
|                              |      |                        |    |
|    Progress: ** (2/3 stars)  |      |                        |    |
|    Time: 2:34                |      |                        |    |
|                              |      +------------------------+    |
|    [Request Hint]            |                                    |
|                              |      [Check Answer] [Skip]         |
+------------------------------------------------------------------+
|  Transcript: "That's right! Now try the next one..."             |
+------------------------------------------------------------------+
```

### 7.2 Game Type UIs

#### Sentence Builder UI

```
+--------------------------------------------------+
| Build the sentence:                              |
|                                                  |
| PALETTE                                          |
| +----------------------------------------------+ |
| | Subjects: [I] [You] [We] [They]              | |
| | Verbs: [have] [has] [been] [working]         | |
| | Objects: [the project] [this report]         | |
| | Time: [for three months] [since Monday]      | |
| +----------------------------------------------+ |
|                                                  |
| WORKSPACE (drop here)                            |
| +----------------------------------------------+ |
| | [We] [have] [been] [working] [___] [___]     | |
| +----------------------------------------------+ |
|                                                  |
| [Check Answer]                                   |
+--------------------------------------------------+
```

#### Fill in the Blank UI

```
+--------------------------------------------------+
| Complete the sentence:                           |
|                                                  |
| "She ___ working here for five years."           |
|                                                  |
| +--------+  +--------+  +--------+  +--------+   |
| |  has   |  |  have  |  |   is   |  |  been  |   |
| +--------+  +--------+  +--------+  +--------+   |
|                                                  |
| Progress: 3 of 5                                 |
+--------------------------------------------------+
```

#### Matching Pairs UI

```
+--------------------------------------------------+
| Match the words with their definitions:          |
|                                                  |
|     WORDS              DEFINITIONS               |
| +-----------+      +------------------------+    |
| | purchase  |------| to buy something       |    |
| +-----------+      +------------------------+    |
| | deadline  |      | final date/time        |    |
| +-----------+      +------------------------+    |
| | negotiate |      | to discuss and agree   |    |
| +-----------+      +------------------------+    |
| | revenue   |      | money earned           |    |
| +-----------+      +------------------------+    |
|                                                  |
| Matched: 1 of 4                                  |
+--------------------------------------------------+
```

### 7.3 Visual Feedback Animations

| Event | Animation | Duration |
|-------|-----------|----------|
| Correct answer | Green pulse + checkmark fade-in | 500ms |
| Incorrect answer | Red flash + horizontal shake | 300ms |
| Hint highlight | Yellow pulse glow | 1000ms loop |
| Block placed | Subtle bounce | 200ms |
| Game complete | Confetti burst + star reveal | 1500ms |
| Star earned | Star scales up with sparkle | 400ms |

### 7.4 Keyboard Navigation

| Key | Action |
|-----|--------|
| Tab | Move focus between interactive elements |
| Enter/Space | Select focused element |
| Arrow keys | Navigate options/blocks |
| H | Request hint (if available) |
| Escape | Pause game / open menu |

---

## 8. Lesson Integration

### 8.1 Game-Lesson Linking Model

Games exist as standalone entities but can be linked to lessons:

```typescript
interface GameLessonLink {
  gameId: Id<"wordGames">;
  lessonId: Id<"structuredLessons">;
  triggerType: "slide" | "avatar" | "student" | "checkpoint";
  triggerConfig: {
    slideIndex?: number;          // For slide-triggered
    afterMinutes?: number;        // For checkpoint
    keywords?: string[];          // For avatar/student triggered
  };
  isRequired: boolean;            // Must complete to proceed?
  order: number;                  // Order within lesson's games
}
```

### 8.2 Trigger Mechanisms

#### Slide-Triggered
- Admin links game to specific slide index
- When avatar reaches that slide, game UI appears
- Avatar introduces: "Let's practice what we just learned!"

#### Avatar-Initiated
- Avatar detects teaching moment (keyword in conversation)
- Avatar offers: "Would you like to try a quick exercise?"
- Student confirms, game appears

#### Student-Requested
- Student clicks "Practice" button or asks verbally
- System shows available games for current lesson
- Student selects, game begins

#### Checkpoint
- After N minutes of lesson time, prompt for game
- "We've been talking for a while. Ready for some practice?"

### 8.3 Session Flow with Games

```
1. Lesson Start
   └─> Avatar greets student
   └─> Slide 1 displays

2. Teaching Phase
   └─> Avatar teaches from slides
   └─> Student asks questions

3. Game Trigger (any mechanism)
   └─> UI transitions to split-screen
   └─> Game loads in game area
   └─> Avatar provides instructions

4. Game Play
   └─> Student interacts with game
   └─> Avatar provides scaffolding
   └─> Real-time feedback

5. Game Completion
   └─> Stars awarded
   └─> Avatar congratulates
   └─> Progress saved

6. Return to Lesson
   └─> UI returns to lesson view
   └─> Avatar continues from context
   └─> "Great practice! Now let's continue..."
```

---

## 9. Database Schema

### 9.1 Convex Schema Additions

```typescript
// Add to convex/schema.ts

// Word Games table
wordGames: defineTable({
  // Identity
  gameId: v.string(),                    // Unique game identifier
  title: v.string(),
  slug: v.string(),                      // URL-friendly identifier
  description: v.optional(v.string()),
  instructions: v.string(),              // Shown to student

  // Classification
  type: v.union(
    v.literal("sentence_builder"),
    v.literal("fill_in_blank"),
    v.literal("word_ordering"),
    v.literal("matching_pairs"),
    v.literal("word_scramble"),
    v.literal("multiple_choice"),
    v.literal("flashcards"),
    v.literal("hangman")
  ),
  category: v.union(
    v.literal("grammar"),
    v.literal("vocabulary"),
    v.literal("mixed")
  ),
  level: v.union(
    v.literal("A1"),
    v.literal("A2"),
    v.literal("B1"),
    v.literal("B2"),
    v.literal("C1"),
    v.literal("C2")
  ),
  tags: v.optional(v.array(v.string())),

  // Game Configuration (type-specific JSON)
  config: v.any(),                       // GameConfig union type

  // Difficulty Settings
  difficultyConfig: v.object({
    hintsAvailable: v.number(),
    distractorDifficulty: v.union(
      v.literal("easy"),
      v.literal("medium"),
      v.literal("hard")
    ),
    timeMultiplier: v.optional(v.number()),
  }),

  // Hints (generic across all types)
  hints: v.array(v.string()),

  // Status
  status: v.union(
    v.literal("draft"),
    v.literal("published"),
    v.literal("archived")
  ),

  // Metadata
  createdBy: v.id("users"),
  createdAt: v.number(),
  updatedAt: v.number(),

  // Analytics aggregates (updated periodically)
  stats: v.optional(v.object({
    totalPlays: v.number(),
    completionRate: v.number(),
    averageStars: v.number(),
    averageTimeSeconds: v.number(),
  })),
})
  .index("by_slug", ["slug"])
  .index("by_type", ["type"])
  .index("by_level", ["level"])
  .index("by_status", ["status"])
  .index("by_category", ["category"])
  .index("by_created", ["createdAt"]),

// Game-Lesson Links
gameLessonLinks: defineTable({
  gameId: v.id("wordGames"),
  lessonId: v.id("structuredLessons"),
  triggerType: v.union(
    v.literal("slide"),
    v.literal("avatar"),
    v.literal("student"),
    v.literal("checkpoint")
  ),
  triggerConfig: v.object({
    slideIndex: v.optional(v.number()),
    afterMinutes: v.optional(v.number()),
    keywords: v.optional(v.array(v.string())),
  }),
  isRequired: v.boolean(),
  order: v.number(),
  createdAt: v.number(),
})
  .index("by_game", ["gameId"])
  .index("by_lesson", ["lessonId"])
  .index("by_lesson_order", ["lessonId", "order"]),

// Game Sessions (individual play instances)
gameSessions: defineTable({
  // References
  gameId: v.id("wordGames"),
  sessionId: v.optional(v.id("sessions")),   // Lesson session if applicable
  studentId: v.id("students"),

  // State
  status: v.union(
    v.literal("in_progress"),
    v.literal("completed"),
    v.literal("abandoned")
  ),

  // Game State (for resume capability)
  gameState: v.any(),                        // Current game state JSON

  // Progress
  currentItemIndex: v.number(),              // For multi-item games
  totalItems: v.number(),
  correctAnswers: v.number(),
  incorrectAnswers: v.number(),
  hintsUsed: v.number(),

  // Scoring
  stars: v.optional(v.number()),             // 0-3, set on completion
  scorePercent: v.optional(v.number()),      // 0-100

  // Timing
  startedAt: v.number(),
  completedAt: v.optional(v.number()),
  totalTimeSeconds: v.optional(v.number()),

  // Detailed Event Log (for analytics)
  events: v.array(v.object({
    type: v.string(),                        // "answer", "hint", "scaffold"
    timestamp: v.number(),
    data: v.any(),
  })),

  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_game", ["gameId"])
  .index("by_student", ["studentId"])
  .index("by_session", ["sessionId"])
  .index("by_status", ["status"])
  .index("by_student_game", ["studentId", "gameId"])
  .index("by_started", ["startedAt"]),

// Game Analytics Aggregates (for dashboard)
gameAnalytics: defineTable({
  // Scope
  gameId: v.optional(v.id("wordGames")),     // null = global
  studentId: v.optional(v.id("students")),   // null = all students
  period: v.union(
    v.literal("all_time"),
    v.literal("monthly"),
    v.literal("weekly"),
    v.literal("daily")
  ),
  periodStart: v.optional(v.number()),       // For non-all_time periods

  // Metrics
  totalSessions: v.number(),
  completedSessions: v.number(),
  abandonedSessions: v.number(),
  totalStars: v.number(),
  averageStars: v.number(),
  averageTimeSeconds: v.number(),
  totalHintsUsed: v.number(),
  averageHintsPerGame: v.number(),

  // Per-type breakdown (if gameId is null)
  byType: v.optional(v.object({
    sentence_builder: v.optional(v.number()),
    fill_in_blank: v.optional(v.number()),
    word_ordering: v.optional(v.number()),
    matching_pairs: v.optional(v.number()),
    word_scramble: v.optional(v.number()),
    multiple_choice: v.optional(v.number()),
    flashcards: v.optional(v.number()),
    hangman: v.optional(v.number()),
  })),

  // Per-level breakdown
  byLevel: v.optional(v.object({
    A1: v.optional(v.number()),
    A2: v.optional(v.number()),
    B1: v.optional(v.number()),
    B2: v.optional(v.number()),
    C1: v.optional(v.number()),
    C2: v.optional(v.number()),
  })),

  updatedAt: v.number(),
})
  .index("by_game", ["gameId"])
  .index("by_student", ["studentId"])
  .index("by_period", ["period", "periodStart"]),
```

### 9.2 Type Definitions

```typescript
// types/word-games.ts

export type GameType =
  | "sentence_builder"
  | "fill_in_blank"
  | "word_ordering"
  | "matching_pairs"
  | "word_scramble"
  | "multiple_choice"
  | "flashcards"
  | "hangman";

export type CEFRLevel = "A1" | "A2" | "B1" | "B2" | "C1" | "C2";

export type BlockCategory =
  | "subject"
  | "aux"
  | "modal"
  | "main"
  | "negation"
  | "object"
  | "time"
  | "connector";

export interface Block {
  id: string;
  text: string;
  category: BlockCategory;
}

// Union type for all game configs
export type GameConfig =
  | SentenceBuilderConfig
  | FillInBlankConfig
  | WordOrderingConfig
  | MatchingPairsConfig
  | WordScrambleConfig
  | MultipleChoiceConfig
  | FlashcardsConfig
  | HangmanConfig;

// Each config interface defined in Section 3
```

---

## 10. API & Event Contracts

### 10.1 Convex Functions

#### Queries

```typescript
// convex/wordGames.ts

// Get all games (with filters)
export const listGames = query({
  args: {
    type: v.optional(v.string()),
    level: v.optional(v.string()),
    status: v.optional(v.string()),
    lessonId: v.optional(v.id("structuredLessons")),
  },
  handler: async (ctx, args) => { ... }
});

// Get single game by ID
export const getGame = query({
  args: { gameId: v.id("wordGames") },
  handler: async (ctx, args) => { ... }
});

// Get games linked to a lesson
export const getGamesForLesson = query({
  args: { lessonId: v.id("structuredLessons") },
  handler: async (ctx, args) => { ... }
});

// Get active game session for student
export const getActiveGameSession = query({
  args: {
    studentId: v.id("students"),
    gameId: v.optional(v.id("wordGames")),
  },
  handler: async (ctx, args) => { ... }
});

// Get student's game history
export const getStudentGameHistory = query({
  args: {
    studentId: v.id("students"),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, args) => { ... }
});

// Get analytics for dashboard
export const getGameAnalytics = query({
  args: {
    gameId: v.optional(v.id("wordGames")),
    studentId: v.optional(v.id("students")),
    period: v.optional(v.string()),
  },
  handler: async (ctx, args) => { ... }
});
```

#### Mutations

```typescript
// convex/wordGames.ts

// Create new game
export const createGame = mutation({
  args: {
    title: v.string(),
    type: v.string(),
    level: v.string(),
    instructions: v.string(),
    config: v.any(),
    hints: v.array(v.string()),
    tags: v.optional(v.array(v.string())),
    difficultyConfig: v.object({ ... }),
    status: v.optional(v.string()),
  },
  handler: async (ctx, args) => { ... }
});

// Update game
export const updateGame = mutation({
  args: {
    gameId: v.id("wordGames"),
    updates: v.any(),
  },
  handler: async (ctx, args) => { ... }
});

// Delete game
export const deleteGame = mutation({
  args: { gameId: v.id("wordGames") },
  handler: async (ctx, args) => { ... }
});

// Link game to lesson
export const linkGameToLesson = mutation({
  args: {
    gameId: v.id("wordGames"),
    lessonId: v.id("structuredLessons"),
    triggerType: v.string(),
    triggerConfig: v.object({ ... }),
    isRequired: v.boolean(),
  },
  handler: async (ctx, args) => { ... }
});

// Start game session
export const startGameSession = mutation({
  args: {
    gameId: v.id("wordGames"),
    studentId: v.id("students"),
    sessionId: v.optional(v.id("sessions")),
  },
  handler: async (ctx, args) => { ... }
});

// Update game session state
export const updateGameSession = mutation({
  args: {
    gameSessionId: v.id("gameSessions"),
    gameState: v.any(),
    event: v.optional(v.object({
      type: v.string(),
      data: v.any(),
    })),
  },
  handler: async (ctx, args) => { ... }
});

// Complete game session
export const completeGameSession = mutation({
  args: {
    gameSessionId: v.id("gameSessions"),
    stars: v.number(),
    scorePercent: v.number(),
    finalState: v.any(),
  },
  handler: async (ctx, args) => { ... }
});

// Abandon game session
export const abandonGameSession = mutation({
  args: {
    gameSessionId: v.id("gameSessions"),
  },
  handler: async (ctx, args) => { ... }
});
```

### 10.2 LiveKit Data Channel Events

Events sent between frontend and Python agent via LiveKit data channel:

#### Frontend to Agent

```typescript
// Game lifecycle
interface GameStartedEvent {
  type: "game_started";
  gameId: string;
  gameSessionId: string;
  gameType: GameType;
  studentLevel: CEFRLevel;
}

interface GameActionEvent {
  type: "game_action";
  gameSessionId: string;
  action: "answer" | "skip" | "hint_request";
  data: {
    itemId?: string;
    answer?: any;
    isCorrect?: boolean;
  };
}

interface GameCompletedEvent {
  type: "game_completed";
  gameSessionId: string;
  stars: number;
  scorePercent: number;
  timeSeconds: number;
}

interface GameAbandonedEvent {
  type: "game_abandoned";
  gameSessionId: string;
  progress: number;  // 0-100
}
```

#### Agent to Frontend

```typescript
// Scaffolding actions
interface ScaffoldingEvent {
  type: "scaffolding_action";
  action: ScaffoldingActionId;
  targetElementId?: string;
  message?: string;
  duration?: number;  // Animation duration ms
}

// Avatar speech triggers
interface AvatarSpeechEvent {
  type: "avatar_speech";
  category: "instruction" | "feedback" | "hint" | "encouragement";
  text: string;
}

// Game state sync (for recovery)
interface GameStateSyncEvent {
  type: "game_state_sync";
  gameSessionId: string;
  gameState: any;
}
```

### 10.3 Python Agent Integration

```python
# apps/agent/src/games/game_handler.py

class GameHandler:
    """Handles word game integration in the Python agent."""

    def __init__(self, room: rtc.Room, convex_client: ConvexClient):
        self.room = room
        self.convex = convex_client
        self.active_game: Optional[GameSession] = None

        # Listen for game events
        self.room.on("data_received", self._on_data_received)

    async def _on_data_received(self, dp: rtc.DataPacket):
        """Process incoming game events from frontend."""
        try:
            payload = json.loads(dp.data.decode('utf-8'))
            event_type = payload.get("type")

            if event_type == "game_started":
                await self._handle_game_started(payload)
            elif event_type == "game_action":
                await self._handle_game_action(payload)
            elif event_type == "game_completed":
                await self._handle_game_completed(payload)
            elif event_type == "game_abandoned":
                await self._handle_game_abandoned(payload)
        except Exception as e:
            logger.error(f"Game event error: {e}")

    async def _handle_game_started(self, event: dict):
        """Initialize game session and greet student."""
        self.active_game = GameSession(
            game_id=event["gameId"],
            session_id=event["gameSessionId"],
            game_type=event["gameType"],
        )

        # Speak introduction
        intro = self._get_game_intro(event["gameType"])
        await self.say(intro)

    async def _handle_game_action(self, event: dict):
        """Respond to student action with scaffolding."""
        action = event.get("action")
        data = event.get("data", {})

        if action == "answer":
            if data.get("isCorrect"):
                await self._give_positive_feedback()
            else:
                await self._give_corrective_feedback(data)

        elif action == "hint_request":
            await self._provide_hint()

        # Check if scaffolding needed
        await self._check_scaffolding_triggers()

    async def _provide_scaffolding(self, action: str, target_id: str = None):
        """Send scaffolding event to frontend."""
        event = {
            "type": "scaffolding_action",
            "action": action,
            "targetElementId": target_id,
        }
        await self._send_event(event)

    async def _send_event(self, event: dict):
        """Send event via LiveKit data channel."""
        data = json.dumps(event).encode('utf-8')
        await self.room.local_participant.publish_data(data, reliable=True)
```

---

## 11. State Machines

### 11.1 Game Session State Machine

```
                    ┌─────────────┐
                    │   IDLE      │
                    └──────┬──────┘
                           │ start_game
                           ▼
                    ┌─────────────┐
         ┌─────────►│ IN_PROGRESS │◄────────┐
         │          └──────┬──────┘         │
         │                 │                │
         │    ┌────────────┼────────────┐   │
         │    │            │            │   │
         │    ▼            ▼            ▼   │
         │ answer      hint_used    timeout │
         │    │            │            │   │
         │    └────────────┴────────────┘   │
         │                 │                │
         │                 │ continue       │
         └─────────────────┘                │
                           │                │
              ┌────────────┼────────────┐   │
              │            │            │   │
              ▼            ▼            ▼   │
        ┌──────────┐ ┌──────────┐ ┌────────┴──┐
        │COMPLETED │ │ABANDONED │ │  PAUSED   │
        └──────────┘ └──────────┘ └───────────┘
```

### 11.2 Game Item State Machine (per question/item)

```
        ┌──────────┐
        │ PENDING  │
        └────┬─────┘
             │ display
             ▼
        ┌──────────┐
        │ ACTIVE   │◄──────────────┐
        └────┬─────┘               │
             │                     │
    ┌────────┼────────┐           │
    │        │        │           │
    ▼        ▼        ▼           │
 answer   hint    timeout         │
    │        │        │           │
    ▼        ▼        │           │
┌───────┐ ┌───────┐   │           │
│CORRECT│ │HINTED │───┘           │
└───────┘ └───┬───┘               │
              │ answer            │
              ▼                   │
         ┌─────────┐              │
         │ CORRECT │              │
         │   or    │              │
         │INCORRECT│──────────────┘
         └─────────┘   retry (if allowed)
```

### 11.3 Scaffolding Decision Tree

```
Student makes move
        │
        ▼
   Is answer correct?
   /            \
  YES            NO
   │              │
   ▼              ▼
Give praise   Consecutive errors >= 2?
   │          /            \
   │        YES             NO
   │         │               │
   │         ▼               ▼
   │   Provide hint      Gentle correction
   │         │               │
   ▼         ▼               ▼
Check progress ◄─────────────┘
        │
        ▼
  Progress >= 50%?
  /            \
YES             NO
 │               │
 ▼               │
Milestone        │
feedback         │
 │               │
 ▼               ▼
Continue ◄───────┘
```

---

## 12. Analytics Specification

### 12.1 Events to Track

| Event | Data Captured | Purpose |
|-------|---------------|---------|
| `game_session_started` | gameId, studentId, level, timestamp | Track engagement |
| `game_item_answered` | itemId, answer, isCorrect, timeMs | Accuracy analysis |
| `hint_requested` | hintIndex, itemId, timestamp | Hint effectiveness |
| `scaffolding_provided` | action, itemId, timestamp | Avatar intervention |
| `game_session_completed` | stars, scorePercent, totalTime, hintsUsed | Outcomes |
| `game_session_abandoned` | progress, reason, timestamp | Drop-off analysis |

### 12.2 Aggregate Metrics

#### Per-Game Metrics
- Total plays
- Completion rate (completed / started)
- Average stars
- Average time to complete
- Hint usage rate
- Most missed items

#### Per-Student Metrics
- Games played (by type, by level)
- Average performance trend
- Improvement over time
- Problem areas (low scores by category)
- Favorite game types

#### Global Metrics
- Popular games
- Difficulty calibration (are levels appropriate?)
- Engagement trends over time
- Scaffolding effectiveness

### 12.3 Teacher Dashboard Views

```
+----------------------------------------------------------+
| Game Analytics Dashboard                                  |
+----------------------------------------------------------+
|                                                           |
| Overview (Last 30 Days)                                   |
| +---------------+ +---------------+ +---------------+     |
| | Total Plays   | | Completion    | | Avg Stars     |     |
| |    1,234      | |    78%        | |    2.3        |     |
| +---------------+ +---------------+ +---------------+     |
|                                                           |
| Performance by Game Type                                  |
| +-----------------------------------------------------+   |
| | Sentence Builder  ████████████░░ 78%  ★★☆  2.1     |   |
| | Fill in Blank     ██████████████ 92%  ★★★  2.8     |   |
| | Matching Pairs    ███████████░░░ 71%  ★★☆  2.0     |   |
| | ...                                                 |   |
| +-----------------------------------------------------+   |
|                                                           |
| Students Needing Attention                                |
| +-----------------------------------------------------+   |
| | Maria S. - 45% completion, declining scores         |   |
| | Thomas K. - High hint usage (4.2 avg per game)      |   |
| +-----------------------------------------------------+   |
|                                                           |
+----------------------------------------------------------+
```

---

## 13. Error Handling

### 13.1 Error Scenarios & Responses

| Scenario | Detection | User Experience | Technical Response |
|----------|-----------|-----------------|-------------------|
| Network disconnect mid-game | WebSocket close | "Connection lost. Reconnecting..." | Auto-save state, attempt reconnect |
| Convex mutation fails | Error response | "Couldn't save progress. Retrying..." | Retry with exponential backoff |
| LiveKit data channel fails | Timeout on ack | Avatar continues verbally | Fall back to Convex-only sync |
| Browser tab closed | `beforeunload` event | N/A | Save current state immediately |
| Session timeout | Server-side timeout | "Session expired" on return | Restore from last saved state |
| Invalid game config | Validation error | "This game has an error" | Log for admin, skip game |
| Avatar disconnected | LiveKit participant left | Game continues without voice | Visual-only feedback mode |

### 13.2 Recovery Procedures

#### Session Recovery Flow
```
1. Student returns to platform
2. Check for active gameSession with status="in_progress"
3. If found:
   a. Show "Continue game?" dialog
   b. If yes: Load gameState, resume at currentItemIndex
   c. If no: Mark session as abandoned
4. If not found: Normal flow
```

#### State Reconciliation
```
1. On reconnect, fetch gameSession from Convex
2. Compare with local state (if any)
3. Use server state as source of truth
4. Replay any unacknowledged local events
5. Sync UI to recovered state
```

### 13.3 Validation Rules

```typescript
// Game config validation
const validateGameConfig = (config: GameConfig): ValidationResult => {
  const errors: string[] = [];

  // Type-specific validation
  switch (config.type) {
    case "sentence_builder":
      if (!config.targetSentence) {
        errors.push("Target sentence is required");
      }
      if (config.availableBlocks.length < 3) {
        errors.push("At least 3 blocks required");
      }
      break;

    case "fill_in_blank":
      if (config.items.length === 0) {
        errors.push("At least 1 item required");
      }
      for (const item of config.items) {
        if (!item.options.includes(item.correctAnswer)) {
          errors.push(`Correct answer not in options for: ${item.id}`);
        }
      }
      break;

    // ... other types
  }

  return { valid: errors.length === 0, errors };
};
```

---

## 14. Technical Constraints

### 14.1 Performance Requirements

| Metric | Target | Rationale |
|--------|--------|-----------|
| Game load time | < 500ms | Instant feel after trigger |
| Answer feedback | < 100ms | Immediate response |
| Scaffolding event delivery | < 200ms | Avatar feels responsive |
| State sync to Convex | < 1s | Reliable persistence |
| UI animation frame rate | 60fps | Smooth drag-and-drop |

### 14.2 Browser Support

- **Supported:** Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **Not supported:** IE11, older mobile browsers
- **Desktop-only initially:** Mobile deferred

### 14.3 Accessibility Requirements (Basic)

- All interactive elements keyboard-accessible
- Focus indicators visible
- Color contrast ratio >= 4.5:1
- Screen reader labels for game elements
- No seizure-inducing animations

### 14.4 Data Constraints

- Max 50 items per game (performance)
- Max 500KB game config JSON
- Max 100 events per game session
- Game sessions auto-expire after 24 hours of inactivity

---

## 15. Implementation Phases

### Phase 1: Foundation (Weeks 1-2)
**Goal:** Core infrastructure and one game type

- [ ] Convex schema additions (tables, indexes)
- [ ] Basic game CRUD mutations/queries
- [ ] Game session state management
- [ ] Sentence Builder game type (leverage existing verb-chains code)
- [ ] Basic admin UI for creating Sentence Builder games
- [ ] Student game player component (split-screen layout)
- [ ] Simple visual feedback (colors only)

**Deliverables:**
- Admins can create Sentence Builder games
- Students can play games standalone
- Progress saved to Convex

### Phase 2: Avatar Integration (Weeks 3-4)
**Goal:** Real-time scaffolding with AI avatar

- [ ] LiveKit data channel event system
- [ ] Python agent GameHandler class
- [ ] Scaffolding action catalog implementation
- [ ] Continuous commentary system
- [ ] Hint request/delivery flow
- [ ] Star rating calculation and display

**Deliverables:**
- Avatar provides real-time verbal feedback
- Scaffolding actions sync to frontend
- Games award stars on completion

### Phase 3: Game Type Expansion (Weeks 5-7)
**Goal:** Implement remaining 7 game types

- [ ] Fill in the Blank
- [ ] Word Ordering
- [ ] Matching Pairs
- [ ] Word Scramble
- [ ] Multiple Choice
- [ ] Flashcards
- [ ] Hangman
- [ ] Admin UI templates for each type

**Deliverables:**
- All 8 game types playable
- Admin can create any game type

### Phase 4: Lesson Integration (Weeks 8-9)
**Goal:** Games within lesson flow

- [ ] Game-Lesson linking in admin UI
- [ ] Trigger mechanism implementation (slide, avatar, student, checkpoint)
- [ ] Lesson UI transitions (enter/exit game mode)
- [ ] Avatar conversation context preservation
- [ ] Required game progression gates

**Deliverables:**
- Games can be embedded in lessons
- Smooth transitions between lesson and game modes

### Phase 5: Analytics & Polish (Weeks 10-11)
**Goal:** Comprehensive analytics and UX refinement

- [ ] Analytics event tracking
- [ ] Teacher dashboard views
- [ ] Student progress views
- [ ] Animated feedback system
- [ ] Keyboard navigation
- [ ] Performance optimization
- [ ] Error handling refinement

**Deliverables:**
- Full analytics dashboard
- Polished UX with animations
- Production-ready error handling

### Phase 6: AI-Assisted Creation (Week 12)
**Goal:** AI game generation for admins

- [ ] AI game generator prompts
- [ ] Integration with avatar LLM
- [ ] Preview and edit workflow
- [ ] Content validation

**Deliverables:**
- Admins can generate games via AI
- Generated games editable before publishing

---

## 16. Decisions Log

| # | Decision | Options Considered | Choice | Rationale |
|---|----------|-------------------|--------|-----------|
| 1 | Game types | 1 type vs 3 types vs 8 types | 8 types (comprehensive) | Cover vocabulary, grammar, and mixed learning needs |
| 2 | Avatar interaction | Observer vs Full control vs Scaffolding | Guided scaffolding | Balance autonomy with support |
| 3 | Multiplayer | Single vs Collaborative vs Competitive | Single-player | Simplicity, focus on AI interaction |
| 4 | Validation | Strict vs Fuzzy vs AI-evaluated | Strict matching | Clear feedback, predictable behavior |
| 5 | Bilingual | Full support vs English-only | English-only initially | Reduce complexity, add later |
| 6 | Difficulty levels | Simple 3-tier vs CEFR vs Dynamic | CEFR-aligned (A1-C2) | Matches existing student level system |
| 7 | Progression | Manual vs Mastery-based vs Adaptive | Hybrid | Start from profile, adapt in-session |
| 8 | Content source | Pre-built vs Admin-created vs AI-generated | Admin-created | Control over quality and relevance |
| 9 | Game-lesson relationship | Standalone vs Embedded vs Linked | Linked but separate | Flexibility in use |
| 10 | Admin builder | Template vs Visual vs JSON | Combination | Quick creation + power user options |
| 11 | State sync | Convex-only vs LiveKit-only vs Hybrid | Hybrid | Persistent + real-time |
| 12 | Scoring | Pass/fail vs Percentage vs Stars | Star rating (1-3) | Simple, motivating, consistent |
| 13 | Hint penalty | Penalty vs No penalty | No penalty | Encourage hint usage for learning |
| 14 | Time limits | Enforced vs Optional vs Soft tracking | Soft tracking | Analytics without pressure |
| 15 | Avatar commentary | On-demand vs Continuous | Continuous | Engaging, supportive experience |
| 16 | Visual feedback | Simple vs Animated | Animated + verbal | Rich feedback loop |
| 17 | Mobile support | Full vs Desktop-first vs Desktop-only | Desktop-only initially | Focus resources, add mobile later |
| 18 | Lesson UI | Modal vs Split vs Takeover | Split screen | Avatar visible during games |
| 19 | Session interruption | Restart vs Auto-save | Auto-save | Preserve student effort |
| 20 | Analytics depth | Basic vs Detailed vs Comprehensive | Comprehensive | Support teacher insights |

---

## 17. Out of Scope

The following are explicitly **not included** in this specification:

1. **Mobile/touch optimization** - Deferred to future phase
2. **Bilingual game content** - English-only initially
3. **Multiplayer/collaborative modes** - Single-player focus
4. **AI-evaluated (fuzzy) answers** - Strict matching only
5. **Custom game type creation** - Fixed 8 types
6. **Integration with external game platforms**
7. **Gamification elements** (badges, leaderboards, XP leveling) beyond star ratings
8. **Offline play support**
9. **Game content import/export**
10. **A/B testing framework for games**
11. **Voice-based game interaction** (speaking answers)
12. **Game sharing between teachers**

---

## 18. Open Questions

| # | Question | Impact | Proposed Resolution |
|---|----------|--------|---------------------|
| 1 | Should games have a "practice mode" with unlimited hints and no scoring? | UX | Add as future enhancement |
| 2 | How to handle tie-breaking when blocks have same text but different categories? | Technical | Use block ID, not text, for matching |
| 3 | Should completed games be replayable for review? | Feature | Yes, allow replay with "previously completed" indicator |
| 4 | What happens if admin deletes a game that's linked to lessons? | Data integrity | Soft delete, keep history, unlink from lessons |
| 5 | Should students see their rank compared to others on a game? | UX/Privacy | Not initially (no leaderboards) |

---

## Appendix A: Block Category Color Reference

```css
.subject   { background: #e0f2ff; } /* Light blue */
.aux       { background: #e0f7ec; } /* Light green */
.modal     { background: #fff3d9; } /* Pale yellow */
.main      { background: #ffe8e0; } /* Peach */
.negation  { background: #ffd6de; } /* Pink */
.object    { background: #e9e0ff; } /* Purple */
.time      { background: #e5f2e0; } /* Soft green */
.connector { background: #f0f0f0; } /* Gray */
```

---

## Appendix B: Example Game Configurations

### B.1 Sentence Builder Example

```json
{
  "type": "sentence_builder",
  "title": "Present Perfect Practice",
  "instructions": "Arrange the blocks to form a grammatically correct sentence.",
  "level": "B1",
  "config": {
    "targetSentence": "I have been learning English for three years",
    "availableBlocks": [
      {"id": "s1", "text": "I", "category": "subject"},
      {"id": "a1", "text": "have", "category": "aux"},
      {"id": "a2", "text": "been", "category": "aux"},
      {"id": "m1", "text": "learning", "category": "main"},
      {"id": "o1", "text": "English", "category": "object"},
      {"id": "c1", "text": "for", "category": "connector"},
      {"id": "t1", "text": "three years", "category": "time"}
    ],
    "distractorBlocks": [
      {"id": "d1", "text": "am", "category": "aux"},
      {"id": "d2", "text": "since", "category": "connector"}
    ],
    "hints": [
      "Start with the subject 'I'",
      "Present perfect continuous uses 'have been'",
      "'For' is used with durations of time"
    ]
  },
  "difficultyConfig": {
    "hintsAvailable": 3,
    "distractorDifficulty": "medium"
  }
}
```

### B.2 Matching Pairs Example

```json
{
  "type": "matching_pairs",
  "title": "Business Vocabulary",
  "instructions": "Match each word with its definition.",
  "level": "B2",
  "config": {
    "matchType": "definition",
    "pairs": [
      {
        "id": "p1",
        "left": {"text": "revenue"},
        "right": {"text": "income from business activities"}
      },
      {
        "id": "p2",
        "left": {"text": "deadline"},
        "right": {"text": "the latest time by which something must be completed"}
      },
      {
        "id": "p3",
        "left": {"text": "negotiate"},
        "right": {"text": "to discuss in order to reach an agreement"}
      },
      {
        "id": "p4",
        "left": {"text": "stakeholder"},
        "right": {"text": "a person with an interest in a company's success"}
      }
    ],
    "hints": [
      "Think about money-related terms",
      "Consider time-related concepts"
    ]
  },
  "difficultyConfig": {
    "hintsAvailable": 2,
    "distractorDifficulty": "hard"
  }
}
```

---

*End of Specification*

*Document Version: 1.0*
*Last Updated: 2026-01-02*
*Author: Deep Requirements Orchestrator*
